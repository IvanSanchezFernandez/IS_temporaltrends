
# ACTH in infantile spasms








## 1. Preparation of software for analysis




Install needed packages
```{r}
# install.packages("dplyr")
library(dplyr)

# install.packages("dbplyr")
library(dbplyr)

# install.packages("tidyr")
library(tidyr)

# install.packages("RSQLite")
library(RSQLite)

# install.packages("tibble")
library(tibble)

# install.packages("haven")
library(haven)

# install.packages("lubridate")
library(lubridate)

# install.packages("gmodels")
library(gmodels)

# install.packages("bazar")
library(bazar)

# install.packages("DescTools")
library(DescTools)

# install.packages("showtext")
library(showtext)
font_add(family="Calibri", regular="Calibri.ttf")
showtext_auto()

# install.packages("ggplot2")
library(ggplot2)
```








## 2. Data ingestion




Create the connection to the database
```{r}
# Create the connection to the MarketScan database
MarketScan <- DBI::dbConnect(RSQLite::SQLite(), "D:\\MarketScan\\MarketScan.db")
src_dbi(MarketScan)
```




Create the link to the relevant tables
```{r}
# Year 2006
ms_i_2006 <- tbl(MarketScan, "ms_i_2006")
ms_s_2006 <- tbl(MarketScan, "ms_s_2006")
ms_d_2006 <- tbl(MarketScan, "ms_d_2006")
ms_o_2006 <- tbl(MarketScan, "ms_o_2006")
ms_a_2006 <- tbl(MarketScan, "ms_a_2006")
ms_t_2006 <- tbl(MarketScan, "ms_t_2006")
redbook_2006 <- tbl(MarketScan, "redbook_2006")

# Year 2007
ms_i_2007 <- tbl(MarketScan, "ms_i_2007")
ms_s_2007 <- tbl(MarketScan, "ms_s_2007")
ms_d_2007 <- tbl(MarketScan, "ms_d_2007")
ms_o_2007 <- tbl(MarketScan, "ms_o_2007")
ms_a_2007 <- tbl(MarketScan, "ms_a_2007")
ms_t_2007 <- tbl(MarketScan, "ms_t_2007")
redbook_2007 <- tbl(MarketScan, "redbook_2007")

# Year 2008
ms_i_2008 <- tbl(MarketScan, "ms_i_2008")
ms_s_2008 <- tbl(MarketScan, "ms_s_2008")
ms_d_2008 <- tbl(MarketScan, "ms_d_2008")
ms_o_2008 <- tbl(MarketScan, "ms_o_2008")
ms_a_2008 <- tbl(MarketScan, "ms_a_2008")
ms_t_2008 <- tbl(MarketScan, "ms_t_2008")
redbook_2008 <- tbl(MarketScan, "redbook_2008")

# Year 2009
ms_i_2009 <- tbl(MarketScan, "ms_i_2009")
ms_s_2009 <- tbl(MarketScan, "ms_s_2009")
ms_d_2009 <- tbl(MarketScan, "ms_d_2009")
ms_o_2009 <- tbl(MarketScan, "ms_o_2009")
ms_a_2009 <- tbl(MarketScan, "ms_a_2009")
ms_t_2009 <- tbl(MarketScan, "ms_t_2009")
redbook_2009 <- tbl(MarketScan, "redbook_2009")

# Year 2010
ms_i_2010 <- tbl(MarketScan, "ms_i_2010")
ms_s_2010 <- tbl(MarketScan, "ms_s_2010")
ms_d_2010 <- tbl(MarketScan, "ms_d_2010")
ms_o_2010 <- tbl(MarketScan, "ms_o_2010")
ms_a_2010 <- tbl(MarketScan, "ms_a_2010")
ms_t_2010 <- tbl(MarketScan, "ms_t_2010")
redbook_2010 <- tbl(MarketScan, "redbook_2010")

# Year 2011
ms_i_2011 <- tbl(MarketScan, "ms_i_2011")
ms_s_2011 <- tbl(MarketScan, "ms_s_2011")
ms_d_2011 <- tbl(MarketScan, "ms_d_2011")
ms_o_2011 <- tbl(MarketScan, "ms_o_2011")
ms_a_2011 <- tbl(MarketScan, "ms_a_2011")
ms_t_2011 <- tbl(MarketScan, "ms_t_2011")
redbook_2011 <- tbl(MarketScan, "redbook_2011")

# Year 2012
ms_i_2012 <- tbl(MarketScan, "ms_i_2012")
ms_s_2012 <- tbl(MarketScan, "ms_s_2012")
ms_d_2012 <- tbl(MarketScan, "ms_d_2012")
ms_o_2012 <- tbl(MarketScan, "ms_o_2012")
ms_a_2012 <- tbl(MarketScan, "ms_a_2012")
ms_t_2012 <- tbl(MarketScan, "ms_t_2012")
redbook_2012 <- tbl(MarketScan, "redbook_2012")

# Year 2013
ms_i_2013 <- tbl(MarketScan, "ms_i_2013")
ms_s_2013 <- tbl(MarketScan, "ms_s_2013")
ms_d_2013 <- tbl(MarketScan, "ms_d_2013")
ms_o_2013 <- tbl(MarketScan, "ms_o_2013")
ms_a_2013 <- tbl(MarketScan, "ms_a_2013")
ms_t_2013 <- tbl(MarketScan, "ms_t_2013")
redbook_2013 <- tbl(MarketScan, "redbook_2013")

# Year 2014
ms_i_2014 <- tbl(MarketScan, "ms_i_2014")
ms_s_2014 <- tbl(MarketScan, "ms_s_2014")
ms_d_2014 <- tbl(MarketScan, "ms_d_2014")
ms_o_2014 <- tbl(MarketScan, "ms_o_2014")
ms_a_2014 <- tbl(MarketScan, "ms_a_2014")
ms_t_2014 <- tbl(MarketScan, "ms_t_2014")
redbook_2014 <- tbl(MarketScan, "redbook_2014")

# Year 2015
ms_i_2015 <- tbl(MarketScan, "ms_i_2015")
ms_s_2015 <- tbl(MarketScan, "ms_s_2015")
ms_d_2015 <- tbl(MarketScan, "ms_d_2015")
ms_o_2015 <- tbl(MarketScan, "ms_o_2015")
ms_a_2015 <- tbl(MarketScan, "ms_a_2015")
ms_t_2015 <- tbl(MarketScan, "ms_t_2015")
redbook_2015 <- tbl(MarketScan, "redbook_2015")

# Year 2016
ms_i_2016 <- tbl(MarketScan, "ms_i_2016")
ms_s_2016 <- tbl(MarketScan, "ms_s_2016")
ms_d_2016 <- tbl(MarketScan, "ms_d_2016")
ms_o_2016 <- tbl(MarketScan, "ms_o_2016")
ms_a_2016 <- tbl(MarketScan, "ms_a_2016")
ms_t_2016 <- tbl(MarketScan, "ms_t_2016")
redbook_2016 <- tbl(MarketScan, "redbook_2016")

# Year 2017
ms_i_2017 <- tbl(MarketScan, "ms_i_2017")
ms_s_2017 <- tbl(MarketScan, "ms_s_2017")
ms_d_2017 <- tbl(MarketScan, "ms_d_2017")
ms_o_2017 <- tbl(MarketScan, "ms_o_2017")
ms_a_2017 <- tbl(MarketScan, "ms_a_2017")
ms_t_2017 <- tbl(MarketScan, "ms_t_2017")
redbook_2017 <- tbl(MarketScan, "redbook_2017")

# Year 2018
ms_i_2018 <- tbl(MarketScan, "ms_i_2018")
ms_s_2018 <- tbl(MarketScan, "ms_s_2018")
ms_d_2018 <- tbl(MarketScan, "ms_d_2018")
ms_o_2018 <- tbl(MarketScan, "ms_o_2018")
ms_a_2018 <- tbl(MarketScan, "ms_a_2018")
ms_t_2018 <- tbl(MarketScan, "ms_t_2018")
redbook_2018 <- tbl(MarketScan, "redbook_2018")

# Year 2019
ms_i_2019 <- tbl(MarketScan, "ms_i_2019")
ms_s_2019 <- tbl(MarketScan, "ms_s_2019")
ms_d_2019 <- tbl(MarketScan, "ms_d_2019")
ms_o_2019 <- tbl(MarketScan, "ms_o_2019")
ms_a_2019 <- tbl(MarketScan, "ms_a_2019")
ms_t_2019 <- tbl(MarketScan, "ms_t_2019")
redbook_2019 <- tbl(MarketScan, "redbook_2019")

# Year 2020
ms_i_2020 <- tbl(MarketScan, "ms_i_2020")
ms_s_2020 <- tbl(MarketScan, "ms_s_2020")
ms_d_2020 <- tbl(MarketScan, "ms_d_2020")
ms_o_2020 <- tbl(MarketScan, "ms_o_2020")
ms_a_2020 <- tbl(MarketScan, "ms_a_2020")
ms_t_2020 <- tbl(MarketScan, "ms_t_2020")
redbook_2020 <- tbl(MarketScan, "redbook_2020")
```




Extract the redbook databases
```{r}
# Extract the information from the redbook data
redbook_2006_data <- redbook_2006 %>% collect()
redbook_2007_data <- redbook_2007 %>% collect()
redbook_2008_data <- redbook_2008 %>% collect()
redbook_2009_data <- redbook_2009 %>% collect()
redbook_2010_data <- redbook_2010 %>% collect()
redbook_2011_data <- redbook_2011 %>% collect()
redbook_2012_data <- redbook_2012 %>% collect()
redbook_2013_data <- redbook_2013 %>% collect()
redbook_2014_data <- redbook_2014 %>% collect()
redbook_2015_data <- redbook_2015 %>% collect()
redbook_2016_data <- redbook_2016 %>% collect()
redbook_2017_data <- redbook_2017 %>% collect()
redbook_2018_data <- redbook_2018 %>% collect()
redbook_2019_data <- redbook_2019 %>% collect()
redbook_2020_data <- redbook_2020 %>% collect()
```




Cost adjustment for inflation
```{r}
# Inflation calculations (https://apps.bea.gov/iTable/iTable.cfm?reqid=19&step=2#reqid=19&step=2&isuri=1&1921=survey last accessed 6/16/2022)
# https://meps.ahrq.gov/about_meps/Price_Index.shtml
inflation_2006_Q1 <- 0.89204
inflation_2006_Q2 <- 0.89993	
inflation_2006_Q3 <- 0.90652	
inflation_2006_Q4 <- 0.90997	
inflation_2007_Q1 <- 0.91908
inflation_2007_Q2 <- 0.92491	
inflation_2007_Q3 <- 0.92882	
inflation_2007_Q4 <- 0.93332	
inflation_2008_Q1 <- 0.93735
inflation_2008_Q2 <- 0.94075	
inflation_2008_Q3 <- 0.94804	
inflation_2008_Q4 <- 0.94975
inflation_2009_Q1 <- 0.95001
inflation_2009_Q2 <- 0.94870	
inflation_2009_Q3 <- 0.94928	
inflation_2009_Q4 <- 0.95277			
inflation_2010_Q1 <- 0.95518
inflation_2010_Q2 <- 0.95963	
inflation_2010_Q3 <- 0.96312	
inflation_2010_Q4 <- 0.96864				
inflation_2011_Q1 <- 0.97339
inflation_2011_Q2 <- 0.98042	
inflation_2011_Q3 <- 0.98561	
inflation_2011_Q4 <- 0.98687		
inflation_2012_Q1 <- 0.99277
inflation_2012_Q2 <- 0.99690	
inflation_2012_Q3 <- 1.00304
inflation_2012_Q4 <- 1.00730			
inflation_2013_Q1 <- 1.01124
inflation_2013_Q2 <- 1.01428	
inflation_2013_Q3 <- 1.01973
inflation_2013_Q4 <- 1.02550				
inflation_2014_Q1 <- 1.02965
inflation_2014_Q2 <- 1.03552	
inflation_2014_Q3 <- 1.04029
inflation_2014_Q4 <- 1.04104		
inflation_2015_Q1 <- 1.04092
inflation_2015_Q2 <- 1.04683	
inflation_2015_Q3 <- 1.04939
inflation_2015_Q4 <- 1.04932
inflation_2016_Q1 <- 1.04873
inflation_2016_Q2 <- 1.05576	
inflation_2016_Q3 <- 1.05894
inflation_2016_Q4 <- 1.06470				
inflation_2017_Q1 <- 1.07007
inflation_2017_Q2 <- 1.07361		
inflation_2017_Q3 <- 1.07942
inflation_2017_Q4 <- 1.08658						
inflation_2018_Q1 <- 1.09312
inflation_2018_Q2 <- 1.10156		
inflation_2018_Q3 <- 1.10647
inflation_2018_Q4 <- 1.11191		
inflation_2019_Q1 <- 1.11502
inflation_2019_Q2 <- 1.12142		
inflation_2019_Q3 <- 1.12524
inflation_2019_Q4 <- 1.12947			
inflation_2020_Q1 <- 1.13397
inflation_2020_Q2 <- 1.12969		
inflation_2020_Q3 <- 1.13984
inflation_2020_Q4 <- 1.14611		
```








## 3. Identification of patients




Codes for place of healthcare use
```{r}
# Resource utilization
revenue_codes_EDvisits <- c("0450", "0451", "0452", "0456", "0459", "0981")
place_of_service_codes_EDvisits <- c("20", "23", "41", "42")
CPT_codes_EDvisits <- c("99281", "99282", "99283", "99284", "99285")
service_subcategory_codes_EDvisits <- c("10120", "10220", "10320", "10420", "10520", "12220", "20120", "20220", "21120", "21220", "22120", "22320", "30120", "30220", "30320", "30420", "30520", "30620", "31120", "31220", "31320", "31420", "31520", "31620")
PROCGRP_codes_EDvisits <- c("111", "114")

revenue_codes_inpatient <- c("0100", "0101", "0110", "0111", "0112", "0113", "0114", "0115", "0116", "0117", "0118", "0119", "0120", "0121", "0122", "0123", "0124", "0125", "0126", "0127", "0128", "0129", "0130", "0131", "0132", "0133", "0134", "0135", "0136", "0137", "0138", "0139", "0140", "0141", "0142", "0143", "0144", "0145", "0146", "0147", "0148", "0149", "0150", "0151", "0152", "0153", "0154", "0155", "0156", "0157", "0158", "0159", "0160", "0161", "0162", "0164", "0166", "0167", "0168", "0169", "0170", "0171", "0172", "0173", "0174", "0175", "0179", "0180", "0182", "0183", "0184", "0185", "0189", "0190", "0191", "0192", "0193", "0194", "0199", "0200", "0201", "0202", "0203", "0204", "0206", "0207", "0208", "0209", "0210", "0211", "0212", "0213", "0214", "0219", "0720", "0721", "0722", "0723", "0724", "0729", "0760", "0761", "0762", "0769", "0800", "0801", "0802", "0803", "0804", "0809")
place_of_service_codes_inpatient <- c("21", "27", "28", "51", "61")
CPT_codes_inpatient <- c("99217", "99218", "99219", "99220", "99224", "99225", "99226", "99234", "99235", "99236")
```




Identify patients with infantile spasms
```{r}
# Codes for patients with infantile spasms
codes_IS_ICD9 <- c("3456", "34560", "34561")

codes_IS_ICD10 <- c("G4082", "G40821", "G40822", "G40823", "G40824")


# Codes for patients presenting with epilepsy to the encounter
codes_epilepsy_ICD9 <- c("345", "3450", "34500", "34501", "3451", "34510", "34511", "3452", "3453", "3454", "34540", "34541", "3455", "34550", "34551", "3456", "34560", "34561", "3457", "34570", "34571", "3458", "34580", "34581", "3459", "34590", "34591", "78039")

codes_epilepsy_ICD10 <- c("G40", "G400", "G4000", "G40001", "G40009", "G4001", "G40011", "G40019", "G401", "G4010", "G40101", "G40109", "G4011", "G40111", "G40119", "G402", "G4020", "G40201", "G40209", "G4021", "G40211", "G40219", "G403", "G4030", "G40301", "G40309", "G4031", "G40311", "G40319", "G40A", "G40A0", "G40A01", "G40A09", "G40A1", "G40A11", "G40A19", "G40B", "G40B0", "G40B01", "G40B09", "G40B1", "G40B11", "G40B19", "G404", "G4040", "G40401", "G40409", "G4041", "G40411", "G40419", "G4042", "G405", "G4050", "G40501", "G40509", "G408", "G4080", "G40801", "G40802", "G40803", "G40804", "G4081", "G40811", "G40812", "G40813", "G40814", "G4082", "G40821", "G40822", "G40823", "G40824", "G4083", "G40833", "G40834", "G4089", "G409", "G4090", "G40901", "G40909", "G4091", "G40911", "G40919", "R56", "R569")


# Patients with infantile spasms
#################################2006#################################
IS_2006_i <- ms_i_2006 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9 |
                                      DX3 %in% codes_IS_ICD9 | DX4 %in% codes_IS_ICD9 |
                                      DX5 %in% codes_IS_ICD9 | DX6 %in% codes_IS_ICD9 |
                                      DX7 %in% codes_IS_ICD9 | DX8 %in% codes_IS_ICD9 |
                                      DX9 %in% codes_IS_ICD9 | DX10 %in% codes_IS_ICD9 |
                                      DX11%in% codes_IS_ICD9 | DX12 %in% codes_IS_ICD9 |
                                      DX13 %in% codes_IS_ICD9 | DX14 %in% codes_IS_ICD9 |
                                      DX15 %in% codes_IS_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      mutate(epilepsy_encounter = case_when(
                                      DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                      TRUE ~ 0)) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 
                                      
IS_2006_o <- ms_o_2006 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 

IS_2006_s <- ms_s_2006 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter)


#################################2007#################################
IS_2007_i <- ms_i_2007 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9 |
                                      DX3 %in% codes_IS_ICD9 | DX4 %in% codes_IS_ICD9 |
                                      DX5 %in% codes_IS_ICD9 | DX6 %in% codes_IS_ICD9 |
                                      DX7 %in% codes_IS_ICD9 | DX8 %in% codes_IS_ICD9 |
                                      DX9 %in% codes_IS_ICD9 | DX10 %in% codes_IS_ICD9 |
                                      DX11%in% codes_IS_ICD9 | DX12 %in% codes_IS_ICD9 |
                                      DX13 %in% codes_IS_ICD9 | DX14 %in% codes_IS_ICD9 |
                                      DX15 %in% codes_IS_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      mutate(epilepsy_encounter = case_when(
                                        DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                        TRUE ~ 0)) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 
                                      
IS_2007_o <- ms_o_2007 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 

IS_2007_s <- ms_s_2007 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter)


#################################2008#################################
IS_2008_i <- ms_i_2008 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9 |
                                      DX3 %in% codes_IS_ICD9 | DX4 %in% codes_IS_ICD9 |
                                      DX5 %in% codes_IS_ICD9 | DX6 %in% codes_IS_ICD9 |
                                      DX7 %in% codes_IS_ICD9 | DX8 %in% codes_IS_ICD9 |
                                      DX9 %in% codes_IS_ICD9 | DX10 %in% codes_IS_ICD9 |
                                      DX11%in% codes_IS_ICD9 | DX12 %in% codes_IS_ICD9 |
                                      DX13 %in% codes_IS_ICD9 | DX14 %in% codes_IS_ICD9 |
                                      DX15 %in% codes_IS_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      mutate(epilepsy_encounter = case_when(
                                        DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                        TRUE ~ 0)) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 
                                      
IS_2008_o <- ms_o_2008 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                      mutate(epilepsy_encounter = case_when(
                                        DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                        TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 

IS_2008_s <- ms_s_2008 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter)


#################################2009#################################
IS_2009_i <- ms_i_2009 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9 |
                                      DX3 %in% codes_IS_ICD9 | DX4 %in% codes_IS_ICD9 |
                                      DX5 %in% codes_IS_ICD9 | DX6 %in% codes_IS_ICD9 |
                                      DX7 %in% codes_IS_ICD9 | DX8 %in% codes_IS_ICD9 |
                                      DX9 %in% codes_IS_ICD9 | DX10 %in% codes_IS_ICD9 |
                                      DX11%in% codes_IS_ICD9 | DX12 %in% codes_IS_ICD9 |
                                      DX13 %in% codes_IS_ICD9 | DX14 %in% codes_IS_ICD9 |
                                      DX15 %in% codes_IS_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      mutate(epilepsy_encounter = case_when(
                                        DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                        TRUE ~ 0)) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 
                                      
IS_2009_o <- ms_o_2009 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                    mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 

IS_2009_s <- ms_s_2009 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter)


#################################2010#################################
IS_2010_i <- ms_i_2010 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9 |
                                      DX3 %in% codes_IS_ICD9 | DX4 %in% codes_IS_ICD9 |
                                      DX5 %in% codes_IS_ICD9 | DX6 %in% codes_IS_ICD9 |
                                      DX7 %in% codes_IS_ICD9 | DX8 %in% codes_IS_ICD9 |
                                      DX9 %in% codes_IS_ICD9 | DX10 %in% codes_IS_ICD9 |
                                      DX11%in% codes_IS_ICD9 | DX12 %in% codes_IS_ICD9 |
                                      DX13 %in% codes_IS_ICD9 | DX14 %in% codes_IS_ICD9 |
                                      DX15 %in% codes_IS_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      mutate(epilepsy_encounter = case_when(
                                        DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                        TRUE ~ 0)) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 
                                      
IS_2010_o <- ms_o_2010 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 

IS_2010_s <- ms_s_2010 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter)


#################################2011#################################
IS_2011_i <- ms_i_2011 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9 |
                                      DX3 %in% codes_IS_ICD9 | DX4 %in% codes_IS_ICD9 |
                                      DX5 %in% codes_IS_ICD9 | DX6 %in% codes_IS_ICD9 |
                                      DX7 %in% codes_IS_ICD9 | DX8 %in% codes_IS_ICD9 |
                                      DX9 %in% codes_IS_ICD9 | DX10 %in% codes_IS_ICD9 |
                                      DX11%in% codes_IS_ICD9 | DX12 %in% codes_IS_ICD9 |
                                      DX13 %in% codes_IS_ICD9 | DX14 %in% codes_IS_ICD9 |
                                      DX15 %in% codes_IS_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      mutate(epilepsy_encounter = case_when(
                                        DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                        TRUE ~ 0)) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 
                                      
IS_2011_o <- ms_o_2011 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 

IS_2011_s <- ms_s_2011 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter)


#################################2012#################################
IS_2012_i <- ms_i_2012 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9 |
                                      DX3 %in% codes_IS_ICD9 | DX4 %in% codes_IS_ICD9 |
                                      DX5 %in% codes_IS_ICD9 | DX6 %in% codes_IS_ICD9 |
                                      DX7 %in% codes_IS_ICD9 | DX8 %in% codes_IS_ICD9 |
                                      DX9 %in% codes_IS_ICD9 | DX10 %in% codes_IS_ICD9 |
                                      DX11%in% codes_IS_ICD9 | DX12 %in% codes_IS_ICD9 |
                                      DX13 %in% codes_IS_ICD9 | DX14 %in% codes_IS_ICD9 |
                                      DX15 %in% codes_IS_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      mutate(epilepsy_encounter = case_when(
                                        DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                        TRUE ~ 0)) %>%   
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 
                                      
IS_2012_o <- ms_o_2012 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 

IS_2012_s <- ms_s_2012 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter)


#################################2013#################################
IS_2013_i <- ms_i_2013 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9 |
                                      DX3 %in% codes_IS_ICD9 | DX4 %in% codes_IS_ICD9 |
                                      DX5 %in% codes_IS_ICD9 | DX6 %in% codes_IS_ICD9 |
                                      DX7 %in% codes_IS_ICD9 | DX8 %in% codes_IS_ICD9 |
                                      DX9 %in% codes_IS_ICD9 | DX10 %in% codes_IS_ICD9 |
                                      DX11%in% codes_IS_ICD9 | DX12 %in% codes_IS_ICD9 |
                                      DX13 %in% codes_IS_ICD9 | DX14 %in% codes_IS_ICD9 |
                                      DX15 %in% codes_IS_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      mutate(epilepsy_encounter = case_when(
                                        DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                        TRUE ~ 0)) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 
                                      
IS_2013_o <- ms_o_2013 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 

IS_2013_s <- ms_s_2013 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                      DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                      TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter)


#################################2014#################################
IS_2014_i <- ms_i_2014 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9 |
                                      DX3 %in% codes_IS_ICD9 | DX4 %in% codes_IS_ICD9 |
                                      DX5 %in% codes_IS_ICD9 | DX6 %in% codes_IS_ICD9 |
                                      DX7 %in% codes_IS_ICD9 | DX8 %in% codes_IS_ICD9 |
                                      DX9 %in% codes_IS_ICD9 | DX10 %in% codes_IS_ICD9 |
                                      DX11%in% codes_IS_ICD9 | DX12 %in% codes_IS_ICD9 |
                                      DX13 %in% codes_IS_ICD9 | DX14 %in% codes_IS_ICD9 |
                                      DX15 %in% codes_IS_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      mutate(epilepsy_encounter = case_when(
                                        DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                        TRUE ~ 0)) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 
                                      
IS_2014_o <- ms_o_2014 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 

IS_2014_s <- ms_s_2014 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter)


#################################2015#################################
IS_2015_i <- ms_i_2015 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9 |
                                      DX3 %in% codes_IS_ICD9 | DX4 %in% codes_IS_ICD9 |
                                      DX5 %in% codes_IS_ICD9 | DX6 %in% codes_IS_ICD9 |
                                      DX7 %in% codes_IS_ICD9 | DX8 %in% codes_IS_ICD9 |
                                      DX9 %in% codes_IS_ICD9 | DX10 %in% codes_IS_ICD9 |
                                      DX11%in% codes_IS_ICD9 | DX12 %in% codes_IS_ICD9 |
                                      DX13 %in% codes_IS_ICD9 | DX14 %in% codes_IS_ICD9 |
                                      DX15 %in% codes_IS_ICD9 |
                                      DX1 %in% codes_IS_ICD10 | DX2 %in% codes_IS_ICD10 |
                                      DX3 %in% codes_IS_ICD10 | DX4 %in% codes_IS_ICD10 |
                                      DX5 %in% codes_IS_ICD10 | DX6 %in% codes_IS_ICD10 |
                                      DX7 %in% codes_IS_ICD10 | DX8 %in% codes_IS_ICD10 |
                                      DX9 %in% codes_IS_ICD10 | DX10 %in% codes_IS_ICD10 |
                                      DX11%in% codes_IS_ICD10 | DX12 %in% codes_IS_ICD10 |
                                      DX13 %in% codes_IS_ICD10 | DX14 %in% codes_IS_ICD10 |
                                      DX15 %in% codes_IS_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      mutate(epilepsy_encounter = case_when(
                                        DX1 %in% codes_epilepsy_ICD9 | 
                                          DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                        TRUE ~ 0)) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 
                                      
IS_2015_o <- ms_o_2015 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9 |
                                     DX1 %in% codes_IS_ICD10 | DX2 %in% codes_IS_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 | 
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                        TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 

IS_2015_s <- ms_s_2015 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_IS_ICD9 | DX2 %in% codes_IS_ICD9 |
                                     DX1 %in% codes_IS_ICD10 | DX2 %in% codes_IS_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 | 
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                        TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter)


#################################2016#################################
IS_2016_i <- ms_i_2016 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_IS_ICD10 | DX2 %in% codes_IS_ICD10 |
                                      DX3 %in% codes_IS_ICD10 | DX4 %in% codes_IS_ICD10 |
                                      DX5 %in% codes_IS_ICD10 | DX6 %in% codes_IS_ICD10 |
                                      DX7 %in% codes_IS_ICD10 | DX8 %in% codes_IS_ICD10 |
                                      DX9 %in% codes_IS_ICD10 | DX10 %in% codes_IS_ICD10 |
                                      DX11%in% codes_IS_ICD10 | DX12 %in% codes_IS_ICD10 |
                                      DX13 %in% codes_IS_ICD10 | DX14 %in% codes_IS_ICD10 |
                                      DX15 %in% codes_IS_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                       TRUE ~ 0)) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 
                                      
IS_2016_o <- ms_o_2016 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_IS_ICD10 | DX2 %in% codes_IS_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                      DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                      TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 

IS_2016_s <- ms_s_2016 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_IS_ICD10 | DX2 %in% codes_IS_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                      DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                      TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter)


#################################2017#################################
IS_2017_i <- ms_i_2017 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_IS_ICD10 | DX2 %in% codes_IS_ICD10 |
                                      DX3 %in% codes_IS_ICD10 | DX4 %in% codes_IS_ICD10 |
                                      DX5 %in% codes_IS_ICD10 | DX6 %in% codes_IS_ICD10 |
                                      DX7 %in% codes_IS_ICD10 | DX8 %in% codes_IS_ICD10 |
                                      DX9 %in% codes_IS_ICD10 | DX10 %in% codes_IS_ICD10 |
                                      DX11%in% codes_IS_ICD10 | DX12 %in% codes_IS_ICD10 |
                                      DX13 %in% codes_IS_ICD10 | DX14 %in% codes_IS_ICD10 |
                                      DX15 %in% codes_IS_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                       TRUE ~ 0)) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 
                                      
IS_2017_o <- ms_o_2017 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_IS_ICD10 | DX2 %in% codes_IS_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                      DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                      TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 

IS_2017_s <- ms_s_2017 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_IS_ICD10 | DX2 %in% codes_IS_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                      DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                      TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter)


#################################2018#################################
IS_2018_i <- ms_i_2018 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_IS_ICD10 | DX2 %in% codes_IS_ICD10 |
                                      DX3 %in% codes_IS_ICD10 | DX4 %in% codes_IS_ICD10 |
                                      DX5 %in% codes_IS_ICD10 | DX6 %in% codes_IS_ICD10 |
                                      DX7 %in% codes_IS_ICD10 | DX8 %in% codes_IS_ICD10 |
                                      DX9 %in% codes_IS_ICD10 | DX10 %in% codes_IS_ICD10 |
                                      DX11%in% codes_IS_ICD10 | DX12 %in% codes_IS_ICD10 |
                                      DX13 %in% codes_IS_ICD10 | DX14 %in% codes_IS_ICD10 |
                                      DX15 %in% codes_IS_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                       TRUE ~ 0)) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 
                                      
IS_2018_o <- ms_o_2018 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_IS_ICD10 | DX2 %in% codes_IS_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                      DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                      TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 

IS_2018_s <- ms_s_2018 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_IS_ICD10 | DX2 %in% codes_IS_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                      DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                      TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter)


#################################2019#################################
IS_2019_i <- ms_i_2019 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_IS_ICD10 | DX2 %in% codes_IS_ICD10 |
                                      DX3 %in% codes_IS_ICD10 | DX4 %in% codes_IS_ICD10 |
                                      DX5 %in% codes_IS_ICD10 | DX6 %in% codes_IS_ICD10 |
                                      DX7 %in% codes_IS_ICD10 | DX8 %in% codes_IS_ICD10 |
                                      DX9 %in% codes_IS_ICD10 | DX10 %in% codes_IS_ICD10 |
                                      DX11%in% codes_IS_ICD10 | DX12 %in% codes_IS_ICD10 |
                                      DX13 %in% codes_IS_ICD10 | DX14 %in% codes_IS_ICD10 |
                                      DX15 %in% codes_IS_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                       TRUE ~ 0)) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 
                                      
IS_2019_o <- ms_o_2019 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_IS_ICD10 | DX2 %in% codes_IS_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                      DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                      TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 

IS_2019_s <- ms_s_2019 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_IS_ICD10 | DX2 %in% codes_IS_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                      DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                      TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter)


#################################2020#################################
IS_2020_i <- ms_i_2020 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_IS_ICD10 | DX2 %in% codes_IS_ICD10 |
                                      DX3 %in% codes_IS_ICD10 | DX4 %in% codes_IS_ICD10 |
                                      DX5 %in% codes_IS_ICD10 | DX6 %in% codes_IS_ICD10 |
                                      DX7 %in% codes_IS_ICD10 | DX8 %in% codes_IS_ICD10 |
                                      DX9 %in% codes_IS_ICD10 | DX10 %in% codes_IS_ICD10 |
                                      DX11%in% codes_IS_ICD10 | DX12 %in% codes_IS_ICD10 |
                                      DX13 %in% codes_IS_ICD10 | DX14 %in% codes_IS_ICD10 |
                                      DX15 %in% codes_IS_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      mutate(epilepsy_encounter = case_when(
                                       DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                       TRUE ~ 0)) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 
                                      
IS_2020_o <- ms_o_2020 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_IS_ICD10 | DX2 %in% codes_IS_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                      DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                      TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter) 

IS_2020_s <- ms_s_2020 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_IS_ICD10 | DX2 %in% codes_IS_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     mutate(epilepsy_encounter = case_when(
                                      DX1 %in% codes_epilepsy_ICD9 ~ 1,
                                      TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost, epilepsy_encounter)




# Infantile spasms (at least one code for infantile spasms)
IS <- bind_rows(IS_2006_i, IS_2006_o, IS_2006_s, IS_2007_i, IS_2007_o, IS_2007_s, IS_2008_i, IS_2008_o, IS_2008_s, IS_2009_i, IS_2009_o, IS_2009_s, IS_2010_i, IS_2010_o, IS_2010_s, IS_2011_i, IS_2011_o, IS_2011_s, IS_2012_i, IS_2012_o, IS_2012_s, IS_2013_i, IS_2013_o, IS_2013_s, IS_2014_i, IS_2014_o, IS_2014_s, IS_2015_i, IS_2015_o, IS_2015_s, IS_2016_i, IS_2016_o, IS_2016_s, IS_2017_i, IS_2017_o, IS_2017_s, IS_2018_i, IS_2018_o, IS_2018_s, IS_2019_i, IS_2019_o, IS_2019_s, IS_2020_i, IS_2020_o, IS_2020_s) %>%
  arrange(ENROLID, AGE, SVCDATE) %>% 
  filter(AGE<=1) %>% 
  collect()
IS


IS_n <- IS %>% distinct(ENROLID) %>% nrow()
IS_n


IS_first_diagnosis <- IS %>% arrange(ENROLID, SVCDATE) %>% distinct(ENROLID, .keep_all=TRUE) %>% rename(first_diagnosis = SVCDATE) %>% collect()
IS_first_diagnosis
```




Identify patients with tuberous sclerosis complex
```{r}
# Codes for patients with TSC
codes_TSC_ICD9 <- c("7595")

codes_TSC_ICD10 <- c("Q851")


# Patients with tuberous sclerosis complex
#################################2006#################################
TSC_2006_i <- ms_i_2006 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9 |
                                      DX3 %in% codes_TSC_ICD9 | DX4 %in% codes_TSC_ICD9 |
                                      DX5 %in% codes_TSC_ICD9 | DX6 %in% codes_TSC_ICD9 |
                                      DX7 %in% codes_TSC_ICD9 | DX8 %in% codes_TSC_ICD9 |
                                      DX9 %in% codes_TSC_ICD9 | DX10 %in% codes_TSC_ICD9 |
                                      DX11%in% codes_TSC_ICD9 | DX12 %in% codes_TSC_ICD9 |
                                      DX13 %in% codes_TSC_ICD9 | DX14 %in% codes_TSC_ICD9 |
                                      DX15 %in% codes_TSC_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 
                                      
TSC_2006_o <- ms_o_2006 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 

TSC_2006_s <- ms_s_2006 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost)


#################################2007#################################
TSC_2007_i <- ms_i_2007 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9 |
                                      DX3 %in% codes_TSC_ICD9 | DX4 %in% codes_TSC_ICD9 |
                                      DX5 %in% codes_TSC_ICD9 | DX6 %in% codes_TSC_ICD9 |
                                      DX7 %in% codes_TSC_ICD9 | DX8 %in% codes_TSC_ICD9 |
                                      DX9 %in% codes_TSC_ICD9 | DX10 %in% codes_TSC_ICD9 |
                                      DX11%in% codes_TSC_ICD9 | DX12 %in% codes_TSC_ICD9 |
                                      DX13 %in% codes_TSC_ICD9 | DX14 %in% codes_TSC_ICD9 |
                                      DX15 %in% codes_TSC_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 
                                      
TSC_2007_o <- ms_o_2007 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 

TSC_2007_s <- ms_s_2007 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost)


#################################2008#################################
TSC_2008_i <- ms_i_2008 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9 |
                                      DX3 %in% codes_TSC_ICD9 | DX4 %in% codes_TSC_ICD9 |
                                      DX5 %in% codes_TSC_ICD9 | DX6 %in% codes_TSC_ICD9 |
                                      DX7 %in% codes_TSC_ICD9 | DX8 %in% codes_TSC_ICD9 |
                                      DX9 %in% codes_TSC_ICD9 | DX10 %in% codes_TSC_ICD9 |
                                      DX11%in% codes_TSC_ICD9 | DX12 %in% codes_TSC_ICD9 |
                                      DX13 %in% codes_TSC_ICD9 | DX14 %in% codes_TSC_ICD9 |
                                      DX15 %in% codes_TSC_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 
                                      
TSC_2008_o <- ms_o_2008 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 

TSC_2008_s <- ms_s_2008 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost)


#################################2009#################################
TSC_2009_i <- ms_i_2009 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9 |
                                      DX3 %in% codes_TSC_ICD9 | DX4 %in% codes_TSC_ICD9 |
                                      DX5 %in% codes_TSC_ICD9 | DX6 %in% codes_TSC_ICD9 |
                                      DX7 %in% codes_TSC_ICD9 | DX8 %in% codes_TSC_ICD9 |
                                      DX9 %in% codes_TSC_ICD9 | DX10 %in% codes_TSC_ICD9 |
                                      DX11%in% codes_TSC_ICD9 | DX12 %in% codes_TSC_ICD9 |
                                      DX13 %in% codes_TSC_ICD9 | DX14 %in% codes_TSC_ICD9 |
                                      DX15 %in% codes_TSC_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 
                                      
TSC_2009_o <- ms_o_2009 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 

TSC_2009_s <- ms_s_2009 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost)


#################################2010#################################
TSC_2010_i <- ms_i_2010 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9 |
                                      DX3 %in% codes_TSC_ICD9 | DX4 %in% codes_TSC_ICD9 |
                                      DX5 %in% codes_TSC_ICD9 | DX6 %in% codes_TSC_ICD9 |
                                      DX7 %in% codes_TSC_ICD9 | DX8 %in% codes_TSC_ICD9 |
                                      DX9 %in% codes_TSC_ICD9 | DX10 %in% codes_TSC_ICD9 |
                                      DX11%in% codes_TSC_ICD9 | DX12 %in% codes_TSC_ICD9 |
                                      DX13 %in% codes_TSC_ICD9 | DX14 %in% codes_TSC_ICD9 |
                                      DX15 %in% codes_TSC_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 
                                      
TSC_2010_o <- ms_o_2010 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 

TSC_2010_s <- ms_s_2010 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost)


#################################2011#################################
TSC_2011_i <- ms_i_2011 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9 |
                                      DX3 %in% codes_TSC_ICD9 | DX4 %in% codes_TSC_ICD9 |
                                      DX5 %in% codes_TSC_ICD9 | DX6 %in% codes_TSC_ICD9 |
                                      DX7 %in% codes_TSC_ICD9 | DX8 %in% codes_TSC_ICD9 |
                                      DX9 %in% codes_TSC_ICD9 | DX10 %in% codes_TSC_ICD9 |
                                      DX11%in% codes_TSC_ICD9 | DX12 %in% codes_TSC_ICD9 |
                                      DX13 %in% codes_TSC_ICD9 | DX14 %in% codes_TSC_ICD9 |
                                      DX15 %in% codes_TSC_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 
                                      
TSC_2011_o <- ms_o_2011 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 

TSC_2011_s <- ms_s_2011 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost)


#################################2012#################################
TSC_2012_i <- ms_i_2012 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9 |
                                      DX3 %in% codes_TSC_ICD9 | DX4 %in% codes_TSC_ICD9 |
                                      DX5 %in% codes_TSC_ICD9 | DX6 %in% codes_TSC_ICD9 |
                                      DX7 %in% codes_TSC_ICD9 | DX8 %in% codes_TSC_ICD9 |
                                      DX9 %in% codes_TSC_ICD9 | DX10 %in% codes_TSC_ICD9 |
                                      DX11%in% codes_TSC_ICD9 | DX12 %in% codes_TSC_ICD9 |
                                      DX13 %in% codes_TSC_ICD9 | DX14 %in% codes_TSC_ICD9 |
                                      DX15 %in% codes_TSC_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 
                                      
TSC_2012_o <- ms_o_2012 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 

TSC_2012_s <- ms_s_2012 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost)


#################################2013#################################
TSC_2013_i <- ms_i_2013 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9 |
                                      DX3 %in% codes_TSC_ICD9 | DX4 %in% codes_TSC_ICD9 |
                                      DX5 %in% codes_TSC_ICD9 | DX6 %in% codes_TSC_ICD9 |
                                      DX7 %in% codes_TSC_ICD9 | DX8 %in% codes_TSC_ICD9 |
                                      DX9 %in% codes_TSC_ICD9 | DX10 %in% codes_TSC_ICD9 |
                                      DX11%in% codes_TSC_ICD9 | DX12 %in% codes_TSC_ICD9 |
                                      DX13 %in% codes_TSC_ICD9 | DX14 %in% codes_TSC_ICD9 |
                                      DX15 %in% codes_TSC_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 
                                      
TSC_2013_o <- ms_o_2013 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 

TSC_2013_s <- ms_s_2013 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost)


#################################2014#################################
TSC_2014_i <- ms_i_2014 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9 |
                                      DX3 %in% codes_TSC_ICD9 | DX4 %in% codes_TSC_ICD9 |
                                      DX5 %in% codes_TSC_ICD9 | DX6 %in% codes_TSC_ICD9 |
                                      DX7 %in% codes_TSC_ICD9 | DX8 %in% codes_TSC_ICD9 |
                                      DX9 %in% codes_TSC_ICD9 | DX10 %in% codes_TSC_ICD9 |
                                      DX11%in% codes_TSC_ICD9 | DX12 %in% codes_TSC_ICD9 |
                                      DX13 %in% codes_TSC_ICD9 | DX14 %in% codes_TSC_ICD9 |
                                      DX15 %in% codes_TSC_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 
                                      
TSC_2014_o <- ms_o_2014 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 

TSC_2014_s <- ms_s_2014 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost)


#################################2015#################################
TSC_2015_i <- ms_i_2015 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9 |
                                      DX3 %in% codes_TSC_ICD9 | DX4 %in% codes_TSC_ICD9 |
                                      DX5 %in% codes_TSC_ICD9 | DX6 %in% codes_TSC_ICD9 |
                                      DX7 %in% codes_TSC_ICD9 | DX8 %in% codes_TSC_ICD9 |
                                      DX9 %in% codes_TSC_ICD9 | DX10 %in% codes_TSC_ICD9 |
                                      DX11%in% codes_TSC_ICD9 | DX12 %in% codes_TSC_ICD9 |
                                      DX13 %in% codes_TSC_ICD9 | DX14 %in% codes_TSC_ICD9 |
                                      DX15 %in% codes_TSC_ICD9 |
                                      DX1 %in% codes_TSC_ICD10 | DX2 %in% codes_TSC_ICD10 |
                                      DX3 %in% codes_TSC_ICD10 | DX4 %in% codes_TSC_ICD10 |
                                      DX5 %in% codes_TSC_ICD10 | DX6 %in% codes_TSC_ICD10 |
                                      DX7 %in% codes_TSC_ICD10 | DX8 %in% codes_TSC_ICD10 |
                                      DX9 %in% codes_TSC_ICD10 | DX10 %in% codes_TSC_ICD10 |
                                      DX11%in% codes_TSC_ICD10 | DX12 %in% codes_TSC_ICD10 |
                                      DX13 %in% codes_TSC_ICD10 | DX14 %in% codes_TSC_ICD10 |
                                      DX15 %in% codes_TSC_ICD10                                        
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 
                                      
TSC_2015_o <- ms_o_2015 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9 |
                                     DX1 %in% codes_TSC_ICD10 | DX2 %in% codes_TSC_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 

TSC_2015_s <- ms_s_2015 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_TSC_ICD9 | DX2 %in% codes_TSC_ICD9 |
                                     DX1 %in% codes_TSC_ICD10 | DX2 %in% codes_TSC_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost)


#################################2016#################################
TSC_2016_i <- ms_i_2016 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_TSC_ICD10 | DX2 %in% codes_TSC_ICD10 |
                                      DX3 %in% codes_TSC_ICD10 | DX4 %in% codes_TSC_ICD10 |
                                      DX5 %in% codes_TSC_ICD10 | DX6 %in% codes_TSC_ICD10 |
                                      DX7 %in% codes_TSC_ICD10 | DX8 %in% codes_TSC_ICD10 |
                                      DX9 %in% codes_TSC_ICD10 | DX10 %in% codes_TSC_ICD10 |
                                      DX11%in% codes_TSC_ICD10 | DX12 %in% codes_TSC_ICD10 |
                                      DX13 %in% codes_TSC_ICD10 | DX14 %in% codes_TSC_ICD10 |
                                      DX15 %in% codes_TSC_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 
                                      
TSC_2016_o <- ms_o_2016 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_TSC_ICD10 | DX2 %in% codes_TSC_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 

TSC_2016_s <- ms_s_2016 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_TSC_ICD10 | DX2 %in% codes_TSC_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost)


#################################2017#################################
TSC_2017_i <- ms_i_2017 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_TSC_ICD10 | DX2 %in% codes_TSC_ICD10 |
                                      DX3 %in% codes_TSC_ICD10 | DX4 %in% codes_TSC_ICD10 |
                                      DX5 %in% codes_TSC_ICD10 | DX6 %in% codes_TSC_ICD10 |
                                      DX7 %in% codes_TSC_ICD10 | DX8 %in% codes_TSC_ICD10 |
                                      DX9 %in% codes_TSC_ICD10 | DX10 %in% codes_TSC_ICD10 |
                                      DX11%in% codes_TSC_ICD10 | DX12 %in% codes_TSC_ICD10 |
                                      DX13 %in% codes_TSC_ICD10 | DX14 %in% codes_TSC_ICD10 |
                                      DX15 %in% codes_TSC_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 
                                      
TSC_2017_o <- ms_o_2017 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_TSC_ICD10 | DX2 %in% codes_TSC_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 

TSC_2017_s <- ms_s_2017 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_TSC_ICD10 | DX2 %in% codes_TSC_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost)


#################################2018#################################
TSC_2018_i <- ms_i_2018 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_TSC_ICD10 | DX2 %in% codes_TSC_ICD10 |
                                      DX3 %in% codes_TSC_ICD10 | DX4 %in% codes_TSC_ICD10 |
                                      DX5 %in% codes_TSC_ICD10 | DX6 %in% codes_TSC_ICD10 |
                                      DX7 %in% codes_TSC_ICD10 | DX8 %in% codes_TSC_ICD10 |
                                      DX9 %in% codes_TSC_ICD10 | DX10 %in% codes_TSC_ICD10 |
                                      DX11%in% codes_TSC_ICD10 | DX12 %in% codes_TSC_ICD10 |
                                      DX13 %in% codes_TSC_ICD10 | DX14 %in% codes_TSC_ICD10 |
                                      DX15 %in% codes_TSC_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 
                                      
TSC_2018_o <- ms_o_2018 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_TSC_ICD10 | DX2 %in% codes_TSC_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 

TSC_2018_s <- ms_s_2018 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_TSC_ICD10 | DX2 %in% codes_TSC_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost)


#################################2019#################################
TSC_2019_i <- ms_i_2019 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_TSC_ICD10 | DX2 %in% codes_TSC_ICD10 |
                                      DX3 %in% codes_TSC_ICD10 | DX4 %in% codes_TSC_ICD10 |
                                      DX5 %in% codes_TSC_ICD10 | DX6 %in% codes_TSC_ICD10 |
                                      DX7 %in% codes_TSC_ICD10 | DX8 %in% codes_TSC_ICD10 |
                                      DX9 %in% codes_TSC_ICD10 | DX10 %in% codes_TSC_ICD10 |
                                      DX11%in% codes_TSC_ICD10 | DX12 %in% codes_TSC_ICD10 |
                                      DX13 %in% codes_TSC_ICD10 | DX14 %in% codes_TSC_ICD10 |
                                      DX15 %in% codes_TSC_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 
                                      
TSC_2019_o <- ms_o_2019 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_TSC_ICD10 | DX2 %in% codes_TSC_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 

TSC_2019_s <- ms_s_2019 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_TSC_ICD10 | DX2 %in% codes_TSC_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost)


#################################2020#################################
TSC_2020_i <- ms_i_2020 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE, DAYS, TOTPAY) %>% filter(
                                      DX1 %in% codes_TSC_ICD10 | DX2 %in% codes_TSC_ICD10 |
                                      DX3 %in% codes_TSC_ICD10 | DX4 %in% codes_TSC_ICD10 |
                                      DX5 %in% codes_TSC_ICD10 | DX6 %in% codes_TSC_ICD10 |
                                      DX7 %in% codes_TSC_ICD10 | DX8 %in% codes_TSC_ICD10 |
                                      DX9 %in% codes_TSC_ICD10 | DX10 %in% codes_TSC_ICD10 |
                                      DX11%in% codes_TSC_ICD10 | DX12 %in% codes_TSC_ICD10 |
                                      DX13 %in% codes_TSC_ICD10 | DX14 %in% codes_TSC_ICD10 |
                                      DX15 %in% codes_TSC_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE, DAYS, TOTPAY), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      rename(SVCDATE=ADMDATE, LOS=DAYS, cost=TOTPAY) %>% 
                                      collect() %>% 
                                      mutate(type="inpatient") %>% 
                                      mutate(across(SVCDATE, mdy)) %>% 
                                      select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 
                                      
TSC_2020_o <- ms_o_2020 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% filter(
                                     DX1 %in% codes_TSC_ICD10 | DX2 %in% codes_TSC_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type=case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                                     REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                                     STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                                     PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                                     TRUE ~ "outpatient")
                                     ) %>% 
                                     mutate(LOS = case_when(
                                       type=="inpatient" ~ 1,
                                       TRUE ~ 0)) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost) 

TSC_2020_s <- ms_s_2020 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PAY, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% filter(
                                     DX1 %in% codes_TSC_ICD10 | DX2 %in% codes_TSC_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE, PAY), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     rename(cost=PAY) %>% 
                                     mutate(type = case_when(
                                     REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                                     STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                                     PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                                     PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                                     SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                                     TRUE ~ "inpatient")) %>% 
                                     mutate(LOS=DISDATE-ADMDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy)) %>% 
                                     select(ENROLID, AGE, SEX, SVCDATE, type, LOS, cost)




# Tuberous sclerosis complex (the presence of one code for infantile spasms)
TSC <- bind_rows(TSC_2006_i, TSC_2006_o, TSC_2006_s, TSC_2007_i, TSC_2007_o, TSC_2007_s, TSC_2008_i, TSC_2008_o, TSC_2008_s, TSC_2009_i, TSC_2009_o, TSC_2009_s, TSC_2010_i, TSC_2010_o, TSC_2010_s, TSC_2011_i, TSC_2011_o, TSC_2011_s, TSC_2012_i, TSC_2012_o, TSC_2012_s, TSC_2013_i, TSC_2013_o, TSC_2013_s, TSC_2014_i, TSC_2014_o, TSC_2014_s, TSC_2015_i, TSC_2015_o, TSC_2015_s, TSC_2016_i, TSC_2016_o, TSC_2016_s, TSC_2017_i, TSC_2017_o, TSC_2017_s, TSC_2018_i, TSC_2018_o, TSC_2018_s, TSC_2019_i, TSC_2019_o, TSC_2019_s, TSC_2020_i, TSC_2020_o, TSC_2020_s) %>%
  arrange(ENROLID, AGE, SVCDATE) %>% 
  collect()
TSC


TSC_first_diagnosis <- TSC %>% arrange(ENROLID, SVCDATE) %>% distinct(ENROLID, .keep_all=TRUE) %>% rename(first_diagnosis = SVCDATE) %>% collect()
TSC_first_diagnosis
```




Data for ACTH
```{r}
# ACTH (identified using the terms ACTH, corticotropin, cosyntropin, achtar, cortrosyn, synacthen, and nuvacthen)
#################################2006#################################
codes_NDCNUM_ACTH_2006 <- redbook_2006_data %>% filter(
  grepl("ACTH", GENNME, ignore.case=TRUE) |
  grepl("corticotropin", GENNME, ignore.case=TRUE) |
  grepl("cosyntropin", GENNME, ignore.case=TRUE) |
  grepl("ACTH", THRDTDS, ignore.case=TRUE) |    
  grepl("corticotropin", THRDTDS, ignore.case=TRUE) |
  grepl("cosyntropin", THRDTDS, ignore.case=TRUE) |
  grepl("ACTH", PRODNME, ignore.case=TRUE) |
  grepl("corticotropin", PRODNME, ignore.case=TRUE) |
  grepl("cosyntropin", PRODNME, ignore.case=TRUE) |
  grepl("ACTHAR", PRODNME, ignore.case=TRUE) |
  grepl("CORTROSYN", PRODNME, ignore.case=TRUE) |
  grepl("SYNACTHEN", PRODNME, ignore.case=TRUE) |
  grepl("NUVACTHEN", PRODNME, ignore.case=TRUE) 
  ) %>% pull(NDCNUM)
codes_NDCNUM_ACTH_2006 <- as.numeric(codes_NDCNUM_ACTH_2006)


#################################2007#################################
codes_NDCNUM_ACTH_2007 <- redbook_2007_data %>% filter(
  grepl("ACTH", GENNME, ignore.case=TRUE) |
  grepl("corticotropin", GENNME, ignore.case=TRUE) |
  grepl("cosyntropin", GENNME, ignore.case=TRUE) |
  grepl("ACTH", THRDTDS, ignore.case=TRUE) |    
  grepl("corticotropin", THRDTDS, ignore.case=TRUE) |
  grepl("cosyntropin", THRDTDS, ignore.case=TRUE) |
  grepl("ACTH", PRODNME, ignore.case=TRUE) |
  grepl("corticotropin", PRODNME, ignore.case=TRUE) |
  grepl("cosyntropin", PRODNME, ignore.case=TRUE) |
  grepl("ACTHAR", PRODNME, ignore.case=TRUE) |
  grepl("CORTROSYN", PRODNME, ignore.case=TRUE) |
  grepl("SYNACTHEN", PRODNME, ignore.case=TRUE) |
  grepl("NUVACTHEN", PRODNME, ignore.case=TRUE) 
  ) %>% pull(NDCNUM)
codes_NDCNUM_ACTH_2007 <- as.numeric(codes_NDCNUM_ACTH_2007)


#################################2008#################################
codes_NDCNUM_ACTH_2008 <- redbook_2008_data %>% filter(
  grepl("ACTH", GENNME, ignore.case=TRUE) |
  grepl("corticotropin", GENNME, ignore.case=TRUE) |
  grepl("cosyntropin", GENNME, ignore.case=TRUE) |
  grepl("ACTH", THRDTDS, ignore.case=TRUE) |    
  grepl("corticotropin", THRDTDS, ignore.case=TRUE) |
  grepl("cosyntropin", THRDTDS, ignore.case=TRUE) |
  grepl("ACTH", PRODNME, ignore.case=TRUE) |
  grepl("corticotropin", PRODNME, ignore.case=TRUE) |
  grepl("cosyntropin", PRODNME, ignore.case=TRUE) |
  grepl("ACTHAR", PRODNME, ignore.case=TRUE) |
  grepl("CORTROSYN", PRODNME, ignore.case=TRUE) |
  grepl("SYNACTHEN", PRODNME, ignore.case=TRUE) |
  grepl("NUVACTHEN", PRODNME, ignore.case=TRUE) 
  ) %>% pull(NDCNUM)
codes_NDCNUM_ACTH_2008 <- as.numeric(codes_NDCNUM_ACTH_2008)


#################################2009#################################
codes_NDCNUM_ACTH_2009 <- redbook_2009_data %>% filter(
  grepl("ACTH", GENNME, ignore.case=TRUE) |
  grepl("corticotropin", GENNME, ignore.case=TRUE) |
  grepl("cosyntropin", GENNME, ignore.case=TRUE) |
  grepl("ACTH", THRDTDS, ignore.case=TRUE) |    
  grepl("corticotropin", THRDTDS, ignore.case=TRUE) |
  grepl("cosyntropin", THRDTDS, ignore.case=TRUE) |
  grepl("ACTH", PRODNME, ignore.case=TRUE) |
  grepl("corticotropin", PRODNME, ignore.case=TRUE) |
  grepl("cosyntropin", PRODNME, ignore.case=TRUE) |
  grepl("ACTHAR", PRODNME, ignore.case=TRUE) |
  grepl("CORTROSYN", PRODNME, ignore.case=TRUE) |
  grepl("SYNACTHEN", PRODNME, ignore.case=TRUE) |
  grepl("NUVACTHEN", PRODNME, ignore.case=TRUE) 
  ) %>% pull(NDCNUM)
codes_NDCNUM_ACTH_2009 <- as.numeric(codes_NDCNUM_ACTH_2009)


#################################2010#################################
codes_NDCNUM_ACTH_2010 <- redbook_2010_data %>% filter(
  grepl("ACTH", GENNME, ignore.case=TRUE) |
  grepl("corticotropin", GENNME, ignore.case=TRUE) |
  grepl("cosyntropin", GENNME, ignore.case=TRUE) |
  grepl("ACTH", THRDTDS, ignore.case=TRUE) |    
  grepl("corticotropin", THRDTDS, ignore.case=TRUE) |
  grepl("cosyntropin", THRDTDS, ignore.case=TRUE) |
  grepl("ACTH", PRODNME, ignore.case=TRUE) |
  grepl("corticotropin", PRODNME, ignore.case=TRUE) |
  grepl("cosyntropin", PRODNME, ignore.case=TRUE) |
  grepl("ACTHAR", PRODNME, ignore.case=TRUE) |
  grepl("CORTROSYN", PRODNME, ignore.case=TRUE) |
  grepl("SYNACTHEN", PRODNME, ignore.case=TRUE) |
  grepl("NUVACTHEN", PRODNME, ignore.case=TRUE) 
  ) %>% pull(NDCNUM)
codes_NDCNUM_ACTH_2010 <- as.numeric(codes_NDCNUM_ACTH_2010)


#################################2011#################################
codes_NDCNUM_ACTH_2011 <- redbook_2011_data %>% filter(
  grepl("ACTH", GENNME, ignore.case=TRUE) |
  grepl("corticotropin", GENNME, ignore.case=TRUE) |
  grepl("cosyntropin", GENNME, ignore.case=TRUE) |
  grepl("ACTH", THRDTDS, ignore.case=TRUE) |    
  grepl("corticotropin", THRDTDS, ignore.case=TRUE) |
  grepl("cosyntropin", THRDTDS, ignore.case=TRUE) |
  grepl("ACTH", PRODNME, ignore.case=TRUE) |
  grepl("corticotropin", PRODNME, ignore.case=TRUE) |
  grepl("cosyntropin", PRODNME, ignore.case=TRUE) |
  grepl("ACTHAR", PRODNME, ignore.case=TRUE) |
  grepl("CORTROSYN", PRODNME, ignore.case=TRUE) |
  grepl("SYNACTHEN", PRODNME, ignore.case=TRUE) |
  grepl("NUVACTHEN", PRODNME, ignore.case=TRUE) 
  ) %>% pull(NDCNUM)
codes_NDCNUM_ACTH_2011 <- as.numeric(codes_NDCNUM_ACTH_2011)


#################################2012#################################
codes_NDCNUM_ACTH_2012 <- redbook_2012_data %>% filter(
  grepl("ACTH", GENNME, ignore.case=TRUE) |
  grepl("corticotropin", GENNME, ignore.case=TRUE) |
  grepl("cosyntropin", GENNME, ignore.case=TRUE) |
  grepl("ACTH", THRDTDS, ignore.case=TRUE) |    
  grepl("corticotropin", THRDTDS, ignore.case=TRUE) |
  grepl("cosyntropin", THRDTDS, ignore.case=TRUE) |
  grepl("ACTH", PRODNME, ignore.case=TRUE) |
  grepl("corticotropin", PRODNME, ignore.case=TRUE) |
  grepl("cosyntropin", PRODNME, ignore.case=TRUE) |
  grepl("ACTHAR", PRODNME, ignore.case=TRUE) |
  grepl("CORTROSYN", PRODNME, ignore.case=TRUE) |
  grepl("SYNACTHEN", PRODNME, ignore.case=TRUE) |
  grepl("NUVACTHEN", PRODNME, ignore.case=TRUE) 
  ) %>% pull(NDCNUM)
codes_NDCNUM_ACTH_2012 <- as.numeric(codes_NDCNUM_ACTH_2012)


#################################2013#################################
codes_NDCNUM_ACTH_2013 <- redbook_2013_data %>% filter(
  grepl("ACTH", GENNME, ignore.case=TRUE) |
  grepl("corticotropin", GENNME, ignore.case=TRUE) |
  grepl("cosyntropin", GENNME, ignore.case=TRUE) |
  grepl("ACTH", THRDTDS, ignore.case=TRUE) |    
  grepl("corticotropin", THRDTDS, ignore.case=TRUE) |
  grepl("cosyntropin", THRDTDS, ignore.case=TRUE) |
  grepl("ACTH", PRODNME, ignore.case=TRUE) |
  grepl("corticotropin", PRODNME, ignore.case=TRUE) |
  grepl("cosyntropin", PRODNME, ignore.case=TRUE) |
  grepl("ACTHAR", PRODNME, ignore.case=TRUE) |
  grepl("CORTROSYN", PRODNME, ignore.case=TRUE) |
  grepl("SYNACTHEN", PRODNME, ignore.case=TRUE) |
  grepl("NUVACTHEN", PRODNME, ignore.case=TRUE) 
  ) %>% pull(NDCNUM)
codes_NDCNUM_ACTH_2013 <- as.numeric(codes_NDCNUM_ACTH_2013)


#################################2014#################################
codes_NDCNUM_ACTH_2014 <- redbook_2014_data %>% filter(
  grepl("ACTH", GENNME, ignore.case=TRUE) |
  grepl("corticotropin", GENNME, ignore.case=TRUE) |
  grepl("cosyntropin", GENNME, ignore.case=TRUE) |
  grepl("ACTH", THRDTDS, ignore.case=TRUE) |    
  grepl("corticotropin", THRDTDS, ignore.case=TRUE) |
  grepl("cosyntropin", THRDTDS, ignore.case=TRUE) |
  grepl("ACTH", PRODNME, ignore.case=TRUE) |
  grepl("corticotropin", PRODNME, ignore.case=TRUE) |
  grepl("cosyntropin", PRODNME, ignore.case=TRUE) |
  grepl("ACTHAR", PRODNME, ignore.case=TRUE) |
  grepl("CORTROSYN", PRODNME, ignore.case=TRUE) |
  grepl("SYNACTHEN", PRODNME, ignore.case=TRUE) |
  grepl("NUVACTHEN", PRODNME, ignore.case=TRUE) 
  ) %>% pull(NDCNUM)
codes_NDCNUM_ACTH_2014 <- as.numeric(codes_NDCNUM_ACTH_2014)


#################################2015#################################
codes_NDCNUM_ACTH_2015 <- redbook_2015_data %>% filter(
  grepl("ACTH", GENNME, ignore.case=TRUE) |
  grepl("corticotropin", GENNME, ignore.case=TRUE) |
  grepl("cosyntropin", GENNME, ignore.case=TRUE) |
  grepl("ACTH", THRDTDS, ignore.case=TRUE) |    
  grepl("corticotropin", THRDTDS, ignore.case=TRUE) |
  grepl("cosyntropin", THRDTDS, ignore.case=TRUE) |
  grepl("ACTH", PRODNME, ignore.case=TRUE) |
  grepl("corticotropin", PRODNME, ignore.case=TRUE) |
  grepl("cosyntropin", PRODNME, ignore.case=TRUE) |
  grepl("ACTHAR", PRODNME, ignore.case=TRUE) |
  grepl("CORTROSYN", PRODNME, ignore.case=TRUE) |
  grepl("SYNACTHEN", PRODNME, ignore.case=TRUE) |
  grepl("NUVACTHEN", PRODNME, ignore.case=TRUE) 
  ) %>% pull(NDCNUM)
codes_NDCNUM_ACTH_2015 <- as.numeric(codes_NDCNUM_ACTH_2015)


#################################2016#################################
codes_NDCNUM_ACTH_2016 <- redbook_2016_data %>% filter(
  grepl("ACTH", GENNME, ignore.case=TRUE) |
  grepl("corticotropin", GENNME, ignore.case=TRUE) |
  grepl("cosyntropin", GENNME, ignore.case=TRUE) |
  grepl("ACTH", THRDTDS, ignore.case=TRUE) |    
  grepl("corticotropin", THRDTDS, ignore.case=TRUE) |
  grepl("cosyntropin", THRDTDS, ignore.case=TRUE) |
  grepl("ACTH", PRODNME, ignore.case=TRUE) |
  grepl("corticotropin", PRODNME, ignore.case=TRUE) |
  grepl("cosyntropin", PRODNME, ignore.case=TRUE) |
  grepl("ACTHAR", PRODNME, ignore.case=TRUE) |
  grepl("CORTROSYN", PRODNME, ignore.case=TRUE) |
  grepl("SYNACTHEN", PRODNME, ignore.case=TRUE) |
  grepl("NUVACTHEN", PRODNME, ignore.case=TRUE) 
  ) %>% pull(NDCNUM)
codes_NDCNUM_ACTH_2016 <- as.numeric(codes_NDCNUM_ACTH_2016)


#################################2017#################################
codes_NDCNUM_ACTH_2017 <- redbook_2017_data %>% filter(
  grepl("ACTH", GENNME, ignore.case=TRUE) |
  grepl("corticotropin", GENNME, ignore.case=TRUE) |
  grepl("cosyntropin", GENNME, ignore.case=TRUE) |
  grepl("ACTH", THRDTDS, ignore.case=TRUE) |    
  grepl("corticotropin", THRDTDS, ignore.case=TRUE) |
  grepl("cosyntropin", THRDTDS, ignore.case=TRUE) |
  grepl("ACTH", PRODNME, ignore.case=TRUE) |
  grepl("corticotropin", PRODNME, ignore.case=TRUE) |
  grepl("cosyntropin", PRODNME, ignore.case=TRUE) |
  grepl("ACTHAR", PRODNME, ignore.case=TRUE) |
  grepl("CORTROSYN", PRODNME, ignore.case=TRUE) |
  grepl("SYNACTHEN", PRODNME, ignore.case=TRUE) |
  grepl("NUVACTHEN", PRODNME, ignore.case=TRUE) 
  ) %>% pull(NDCNUM)
codes_NDCNUM_ACTH_2017 <- as.numeric(codes_NDCNUM_ACTH_2017)


#################################2018#################################
codes_NDCNUM_ACTH_2018 <- redbook_2018_data %>% filter(
  grepl("ACTH", GENNME, ignore.case=TRUE) |
  grepl("corticotropin", GENNME, ignore.case=TRUE) |
  grepl("cosyntropin", GENNME, ignore.case=TRUE) |
  grepl("ACTH", THRDTDS, ignore.case=TRUE) |    
  grepl("corticotropin", THRDTDS, ignore.case=TRUE) |
  grepl("cosyntropin", THRDTDS, ignore.case=TRUE) |
  grepl("ACTH", PRODNME, ignore.case=TRUE) |
  grepl("corticotropin", PRODNME, ignore.case=TRUE) |
  grepl("cosyntropin", PRODNME, ignore.case=TRUE) |
  grepl("ACTHAR", PRODNME, ignore.case=TRUE) |
  grepl("CORTROSYN", PRODNME, ignore.case=TRUE) |
  grepl("SYNACTHEN", PRODNME, ignore.case=TRUE) |
  grepl("NUVACTHEN", PRODNME, ignore.case=TRUE) 
  ) %>% pull(NDCNUM)
codes_NDCNUM_ACTH_2018 <- as.numeric(codes_NDCNUM_ACTH_2018)


#################################2019#################################
codes_NDCNUM_ACTH_2019 <- redbook_2019_data %>% filter(
  grepl("ACTH", GENNME, ignore.case=TRUE) |
  grepl("corticotropin", GENNME, ignore.case=TRUE) |
  grepl("cosyntropin", GENNME, ignore.case=TRUE) |
  grepl("ACTH", THRDTDS, ignore.case=TRUE) |    
  grepl("corticotropin", THRDTDS, ignore.case=TRUE) |
  grepl("cosyntropin", THRDTDS, ignore.case=TRUE) |
  grepl("ACTH", PRODNME, ignore.case=TRUE) |
  grepl("corticotropin", PRODNME, ignore.case=TRUE) |
  grepl("cosyntropin", PRODNME, ignore.case=TRUE) |
  grepl("ACTHAR", PRODNME, ignore.case=TRUE) |
  grepl("CORTROSYN", PRODNME, ignore.case=TRUE) |
  grepl("SYNACTHEN", PRODNME, ignore.case=TRUE) |
  grepl("NUVACTHEN", PRODNME, ignore.case=TRUE) 
  ) %>% pull(NDCNUM)
codes_NDCNUM_ACTH_2019 <- as.numeric(codes_NDCNUM_ACTH_2019)


#################################2020#################################
codes_NDCNUM_ACTH_2020 <- redbook_2020_data %>% filter(
  grepl("ACTH", GENNME, ignore.case=TRUE) |
  grepl("corticotropin", GENNME, ignore.case=TRUE) |
  grepl("cosyntropin", GENNME, ignore.case=TRUE) |
  grepl("ACTH", THRDTDS, ignore.case=TRUE) |    
  grepl("corticotropin", THRDTDS, ignore.case=TRUE) |
  grepl("cosyntropin", THRDTDS, ignore.case=TRUE) |
  grepl("ACTH", PRODNME, ignore.case=TRUE) |
  grepl("corticotropin", PRODNME, ignore.case=TRUE) |
  grepl("cosyntropin", PRODNME, ignore.case=TRUE) |
  grepl("ACTHAR", PRODNME, ignore.case=TRUE) |
  grepl("CORTROSYN", PRODNME, ignore.case=TRUE) |
  grepl("SYNACTHEN", PRODNME, ignore.case=TRUE) |
  grepl("NUVACTHEN", PRODNME, ignore.case=TRUE) 
  ) %>% pull(NDCNUM)
codes_NDCNUM_ACTH_2020 <- as.numeric(codes_NDCNUM_ACTH_2020)


# Codes for ACTH
codes_NDCNUM_ACTH <- unique(c(codes_NDCNUM_ACTH_2006, codes_NDCNUM_ACTH_2007, codes_NDCNUM_ACTH_2008, codes_NDCNUM_ACTH_2009, codes_NDCNUM_ACTH_2010, codes_NDCNUM_ACTH_2011, codes_NDCNUM_ACTH_2012, codes_NDCNUM_ACTH_2013, codes_NDCNUM_ACTH_2014, codes_NDCNUM_ACTH_2015, codes_NDCNUM_ACTH_2016, codes_NDCNUM_ACTH_2017, codes_NDCNUM_ACTH_2018, codes_NDCNUM_ACTH_2019, codes_NDCNUM_ACTH_2020))




# Information on ACTH
#################################2006#################################
ACTH_IS_2006 <- ms_d_2006 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ACTH) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2007#################################
ACTH_IS_2007 <- ms_d_2007 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ACTH) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2008#################################
ACTH_IS_2008 <- ms_d_2008 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ACTH) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2009#################################
ACTH_IS_2009 <- ms_d_2009 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ACTH) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2010#################################
ACTH_IS_2010 <- ms_d_2010 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ACTH) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2011#################################
ACTH_IS_2011 <- ms_d_2011 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ACTH) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2012#################################
ACTH_IS_2012 <- ms_d_2012 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ACTH) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2013#################################
ACTH_IS_2013 <- ms_d_2013 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ACTH) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2014#################################
ACTH_IS_2014 <- ms_d_2014 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ACTH) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2015#################################
ACTH_IS_2015 <- ms_d_2015 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ACTH) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2016#################################
ACTH_IS_2016 <- ms_d_2016 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ACTH) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2017#################################
ACTH_IS_2017 <- ms_d_2017 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ACTH) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2018#################################
ACTH_IS_2018 <- ms_d_2018 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ACTH) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2019#################################
ACTH_IS_2019 <- ms_d_2019 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ACTH) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2020#################################
ACTH_IS_2020 <- ms_d_2020 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ACTH) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))




# Infantile spasms with ACTH
ACTH_IS <- bind_rows(ACTH_IS_2006, ACTH_IS_2007, ACTH_IS_2008, ACTH_IS_2009, ACTH_IS_2010, ACTH_IS_2011, ACTH_IS_2012, ACTH_IS_2013, ACTH_IS_2014, ACTH_IS_2015, ACTH_IS_2016, ACTH_IS_2017, ACTH_IS_2018, ACTH_IS_2019, ACTH_IS_2020) %>%
  collect()
ACTH_IS


ACTH_IS_n <- ACTH_IS %>% distinct(ENROLID) %>% nrow()
ACTH_IS_n


ACTH_IS_first_treatment <- ACTH_IS %>% 
  rename(ACTH_first_treatment = SVCDATE) %>%
  arrange(ENROLID, ACTH_first_treatment) %>%
  select(ENROLID, ACTH_first_treatment) %>% 
  left_join(IS_first_diagnosis, by="ENROLID") %>% 
  filter(ACTH_first_treatment >= first_diagnosis) %>% 
  arrange(ENROLID, ACTH_first_treatment) %>%
  distinct(ENROLID, .keep_all=TRUE) %>%
  select(ENROLID, ACTH_first_treatment)
ACTH_IS_first_treatment
```




Data for vigabatrin
```{r}
# Vigabatrin (identified using the terms vigabatrin, sabril, and vigadrone)
#################################2006#################################
codes_NDCNUM_VGB_2006 <- redbook_2006_data %>% filter(
  grepl("vigabatrin", GENNME, ignore.case=TRUE) |
  grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |   
  grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
  grepl("sabril", PRODNME, ignore.case=TRUE) |
  grepl("vigadrone", PRODNME, ignore.case=TRUE)
  ) %>% pull(NDCNUM)
codes_NDCNUM_VGB_2006 <- as.numeric(codes_NDCNUM_VGB_2006)


#################################2007#################################
codes_NDCNUM_VGB_2007 <- redbook_2007_data %>% filter(
  grepl("vigabatrin", GENNME, ignore.case=TRUE) |
  grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |   
  grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
  grepl("sabril", PRODNME, ignore.case=TRUE) |
  grepl("vigadrone", PRODNME, ignore.case=TRUE)
  ) %>% pull(NDCNUM)
codes_NDCNUM_VGB_2007 <- as.numeric(codes_NDCNUM_VGB_2007)


#################################2008#################################
codes_NDCNUM_VGB_2008 <- redbook_2008_data %>% filter(
  grepl("vigabatrin", GENNME, ignore.case=TRUE) |
  grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |   
  grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
  grepl("sabril", PRODNME, ignore.case=TRUE) |
  grepl("vigadrone", PRODNME, ignore.case=TRUE)
  ) %>% pull(NDCNUM)
codes_NDCNUM_VGB_2008 <- as.numeric(codes_NDCNUM_VGB_2008)


#################################2009#################################
codes_NDCNUM_VGB_2009 <- redbook_2009_data %>% filter(
  grepl("vigabatrin", GENNME, ignore.case=TRUE) |
  grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |   
  grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
  grepl("sabril", PRODNME, ignore.case=TRUE) |
  grepl("vigadrone", PRODNME, ignore.case=TRUE)
  ) %>% pull(NDCNUM)
codes_NDCNUM_VGB_2009 <- as.numeric(codes_NDCNUM_VGB_2009)


#################################2010#################################
codes_NDCNUM_VGB_2010 <- redbook_2010_data %>% filter(
  grepl("vigabatrin", GENNME, ignore.case=TRUE) |
  grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |   
  grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
  grepl("sabril", PRODNME, ignore.case=TRUE) |
  grepl("vigadrone", PRODNME, ignore.case=TRUE)
  ) %>% pull(NDCNUM)
codes_NDCNUM_VGB_2010 <- as.numeric(codes_NDCNUM_VGB_2010)


#################################2011#################################
codes_NDCNUM_VGB_2011 <- redbook_2011_data %>% filter(
  grepl("vigabatrin", GENNME, ignore.case=TRUE) |
  grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |   
  grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
  grepl("sabril", PRODNME, ignore.case=TRUE) |
  grepl("vigadrone", PRODNME, ignore.case=TRUE)
  ) %>% pull(NDCNUM)
codes_NDCNUM_VGB_2011 <- as.numeric(codes_NDCNUM_VGB_2011)


#################################2012#################################
codes_NDCNUM_VGB_2012 <- redbook_2012_data %>% filter(
  grepl("vigabatrin", GENNME, ignore.case=TRUE) |
  grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |   
  grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
  grepl("sabril", PRODNME, ignore.case=TRUE) |
  grepl("vigadrone", PRODNME, ignore.case=TRUE)
  ) %>% pull(NDCNUM)
codes_NDCNUM_VGB_2012 <- as.numeric(codes_NDCNUM_VGB_2012)


#################################2013#################################
codes_NDCNUM_VGB_2013 <- redbook_2013_data %>% filter(
  grepl("vigabatrin", GENNME, ignore.case=TRUE) |
  grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |   
  grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
  grepl("sabril", PRODNME, ignore.case=TRUE) |
  grepl("vigadrone", PRODNME, ignore.case=TRUE)
  ) %>% pull(NDCNUM)
codes_NDCNUM_VGB_2013 <- as.numeric(codes_NDCNUM_VGB_2013)


#################################2014#################################
codes_NDCNUM_VGB_2014 <- redbook_2014_data %>% filter(
  grepl("vigabatrin", GENNME, ignore.case=TRUE) |
  grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |   
  grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
  grepl("sabril", PRODNME, ignore.case=TRUE) |
  grepl("vigadrone", PRODNME, ignore.case=TRUE)
  ) %>% pull(NDCNUM)
codes_NDCNUM_VGB_2014 <- as.numeric(codes_NDCNUM_VGB_2014)


#################################2015#################################
codes_NDCNUM_VGB_2015 <- redbook_2015_data %>% filter(
  grepl("vigabatrin", GENNME, ignore.case=TRUE) |
  grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |   
  grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
  grepl("sabril", PRODNME, ignore.case=TRUE) |
  grepl("vigadrone", PRODNME, ignore.case=TRUE)
  ) %>% pull(NDCNUM)
codes_NDCNUM_VGB_2015 <- as.numeric(codes_NDCNUM_VGB_2015)


#################################2016#################################
codes_NDCNUM_VGB_2016 <- redbook_2016_data %>% filter(
  grepl("vigabatrin", GENNME, ignore.case=TRUE) |
  grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |   
  grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
  grepl("sabril", PRODNME, ignore.case=TRUE) |
  grepl("vigadrone", PRODNME, ignore.case=TRUE)
  ) %>% pull(NDCNUM)
codes_NDCNUM_VGB_2016 <- as.numeric(codes_NDCNUM_VGB_2016)


#################################2017#################################
codes_NDCNUM_VGB_2017 <- redbook_2017_data %>% filter(
  grepl("vigabatrin", GENNME, ignore.case=TRUE) |
  grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |   
  grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
  grepl("sabril", PRODNME, ignore.case=TRUE) |
  grepl("vigadrone", PRODNME, ignore.case=TRUE)
  ) %>% pull(NDCNUM)
codes_NDCNUM_VGB_2017 <- as.numeric(codes_NDCNUM_VGB_2017)


#################################2018#################################
codes_NDCNUM_VGB_2018 <- redbook_2018_data %>% filter(
  grepl("vigabatrin", GENNME, ignore.case=TRUE) |
  grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |   
  grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
  grepl("sabril", PRODNME, ignore.case=TRUE) |
  grepl("vigadrone", PRODNME, ignore.case=TRUE)
  ) %>% pull(NDCNUM)
codes_NDCNUM_VGB_2018 <- as.numeric(codes_NDCNUM_VGB_2018)


#################################2019#################################
codes_NDCNUM_VGB_2019 <- redbook_2019_data %>% filter(
  grepl("vigabatrin", GENNME, ignore.case=TRUE) |
  grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |   
  grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
  grepl("sabril", PRODNME, ignore.case=TRUE) |
  grepl("vigadrone", PRODNME, ignore.case=TRUE)
  ) %>% pull(NDCNUM)
codes_NDCNUM_VGB_2019 <- as.numeric(codes_NDCNUM_VGB_2019)


#################################2020#################################
codes_NDCNUM_VGB_2020 <- redbook_2020_data %>% filter(
  grepl("vigabatrin", GENNME, ignore.case=TRUE) |
  grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |   
  grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
  grepl("sabril", PRODNME, ignore.case=TRUE) |
  grepl("vigadrone", PRODNME, ignore.case=TRUE)
  ) %>% pull(NDCNUM)
codes_NDCNUM_VGB_2020 <- as.numeric(codes_NDCNUM_VGB_2020)




# Codes for VGB
codes_NDCNUM_VGB <- unique(c(codes_NDCNUM_VGB_2006, codes_NDCNUM_VGB_2007, codes_NDCNUM_VGB_2008, codes_NDCNUM_VGB_2009, codes_NDCNUM_VGB_2010, codes_NDCNUM_VGB_2011, codes_NDCNUM_VGB_2012, codes_NDCNUM_VGB_2013, codes_NDCNUM_VGB_2014, codes_NDCNUM_VGB_2015, codes_NDCNUM_VGB_2016, codes_NDCNUM_VGB_2017, codes_NDCNUM_VGB_2018, codes_NDCNUM_VGB_2019, codes_NDCNUM_VGB_2020))




# Information on VGB
#################################2006#################################
VGB_IS_2006 <- ms_d_2006 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_VGB) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2007#################################
VGB_IS_2007 <- ms_d_2007 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_VGB) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2008#################################
VGB_IS_2008 <- ms_d_2008 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_VGB) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2009#################################
VGB_IS_2009 <- ms_d_2009 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_VGB) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2010#################################
VGB_IS_2010 <- ms_d_2010 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_VGB) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2011#################################
VGB_IS_2011 <- ms_d_2011 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_VGB) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2012#################################
VGB_IS_2012 <- ms_d_2012 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_VGB) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2013#################################
VGB_IS_2013 <- ms_d_2013 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_VGB) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2014#################################
VGB_IS_2014 <- ms_d_2014 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_VGB) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2015#################################
VGB_IS_2015 <- ms_d_2015 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_VGB) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2016#################################
VGB_IS_2016 <- ms_d_2016 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_VGB) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2017#################################
VGB_IS_2017 <- ms_d_2017 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_VGB) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2018#################################
VGB_IS_2018 <- ms_d_2018 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_VGB) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2019#################################
VGB_IS_2019 <- ms_d_2019 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_VGB) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2020#################################
VGB_IS_2020 <- ms_d_2020 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_VGB) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))




# Infantile spasms with VGB
VGB_IS <- bind_rows(VGB_IS_2006, VGB_IS_2007, VGB_IS_2008, VGB_IS_2009, VGB_IS_2010, VGB_IS_2011, VGB_IS_2012, VGB_IS_2013, VGB_IS_2014, VGB_IS_2015, VGB_IS_2016, VGB_IS_2017, VGB_IS_2018, VGB_IS_2019, VGB_IS_2020) %>%
  collect()
VGB_IS


VGB_IS_n <- VGB_IS %>% distinct(ENROLID) %>% nrow()
VGB_IS_n


VGB_IS_first_treatment <- VGB_IS %>% 
  rename(VGB_first_treatment = SVCDATE) %>%
  arrange(ENROLID, VGB_first_treatment) %>%
  select(ENROLID, VGB_first_treatment) %>% 
  left_join(IS_first_diagnosis, by="ENROLID") %>% 
  filter(VGB_first_treatment >= first_diagnosis) %>% 
  arrange(ENROLID, VGB_first_treatment) %>%
  distinct(ENROLID, .keep_all=TRUE) %>%
  select(ENROLID, VGB_first_treatment)
VGB_IS_first_treatment
```




Data for prednisolone
```{r}
# Prednisolone (identified using the terms prednisolone, bubbli-pred, cotolone, flo-pred, millipred, orapred, pediapred, prelone, and veripred; only consider suspension, solution, drops, syrup, liquid, tabs, or oral disintegrating tabs)
#################################2006#################################
codes_NDCNUM_PRD_2006 <- redbook_2006_data %>% filter(
  grepl("^prednisolone", GENNME, ignore.case=TRUE) |
  grepl("^prednisolone", THRDTDS, ignore.case=TRUE) |  
  grepl("^prednisolone", PRODNME, ignore.case=TRUE) |
  grepl("bubbli-pred", PRODNME, ignore.case=TRUE) |
  grepl("cotolone", PRODNME, ignore.case=TRUE) |
  grepl("flo-pred", PRODNME, ignore.case=TRUE) |
  grepl("millipred", PRODNME, ignore.case=TRUE) |
  grepl("orapred", PRODNME, ignore.case=TRUE) |
  grepl("pediapred", PRODNME, ignore.case=TRUE) |
  grepl("prelone", PRODNME, ignore.case=TRUE) |
  grepl("veripred", PRODNME, ignore.case=TRUE)
  ) %>% 
  filter(
    MASTFRM == "SUS" |
    MASTFRM == "SOL" |
    MASTFRM == "GTT" |
    MASTFRM == "SYR" |
    MASTFRM == "LIQ" |
    MASTFRM == "TAB" |
    MASTFRM == "ODT"
           ) %>% 
  filter(!grepl("methylprednisolone", GENNME, ignore.case=TRUE)) %>% 
  pull(NDCNUM)
codes_NDCNUM_PRD_2006 <- as.numeric(codes_NDCNUM_PRD_2006)


#################################2007#################################
codes_NDCNUM_PRD_2007 <- redbook_2007_data %>% filter(
  grepl("^prednisolone", GENNME, ignore.case=TRUE) |
  grepl("^prednisolone", THRDTDS, ignore.case=TRUE) |  
  grepl("^prednisolone", PRODNME, ignore.case=TRUE) |
  grepl("bubbli-pred", PRODNME, ignore.case=TRUE) |
  grepl("cotolone", PRODNME, ignore.case=TRUE) |
  grepl("flo-pred", PRODNME, ignore.case=TRUE) |
  grepl("millipred", PRODNME, ignore.case=TRUE) |
  grepl("orapred", PRODNME, ignore.case=TRUE) |
  grepl("pediapred", PRODNME, ignore.case=TRUE) |
  grepl("prelone", PRODNME, ignore.case=TRUE) |
  grepl("veripred", PRODNME, ignore.case=TRUE)
  ) %>% 
  filter(
    MASTFRM == "SUS" |
    MASTFRM == "SOL" |
    MASTFRM == "GTT" |
    MASTFRM == "SYR" |
    MASTFRM == "LIQ" |
    MASTFRM == "TAB" |
    MASTFRM == "ODT"
           ) %>% 
  filter(!grepl("methylprednisolone", GENNME, ignore.case=TRUE)) %>% 
  pull(NDCNUM)
codes_NDCNUM_PRD_2007 <- as.numeric(codes_NDCNUM_PRD_2007)


#################################2008#################################
codes_NDCNUM_PRD_2008 <- redbook_2008_data %>% filter(
  grepl("^prednisolone", GENNME, ignore.case=TRUE) |
  grepl("^prednisolone", THRDTDS, ignore.case=TRUE) |  
  grepl("^prednisolone", PRODNME, ignore.case=TRUE) |
  grepl("bubbli-pred", PRODNME, ignore.case=TRUE) |
  grepl("cotolone", PRODNME, ignore.case=TRUE) |
  grepl("flo-pred", PRODNME, ignore.case=TRUE) |
  grepl("millipred", PRODNME, ignore.case=TRUE) |
  grepl("orapred", PRODNME, ignore.case=TRUE) |
  grepl("pediapred", PRODNME, ignore.case=TRUE) |
  grepl("prelone", PRODNME, ignore.case=TRUE) |
  grepl("veripred", PRODNME, ignore.case=TRUE)
  ) %>% 
  filter(
    MASTFRM == "SUS" |
    MASTFRM == "SOL" |
    MASTFRM == "GTT" |
    MASTFRM == "SYR" |
    MASTFRM == "LIQ" |
    MASTFRM == "TAB" |
    MASTFRM == "ODT"
           ) %>% 
  filter(!grepl("methylprednisolone", GENNME, ignore.case=TRUE)) %>% 
  pull(NDCNUM)
codes_NDCNUM_PRD_2008 <- as.numeric(codes_NDCNUM_PRD_2008)


#################################2009#################################
codes_NDCNUM_PRD_2009 <- redbook_2009_data %>% filter(
  grepl("^prednisolone", GENNME, ignore.case=TRUE) |
  grepl("^prednisolone", THRDTDS, ignore.case=TRUE) |  
  grepl("^prednisolone", PRODNME, ignore.case=TRUE) |
  grepl("bubbli-pred", PRODNME, ignore.case=TRUE) |
  grepl("cotolone", PRODNME, ignore.case=TRUE) |
  grepl("flo-pred", PRODNME, ignore.case=TRUE) |
  grepl("millipred", PRODNME, ignore.case=TRUE) |
  grepl("orapred", PRODNME, ignore.case=TRUE) |
  grepl("pediapred", PRODNME, ignore.case=TRUE) |
  grepl("prelone", PRODNME, ignore.case=TRUE) |
  grepl("veripred", PRODNME, ignore.case=TRUE)
  ) %>% 
  filter(
    MASTFRM == "SUS" |
    MASTFRM == "SOL" |
    MASTFRM == "GTT" |
    MASTFRM == "SYR" |
    MASTFRM == "LIQ" |
    MASTFRM == "TAB" |
    MASTFRM == "ODT"
           ) %>% 
  filter(!grepl("methylprednisolone", GENNME, ignore.case=TRUE)) %>% 
  pull(NDCNUM)
codes_NDCNUM_PRD_2009 <- as.numeric(codes_NDCNUM_PRD_2009)


#################################2010#################################
codes_NDCNUM_PRD_2010 <- redbook_2010_data %>% filter(
  grepl("^prednisolone", GENNME, ignore.case=TRUE) |
  grepl("^prednisolone", THRDTDS, ignore.case=TRUE) |  
  grepl("^prednisolone", PRODNME, ignore.case=TRUE) |
  grepl("bubbli-pred", PRODNME, ignore.case=TRUE) |
  grepl("cotolone", PRODNME, ignore.case=TRUE) |
  grepl("flo-pred", PRODNME, ignore.case=TRUE) |
  grepl("millipred", PRODNME, ignore.case=TRUE) |
  grepl("orapred", PRODNME, ignore.case=TRUE) |
  grepl("pediapred", PRODNME, ignore.case=TRUE) |
  grepl("prelone", PRODNME, ignore.case=TRUE) |
  grepl("veripred", PRODNME, ignore.case=TRUE)
  ) %>% 
  filter(
    MASTFRM == "SUS" |
    MASTFRM == "SOL" |
    MASTFRM == "GTT" |
    MASTFRM == "SYR" |
    MASTFRM == "LIQ" |
    MASTFRM == "TAB" |
    MASTFRM == "ODT"
           ) %>% 
  filter(!grepl("methylprednisolone", GENNME, ignore.case=TRUE)) %>% 
  pull(NDCNUM)
codes_NDCNUM_PRD_2010 <- as.numeric(codes_NDCNUM_PRD_2010)


#################################2011#################################
codes_NDCNUM_PRD_2011 <- redbook_2011_data %>% filter(
  grepl("^prednisolone", GENNME, ignore.case=TRUE) |
  grepl("^prednisolone", THRDTDS, ignore.case=TRUE) |  
  grepl("^prednisolone", PRODNME, ignore.case=TRUE) |
  grepl("bubbli-pred", PRODNME, ignore.case=TRUE) |
  grepl("cotolone", PRODNME, ignore.case=TRUE) |
  grepl("flo-pred", PRODNME, ignore.case=TRUE) |
  grepl("millipred", PRODNME, ignore.case=TRUE) |
  grepl("orapred", PRODNME, ignore.case=TRUE) |
  grepl("pediapred", PRODNME, ignore.case=TRUE) |
  grepl("prelone", PRODNME, ignore.case=TRUE) |
  grepl("veripred", PRODNME, ignore.case=TRUE)
  ) %>% 
  filter(
    MASTFRM == "SUS" |
    MASTFRM == "SOL" |
    MASTFRM == "GTT" |
    MASTFRM == "SYR" |
    MASTFRM == "LIQ" |
    MASTFRM == "TAB" |
    MASTFRM == "ODT"
           ) %>% 
  filter(!grepl("methylprednisolone", GENNME, ignore.case=TRUE)) %>% 
  pull(NDCNUM)
codes_NDCNUM_PRD_2011 <- as.numeric(codes_NDCNUM_PRD_2011)


#################################2012#################################
codes_NDCNUM_PRD_2012 <- redbook_2012_data %>% filter(
  grepl("^prednisolone", GENNME, ignore.case=TRUE) |
  grepl("^prednisolone", THRDTDS, ignore.case=TRUE) |  
  grepl("^prednisolone", PRODNME, ignore.case=TRUE) |
  grepl("bubbli-pred", PRODNME, ignore.case=TRUE) |
  grepl("cotolone", PRODNME, ignore.case=TRUE) |
  grepl("flo-pred", PRODNME, ignore.case=TRUE) |
  grepl("millipred", PRODNME, ignore.case=TRUE) |
  grepl("orapred", PRODNME, ignore.case=TRUE) |
  grepl("pediapred", PRODNME, ignore.case=TRUE) |
  grepl("prelone", PRODNME, ignore.case=TRUE) |
  grepl("veripred", PRODNME, ignore.case=TRUE)
  ) %>% 
  filter(
    MASTFRM == "SUS" |
    MASTFRM == "SOL" |
    MASTFRM == "GTT" |
    MASTFRM == "SYR" |
    MASTFRM == "LIQ" |
    MASTFRM == "TAB" |
    MASTFRM == "ODT"
           ) %>% 
  filter(!grepl("methylprednisolone", GENNME, ignore.case=TRUE)) %>% 
  pull(NDCNUM)
codes_NDCNUM_PRD_2012 <- as.numeric(codes_NDCNUM_PRD_2012)



#################################2013#################################
codes_NDCNUM_PRD_2013 <- redbook_2013_data %>% filter(
  grepl("^prednisolone", GENNME, ignore.case=TRUE) |
  grepl("^prednisolone", THRDTDS, ignore.case=TRUE) |  
  grepl("^prednisolone", PRODNME, ignore.case=TRUE) |
  grepl("bubbli-pred", PRODNME, ignore.case=TRUE) |
  grepl("cotolone", PRODNME, ignore.case=TRUE) |
  grepl("flo-pred", PRODNME, ignore.case=TRUE) |
  grepl("millipred", PRODNME, ignore.case=TRUE) |
  grepl("orapred", PRODNME, ignore.case=TRUE) |
  grepl("pediapred", PRODNME, ignore.case=TRUE) |
  grepl("prelone", PRODNME, ignore.case=TRUE) |
  grepl("veripred", PRODNME, ignore.case=TRUE)
  ) %>% 
  filter(
    MASTFRM == "SUS" |
    MASTFRM == "SOL" |
    MASTFRM == "GTT" |
    MASTFRM == "SYR" |
    MASTFRM == "LIQ" |
    MASTFRM == "TAB" |
    MASTFRM == "ODT"
           ) %>% 
  filter(!grepl("methylprednisolone", GENNME, ignore.case=TRUE)) %>% 
  pull(NDCNUM)
codes_NDCNUM_PRD_2013 <- as.numeric(codes_NDCNUM_PRD_2013)


#################################2014#################################
codes_NDCNUM_PRD_2014 <- redbook_2014_data %>% filter(
  grepl("^prednisolone", GENNME, ignore.case=TRUE) |
  grepl("^prednisolone", THRDTDS, ignore.case=TRUE) |  
  grepl("^prednisolone", PRODNME, ignore.case=TRUE) |
  grepl("bubbli-pred", PRODNME, ignore.case=TRUE) |
  grepl("cotolone", PRODNME, ignore.case=TRUE) |
  grepl("flo-pred", PRODNME, ignore.case=TRUE) |
  grepl("millipred", PRODNME, ignore.case=TRUE) |
  grepl("orapred", PRODNME, ignore.case=TRUE) |
  grepl("pediapred", PRODNME, ignore.case=TRUE) |
  grepl("prelone", PRODNME, ignore.case=TRUE) |
  grepl("veripred", PRODNME, ignore.case=TRUE)
  ) %>% 
  filter(
    MASTFRM == "SUS" |
    MASTFRM == "SOL" |
    MASTFRM == "GTT" |
    MASTFRM == "SYR" |
    MASTFRM == "LIQ" |
    MASTFRM == "TAB" |
    MASTFRM == "ODT"
           ) %>% 
  filter(!grepl("methylprednisolone", GENNME, ignore.case=TRUE)) %>% 
  pull(NDCNUM)
codes_NDCNUM_PRD_2014 <- as.numeric(codes_NDCNUM_PRD_2014)


#################################2015#################################
codes_NDCNUM_PRD_2015 <- redbook_2015_data %>% filter(
  grepl("^prednisolone", GENNME, ignore.case=TRUE) |
  grepl("^prednisolone", THRDTDS, ignore.case=TRUE) |  
  grepl("^prednisolone", PRODNME, ignore.case=TRUE) |
  grepl("bubbli-pred", PRODNME, ignore.case=TRUE) |
  grepl("cotolone", PRODNME, ignore.case=TRUE) |
  grepl("flo-pred", PRODNME, ignore.case=TRUE) |
  grepl("millipred", PRODNME, ignore.case=TRUE) |
  grepl("orapred", PRODNME, ignore.case=TRUE) |
  grepl("pediapred", PRODNME, ignore.case=TRUE) |
  grepl("prelone", PRODNME, ignore.case=TRUE) |
  grepl("veripred", PRODNME, ignore.case=TRUE)
  ) %>% 
  filter(
    MASTFRM == "SUS" |
    MASTFRM == "SOL" |
    MASTFRM == "GTT" |
    MASTFRM == "SYR" |
    MASTFRM == "LIQ" |
    MASTFRM == "TAB" |
    MASTFRM == "ODT"
           ) %>% 
  filter(!grepl("methylprednisolone", GENNME, ignore.case=TRUE)) %>% 
  pull(NDCNUM)
codes_NDCNUM_PRD_2015 <- as.numeric(codes_NDCNUM_PRD_2015)


#################################2016#################################
codes_NDCNUM_PRD_2016 <- redbook_2016_data %>% filter(
  grepl("^prednisolone", GENNME, ignore.case=TRUE) |
  grepl("^prednisolone", THRDTDS, ignore.case=TRUE) |  
  grepl("^prednisolone", PRODNME, ignore.case=TRUE) |
  grepl("bubbli-pred", PRODNME, ignore.case=TRUE) |
  grepl("cotolone", PRODNME, ignore.case=TRUE) |
  grepl("flo-pred", PRODNME, ignore.case=TRUE) |
  grepl("millipred", PRODNME, ignore.case=TRUE) |
  grepl("orapred", PRODNME, ignore.case=TRUE) |
  grepl("pediapred", PRODNME, ignore.case=TRUE) |
  grepl("prelone", PRODNME, ignore.case=TRUE) |
  grepl("veripred", PRODNME, ignore.case=TRUE)
  ) %>% 
  filter(
    MASTFRM == "SUS" |
    MASTFRM == "SOL" |
    MASTFRM == "GTT" |
    MASTFRM == "SYR" |
    MASTFRM == "LIQ" |
    MASTFRM == "TAB" |
    MASTFRM == "ODT"
           ) %>% 
  filter(!grepl("methylprednisolone", GENNME, ignore.case=TRUE)) %>% 
  pull(NDCNUM)
codes_NDCNUM_PRD_2016 <- as.numeric(codes_NDCNUM_PRD_2016)


#################################2017#################################
codes_NDCNUM_PRD_2017 <- redbook_2017_data %>% filter(
  grepl("^prednisolone", GENNME, ignore.case=TRUE) |
  grepl("^prednisolone", THRDTDS, ignore.case=TRUE) |  
  grepl("^prednisolone", PRODNME, ignore.case=TRUE) |
  grepl("bubbli-pred", PRODNME, ignore.case=TRUE) |
  grepl("cotolone", PRODNME, ignore.case=TRUE) |
  grepl("flo-pred", PRODNME, ignore.case=TRUE) |
  grepl("millipred", PRODNME, ignore.case=TRUE) |
  grepl("orapred", PRODNME, ignore.case=TRUE) |
  grepl("pediapred", PRODNME, ignore.case=TRUE) |
  grepl("prelone", PRODNME, ignore.case=TRUE) |
  grepl("veripred", PRODNME, ignore.case=TRUE)
  ) %>% 
  filter(
    MASTFRM == "SUS" |
    MASTFRM == "SOL" |
    MASTFRM == "GTT" |
    MASTFRM == "SYR" |
    MASTFRM == "LIQ" |
    MASTFRM == "TAB" |
    MASTFRM == "ODT"
           ) %>% 
  filter(!grepl("methylprednisolone", GENNME, ignore.case=TRUE)) %>% 
  pull(NDCNUM)
codes_NDCNUM_PRD_2017 <- as.numeric(codes_NDCNUM_PRD_2017)


#################################2018#################################
codes_NDCNUM_PRD_2018 <- redbook_2018_data %>% filter(
  grepl("^prednisolone", GENNME, ignore.case=TRUE) |
  grepl("^prednisolone", THRDTDS, ignore.case=TRUE) |  
  grepl("^prednisolone", PRODNME, ignore.case=TRUE) |
  grepl("bubbli-pred", PRODNME, ignore.case=TRUE) |
  grepl("cotolone", PRODNME, ignore.case=TRUE) |
  grepl("flo-pred", PRODNME, ignore.case=TRUE) |
  grepl("millipred", PRODNME, ignore.case=TRUE) |
  grepl("orapred", PRODNME, ignore.case=TRUE) |
  grepl("pediapred", PRODNME, ignore.case=TRUE) |
  grepl("prelone", PRODNME, ignore.case=TRUE) |
  grepl("veripred", PRODNME, ignore.case=TRUE)
  ) %>% 
  filter(
    MASTFRM == "SUS" |
    MASTFRM == "SOL" |
    MASTFRM == "GTT" |
    MASTFRM == "SYR" |
    MASTFRM == "LIQ" |
    MASTFRM == "TAB" |
    MASTFRM == "ODT"
           ) %>% 
  filter(!grepl("methylprednisolone", GENNME, ignore.case=TRUE)) %>% 
  pull(NDCNUM)
codes_NDCNUM_PRD_2018 <- as.numeric(codes_NDCNUM_PRD_2018)


#################################2019#################################
codes_NDCNUM_PRD_2019 <- redbook_2019_data %>% filter(
  grepl("^prednisolone", GENNME, ignore.case=TRUE) |
  grepl("^prednisolone", THRDTDS, ignore.case=TRUE) |  
  grepl("^prednisolone", PRODNME, ignore.case=TRUE) |
  grepl("bubbli-pred", PRODNME, ignore.case=TRUE) |
  grepl("cotolone", PRODNME, ignore.case=TRUE) |
  grepl("flo-pred", PRODNME, ignore.case=TRUE) |
  grepl("millipred", PRODNME, ignore.case=TRUE) |
  grepl("orapred", PRODNME, ignore.case=TRUE) |
  grepl("pediapred", PRODNME, ignore.case=TRUE) |
  grepl("prelone", PRODNME, ignore.case=TRUE) |
  grepl("veripred", PRODNME, ignore.case=TRUE)
  ) %>% 
  filter(
    MASTFRM == "SUS" |
    MASTFRM == "SOL" |
    MASTFRM == "GTT" |
    MASTFRM == "SYR" |
    MASTFRM == "LIQ" |
    MASTFRM == "TAB" |
    MASTFRM == "ODT"
           ) %>% 
  filter(!grepl("methylprednisolone", GENNME, ignore.case=TRUE)) %>% 
  pull(NDCNUM)
codes_NDCNUM_PRD_2019 <- as.numeric(codes_NDCNUM_PRD_2019)


#################################2020#################################
codes_NDCNUM_PRD_2020 <- redbook_2020_data %>% filter(
  grepl("^prednisolone", GENNME, ignore.case=TRUE) |
  grepl("^prednisolone", THRDTDS, ignore.case=TRUE) |  
  grepl("^prednisolone", PRODNME, ignore.case=TRUE) |
  grepl("bubbli-pred", PRODNME, ignore.case=TRUE) |
  grepl("cotolone", PRODNME, ignore.case=TRUE) |
  grepl("flo-pred", PRODNME, ignore.case=TRUE) |
  grepl("millipred", PRODNME, ignore.case=TRUE) |
  grepl("orapred", PRODNME, ignore.case=TRUE) |
  grepl("pediapred", PRODNME, ignore.case=TRUE) |
  grepl("prelone", PRODNME, ignore.case=TRUE) |
  grepl("veripred", PRODNME, ignore.case=TRUE)
  ) %>% 
  filter(
    MASTFRM == "SUS" |
    MASTFRM == "SOL" |
    MASTFRM == "GTT" |
    MASTFRM == "SYR" |
    MASTFRM == "LIQ" |
    MASTFRM == "TAB" |
    MASTFRM == "ODT"
           ) %>% 
  filter(!grepl("methylprednisolone", GENNME, ignore.case=TRUE)) %>% 
  pull(NDCNUM)
codes_NDCNUM_PRD_2020 <- as.numeric(codes_NDCNUM_PRD_2020)




# Codes for PRD
codes_NDCNUM_PRD <- unique(c(codes_NDCNUM_PRD_2006, codes_NDCNUM_PRD_2007, codes_NDCNUM_PRD_2008, codes_NDCNUM_PRD_2009, codes_NDCNUM_PRD_2010, codes_NDCNUM_PRD_2011, codes_NDCNUM_PRD_2012, codes_NDCNUM_PRD_2013, codes_NDCNUM_PRD_2014, codes_NDCNUM_PRD_2015, codes_NDCNUM_PRD_2016, codes_NDCNUM_PRD_2017, codes_NDCNUM_PRD_2018, codes_NDCNUM_PRD_2019, codes_NDCNUM_PRD_2020))




# Information on PRD
#################################2006#################################
PRD_IS_2006 <- ms_d_2006 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_PRD) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2007#################################
PRD_IS_2007 <- ms_d_2007 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_PRD) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2008#################################
PRD_IS_2008 <- ms_d_2008 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_PRD) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2009#################################
PRD_IS_2009 <- ms_d_2009 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_PRD) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2010#################################
PRD_IS_2010 <- ms_d_2010 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_PRD) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2011#################################
PRD_IS_2011 <- ms_d_2011 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_PRD) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2012#################################
PRD_IS_2012 <- ms_d_2012 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_PRD) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2013#################################
PRD_IS_2013 <- ms_d_2013 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_PRD) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2014#################################
PRD_IS_2014 <- ms_d_2014 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_PRD) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2015#################################
PRD_IS_2015 <- ms_d_2015 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_PRD) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2016#################################
PRD_IS_2016 <- ms_d_2016 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_PRD) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2017#################################
PRD_IS_2017 <- ms_d_2017 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_PRD) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2018#################################
PRD_IS_2018 <- ms_d_2018 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_PRD) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2019#################################
PRD_IS_2019 <- ms_d_2019 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_PRD) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2020#################################
PRD_IS_2020 <- ms_d_2020 %>% 
  filter(ENROLID %in% !!IS_first_diagnosis$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_PRD) %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, REFILL, NDCNUM) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, INGCOST, NETPAY, PAY, SALETAX, DAYSUPP, METQTY, QTY, NDCNUM), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))




# Infantile spasms with PRD
PRD_IS <- bind_rows(PRD_IS_2006, PRD_IS_2007, PRD_IS_2008, PRD_IS_2009, PRD_IS_2010, PRD_IS_2011, PRD_IS_2012, PRD_IS_2013, PRD_IS_2014, PRD_IS_2015, PRD_IS_2016, PRD_IS_2017, PRD_IS_2018, PRD_IS_2019, PRD_IS_2020) %>%
  collect()
PRD_IS


PRD_IS_n <- PRD_IS %>% distinct(ENROLID) %>% nrow()
PRD_IS_n


PRD_IS_first_treatment <- PRD_IS %>% 
  rename(PRD_first_treatment = SVCDATE) %>%
  arrange(ENROLID, PRD_first_treatment) %>%
  select(ENROLID, PRD_first_treatment) %>% 
  left_join(IS_first_diagnosis, by="ENROLID") %>% 
  filter(PRD_first_treatment >= first_diagnosis) %>% 
  arrange(ENROLID, PRD_first_treatment) %>%
  distinct(ENROLID, .keep_all=TRUE) %>%
  select(ENROLID, PRD_first_treatment)
PRD_IS_first_treatment
```




ACTH treatment
```{r}
# Characteristics of treatment with ACTH
IS_treatment_ACTH <- IS_first_diagnosis %>% 
  filter(ENROLID %in% !!ACTH_IS_first_treatment$ENROLID) %>% 
  left_join(ACTH_IS_first_treatment, by="ENROLID") %>% 
  mutate(ACTH_time_diagnosis_treatment = ACTH_first_treatment - first_diagnosis) %>% 
  filter(ACTH_time_diagnosis_treatment >= 0 & ACTH_time_diagnosis_treatment <= 60) %>% 
  collect()
IS_treatment_ACTH


# Totals treatment per patient ACTH
IS_total_per_patient_ACTH <- ACTH_IS %>% 
  filter(ENROLID %in% !!IS_treatment_ACTH$ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ACTH_total_days = sumNA(DAYSUPP, na.rm=TRUE),
    ACTH_total_units = sumNA(METQTY, na.rm=TRUE),
    ACTH_total_AWP = sumNA(AWP, na.rm=TRUE),
    ACTH_total_COINS = sumNA(COINS, na.rm=TRUE),
    ACTH_total_COPAY = sumNA(COPAY, na.rm=TRUE),
    ACTH_total_DEDUCT = sumNA(DEDUCT, na.rm=TRUE),
    ACTH_total_INGCOST = sumNA(INGCOST, na.rm=TRUE),
    ACTH_total_NETPAY = sumNA(NETPAY, na.rm=TRUE),
    ACTH_total_PAY = sumNA(PAY, na.rm=TRUE)
        ) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, ACTH_total_days, ACTH_total_units, ACTH_total_AWP, ACTH_total_COINS, ACTH_total_COPAY, ACTH_total_DEDUCT, ACTH_total_INGCOST, ACTH_total_NETPAY, ACTH_total_PAY) %>% 
  filter(ACTH_total_days > 0)
IS_total_per_patient_ACTH


# Treatment per patient ACTH
IS_treatment_ACTH <- IS_treatment_ACTH %>% 
  left_join(IS_total_per_patient_ACTH, by="ENROLID") %>% 
  mutate(year_treatment = year(ACTH_first_treatment)) %>% 
  collect()
IS_treatment_ACTH




# Cost adjusted for inflation (to Q4 2020 year)
inflation_adjusted_IS_treatment_ACTH <- IS_treatment_ACTH %>% 
  mutate(year_quarter = quarter(ACTH_first_treatment, with_year=TRUE)) %>%
  mutate(
    ACTH_total_AWP = case_when(
  year_quarter == 2006.1 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ ACTH_total_AWP*(inflation_2020_Q4/inflation_2020_Q4)),
    ACTH_total_COINS = case_when(
  year_quarter == 2006.1 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ ACTH_total_COINS*(inflation_2020_Q4/inflation_2020_Q4)),
    ACTH_total_COPAY = case_when(
  year_quarter == 2006.1 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ ACTH_total_COPAY*(inflation_2020_Q4/inflation_2020_Q4)),  
    ACTH_total_DEDUCT = case_when(
  year_quarter == 2006.1 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ ACTH_total_DEDUCT*(inflation_2020_Q4/inflation_2020_Q4)),  
    ACTH_total_INGCOST = case_when(
  year_quarter == 2006.1 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ ACTH_total_INGCOST*(inflation_2020_Q4/inflation_2020_Q4)),  
    ACTH_total_NETPAY = case_when(
  year_quarter == 2006.1 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ ACTH_total_NETPAY*(inflation_2020_Q4/inflation_2020_Q4)),  
    ACTH_total_PAY = case_when(
  year_quarter == 2006.1 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ ACTH_total_PAY*(inflation_2020_Q4/inflation_2020_Q4))
  ) %>% 
    collect()
inflation_adjusted_IS_treatment_ACTH




# Normalize costs per unit and per standarized 14 day treatment (60 IU per day, 840 IU, 80 IU per ml)
inflation_adjusted_IS_treatment_ACTH <- inflation_adjusted_IS_treatment_ACTH %>%
  mutate(
    ACTH_AWP_per_unit = ACTH_total_AWP / ACTH_total_units,
    ACTH_AWP_14d = ACTH_AWP_per_unit * (840/80),    
    ACTH_COINS_per_unit = ACTH_total_COINS / ACTH_total_units,
    ACTH_COINS_14d = ACTH_COINS_per_unit * (840/80), 
    ACTH_COPAY_per_unit = ACTH_total_COPAY / ACTH_total_units,
    ACTH_COPAY_14d = ACTH_COPAY_per_unit * (840/80), 
    ACTH_DEDUCT_per_unit = ACTH_total_DEDUCT / ACTH_total_units,
    ACTH_DEDUCT_14d = ACTH_DEDUCT_per_unit * (840/80), 
    ACTH_INGCOST_per_unit = ACTH_total_INGCOST / ACTH_total_units,
    ACTH_INGCOST_14d = ACTH_INGCOST_per_unit * (840/80),
    ACTH_NETPAY_per_unit = ACTH_total_NETPAY / ACTH_total_units,
    ACTH_NETPAY_14d = ACTH_NETPAY_per_unit * (840/80),
    ACTH_PAY_per_unit = ACTH_total_PAY / ACTH_total_units,
    ACTH_PAY_14d = ACTH_PAY_per_unit * (840/80)
  ) %>% 
  mutate_if(is.numeric, list(~na_if(., Inf))) %>% 
  collect()
inflation_adjusted_IS_treatment_ACTH




# Calculate values by year
IS_treatment_by_year_ACTH <- inflation_adjusted_IS_treatment_ACTH %>%
  group_by(year_treatment) %>% 
  mutate(
    number_patients = n(),
    
    ACTH_yearly_mean_time_diagnosis_treatment = mean(ACTH_time_diagnosis_treatment, na.rm=TRUE),
    ACTH_yearly_SD_time_diagnosis_treatment = sd(ACTH_time_diagnosis_treatment, na.rm=TRUE),
    ACTH_yearly_median_time_diagnosis_treatment = median(ACTH_time_diagnosis_treatment, na.rm=TRUE),
    ACTH_yearly_p25_time_diagnosis_treatment = quantile(ACTH_time_diagnosis_treatment, 0.25, na.rm=TRUE),
    ACTH_yearly_p75_time_diagnosis_treatment = quantile(ACTH_time_diagnosis_treatment, 0.75, na.rm=TRUE),
        
    ACTH_yearly_mean_AWP_14d = mean(ACTH_AWP_14d, na.rm=TRUE),
    ACTH_yearly_SD_AWP_14d = sd(ACTH_AWP_14d, na.rm=TRUE),
    ACTH_yearly_median_AWP_14d = median(ACTH_AWP_14d, na.rm=TRUE),
    ACTH_yearly_p25_AWP_14d = quantile(ACTH_AWP_14d, 0.25, na.rm=TRUE),
    ACTH_yearly_p75_AWP_14d = quantile(ACTH_AWP_14d, 0.75, na.rm=TRUE),
    
    ACTH_yearly_mean_COINS_14d = mean(ACTH_COINS_14d, na.rm=TRUE),
    ACTH_yearly_SD_COINS_14d = sd(ACTH_COINS_14d, na.rm=TRUE),
    ACTH_yearly_median_COINS_14d = median(ACTH_COINS_14d, na.rm=TRUE),
    ACTH_yearly_p25_COINS_14d = quantile(ACTH_COINS_14d, 0.25, na.rm=TRUE),
    ACTH_yearly_p75_COINS_14d = quantile(ACTH_COINS_14d, 0.75, na.rm=TRUE),    
    
    ACTH_yearly_mean_COPAY_14d = mean(ACTH_COPAY_14d, na.rm=TRUE),
    ACTH_yearly_SD_COPAY_14d = sd(ACTH_COPAY_14d, na.rm=TRUE),
    ACTH_yearly_median_COPAY_14d = median(ACTH_COPAY_14d, na.rm=TRUE),
    ACTH_yearly_p25_COPAY_14d = quantile(ACTH_COPAY_14d, 0.25, na.rm=TRUE),
    ACTH_yearly_p75_COPAY_14d = quantile(ACTH_COPAY_14d, 0.75, na.rm=TRUE),  
 
    ACTH_yearly_mean_DEDUCT_14d = mean(ACTH_DEDUCT_14d, na.rm=TRUE),
    ACTH_yearly_SD_DEDUCT_14d = sd(ACTH_DEDUCT_14d, na.rm=TRUE),
    ACTH_yearly_median_DEDUCT_14d = median(ACTH_DEDUCT_14d, na.rm=TRUE),
    ACTH_yearly_p25_DEDUCT_14d = quantile(ACTH_DEDUCT_14d, 0.25, na.rm=TRUE),
    ACTH_yearly_p75_DEDUCT_14d = quantile(ACTH_DEDUCT_14d, 0.75, na.rm=TRUE),  
       
    ACTH_yearly_mean_INGCOST_14d = mean(ACTH_INGCOST_14d, na.rm=TRUE),
    ACTH_yearly_SD_INGCOST_14d = sd(ACTH_INGCOST_14d, na.rm=TRUE),
    ACTH_yearly_median_INGCOST_14d = median(ACTH_INGCOST_14d, na.rm=TRUE),
    ACTH_yearly_p25_INGCOST_14d = quantile(ACTH_INGCOST_14d, 0.25, na.rm=TRUE),
    ACTH_yearly_p75_INGCOST_14d = quantile(ACTH_INGCOST_14d, 0.75, na.rm=TRUE),  

    ACTH_yearly_mean_NETPAY_14d = mean(ACTH_NETPAY_14d, na.rm=TRUE),
    ACTH_yearly_SD_NETPAY_14d = sd(ACTH_NETPAY_14d, na.rm=TRUE),
    ACTH_yearly_median_NETPAY_14d = median(ACTH_NETPAY_14d, na.rm=TRUE),
    ACTH_yearly_p25_NETPAY_14d = quantile(ACTH_NETPAY_14d, 0.25, na.rm=TRUE),
    ACTH_yearly_p75_NETPAY_14d = quantile(ACTH_NETPAY_14d, 0.75, na.rm=TRUE), 

    ACTH_yearly_mean_PAY_14d = mean(ACTH_PAY_14d, na.rm=TRUE),
    ACTH_yearly_SD_PAY_14d = sd(ACTH_PAY_14d, na.rm=TRUE),
    ACTH_yearly_median_PAY_14d = median(ACTH_PAY_14d, na.rm=TRUE),
    ACTH_yearly_p25_PAY_14d = quantile(ACTH_PAY_14d, 0.25, na.rm=TRUE),
    ACTH_yearly_p75_PAY_14d = quantile(ACTH_PAY_14d, 0.75, na.rm=TRUE)
         ) %>% 
  arrange(year_treatment) %>% 
  distinct(year_treatment, .keep_all=TRUE) %>% 
  select(year_treatment, number_patients, ACTH_yearly_mean_time_diagnosis_treatment, ACTH_yearly_SD_time_diagnosis_treatment, ACTH_yearly_median_time_diagnosis_treatment, ACTH_yearly_p25_time_diagnosis_treatment, ACTH_yearly_p75_time_diagnosis_treatment, ACTH_yearly_mean_AWP_14d, ACTH_yearly_SD_AWP_14d, ACTH_yearly_median_AWP_14d, ACTH_yearly_p25_AWP_14d, ACTH_yearly_p75_AWP_14d, ACTH_yearly_mean_COINS_14d, ACTH_yearly_SD_COINS_14d, ACTH_yearly_median_COINS_14d, ACTH_yearly_p25_COINS_14d, ACTH_yearly_p75_COINS_14d, ACTH_yearly_mean_COPAY_14d, ACTH_yearly_SD_COPAY_14d, ACTH_yearly_median_COPAY_14d, ACTH_yearly_p25_COPAY_14d, ACTH_yearly_p75_COPAY_14d, ACTH_yearly_mean_DEDUCT_14d, ACTH_yearly_SD_DEDUCT_14d, ACTH_yearly_median_DEDUCT_14d, ACTH_yearly_p25_DEDUCT_14d, ACTH_yearly_p75_DEDUCT_14d, ACTH_yearly_mean_INGCOST_14d, ACTH_yearly_SD_INGCOST_14d, ACTH_yearly_median_INGCOST_14d, ACTH_yearly_p25_INGCOST_14d, ACTH_yearly_p75_INGCOST_14d, ACTH_yearly_mean_NETPAY_14d, ACTH_yearly_SD_NETPAY_14d, ACTH_yearly_median_NETPAY_14d, ACTH_yearly_p25_NETPAY_14d, ACTH_yearly_p75_NETPAY_14d, ACTH_yearly_mean_PAY_14d, ACTH_yearly_SD_PAY_14d, ACTH_yearly_median_PAY_14d, ACTH_yearly_p25_PAY_14d, ACTH_yearly_p75_PAY_14d) %>% 
  collect()
IS_treatment_by_year_ACTH
```




Vigabatrin treatment
```{r}
# Characteristics of treatment with VGB
IS_treatment_VGB <- IS_first_diagnosis %>% 
  filter(ENROLID %in% !!VGB_IS_first_treatment$ENROLID) %>% 
  left_join(VGB_IS_first_treatment, by="ENROLID") %>% 
  mutate(VGB_time_diagnosis_treatment = VGB_first_treatment - first_diagnosis) %>% 
  filter(VGB_time_diagnosis_treatment >= 0 & VGB_time_diagnosis_treatment <= 60) %>% 
  collect()
IS_treatment_VGB


# Totals treatment per patient VGB
IS_total_per_patient_VGB <- VGB_IS %>% 
  filter(ENROLID %in% !!IS_treatment_VGB$ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    VGB_total_days = sumNA(DAYSUPP, na.rm=TRUE),
    VGB_total_units = sumNA(METQTY, na.rm=TRUE),
    VGB_total_AWP = sumNA(AWP, na.rm=TRUE),
    VGB_total_COINS = sumNA(COINS, na.rm=TRUE),
    VGB_total_COPAY = sumNA(COPAY, na.rm=TRUE),
    VGB_total_DEDUCT = sumNA(DEDUCT, na.rm=TRUE),
    VGB_total_INGCOST = sumNA(INGCOST, na.rm=TRUE),
    VGB_total_NETPAY = sumNA(NETPAY, na.rm=TRUE),
    VGB_total_PAY = sumNA(PAY, na.rm=TRUE)
        ) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, VGB_total_days, VGB_total_units, VGB_total_AWP, VGB_total_COINS, VGB_total_COPAY, VGB_total_DEDUCT, VGB_total_INGCOST, VGB_total_NETPAY, VGB_total_PAY) %>% 
  filter(VGB_total_days > 0)
IS_total_per_patient_VGB


# Treatment per patient VGB
IS_treatment_VGB <- IS_treatment_VGB %>% 
  left_join(IS_total_per_patient_VGB, by="ENROLID") %>% 
  mutate(year_treatment = year(VGB_first_treatment)) %>% 
  collect()
IS_treatment_VGB




# Cost adjusted for inflation (to Q4 2020 year)
inflation_adjusted_IS_treatment_VGB <- IS_treatment_VGB %>% 
  mutate(year_quarter = quarter(VGB_first_treatment, with_year=TRUE)) %>%
  mutate(
    VGB_total_AWP = case_when(
  year_quarter == 2006.1 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ VGB_total_AWP*(inflation_2020_Q4/inflation_2020_Q4)),
    VGB_total_COINS = case_when(
  year_quarter == 2006.1 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ VGB_total_COINS*(inflation_2020_Q4/inflation_2020_Q4)),
    VGB_total_COPAY = case_when(
  year_quarter == 2006.1 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ VGB_total_COPAY*(inflation_2020_Q4/inflation_2020_Q4)),  
    VGB_total_DEDUCT = case_when(
  year_quarter == 2006.1 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ VGB_total_DEDUCT*(inflation_2020_Q4/inflation_2020_Q4)),  
    VGB_total_INGCOST = case_when(
  year_quarter == 2006.1 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ VGB_total_INGCOST*(inflation_2020_Q4/inflation_2020_Q4)),  
    VGB_total_NETPAY = case_when(
  year_quarter == 2006.1 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ VGB_total_NETPAY*(inflation_2020_Q4/inflation_2020_Q4)),  
    VGB_total_PAY = case_when(
  year_quarter == 2006.1 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ VGB_total_PAY*(inflation_2020_Q4/inflation_2020_Q4))
  ) %>% 
    collect()
inflation_adjusted_IS_treatment_VGB




# Normalize costs per unit and per 14 days (1125 mg per day, 15750 mg in 14 days, 500 mg per unit)
inflation_adjusted_IS_treatment_VGB <- inflation_adjusted_IS_treatment_VGB %>%
  mutate(
    VGB_AWP_per_unit = VGB_total_AWP / VGB_total_units,
    VGB_AWP_14d = VGB_AWP_per_unit * (15750/500), 
    VGB_COINS_per_unit = VGB_total_COINS / VGB_total_units,
    VGB_COINS_14d = VGB_COINS_per_unit * (15750/500), 
    VGB_COPAY_per_unit = VGB_total_COPAY / VGB_total_units,
    VGB_COPAY_14d = VGB_COPAY_per_unit * (15750/500), 
    VGB_DEDUCT_per_unit = VGB_total_DEDUCT / VGB_total_units,
    VGB_DEDUCT_14d = VGB_DEDUCT_per_unit * (15750/500), 
    VGB_INGCOST_per_unit = VGB_total_INGCOST / VGB_total_units,
    VGB_INGCOST_14d = VGB_INGCOST_per_unit * (15750/500), 
    VGB_NETPAY_per_unit = VGB_total_NETPAY / VGB_total_units,
    VGB_NETPAY_14d = VGB_NETPAY_per_unit * (15750/500),
    VGB_PAY_per_unit = VGB_total_PAY / VGB_total_units,
    VGB_PAY_14d = VGB_PAY_per_unit * (15750/500)
  ) %>% 
  mutate_if(is.numeric, list(~na_if(., Inf))) %>% 
  collect()
inflation_adjusted_IS_treatment_VGB




# Calculate values by year
IS_treatment_by_year_VGB <- inflation_adjusted_IS_treatment_VGB %>%
  group_by(year_treatment) %>% 
  mutate(
    number_patients = n(),
    
    VGB_yearly_mean_time_diagnosis_treatment = mean(VGB_time_diagnosis_treatment, na.rm=TRUE),
    VGB_yearly_SD_time_diagnosis_treatment = sd(VGB_time_diagnosis_treatment, na.rm=TRUE),
    VGB_yearly_median_time_diagnosis_treatment = median(VGB_time_diagnosis_treatment, na.rm=TRUE),
    VGB_yearly_p25_time_diagnosis_treatment = quantile(VGB_time_diagnosis_treatment, 0.25, na.rm=TRUE),
    VGB_yearly_p75_time_diagnosis_treatment = quantile(VGB_time_diagnosis_treatment, 0.75, na.rm=TRUE),
        
    VGB_yearly_mean_AWP_14d = mean(VGB_AWP_14d, na.rm=TRUE),
    VGB_yearly_SD_AWP_14d = sd(VGB_AWP_14d, na.rm=TRUE),
    VGB_yearly_median_AWP_14d = median(VGB_AWP_14d, na.rm=TRUE),
    VGB_yearly_p25_AWP_14d = quantile(VGB_AWP_14d, 0.25, na.rm=TRUE),
    VGB_yearly_p75_AWP_14d = quantile(VGB_AWP_14d, 0.75, na.rm=TRUE),
    
    VGB_yearly_mean_COINS_14d = mean(VGB_COINS_14d, na.rm=TRUE),
    VGB_yearly_SD_COINS_14d = sd(VGB_COINS_14d, na.rm=TRUE),
    VGB_yearly_median_COINS_14d = median(VGB_COINS_14d, na.rm=TRUE),
    VGB_yearly_p25_COINS_14d = quantile(VGB_COINS_14d, 0.25, na.rm=TRUE),
    VGB_yearly_p75_COINS_14d = quantile(VGB_COINS_14d, 0.75, na.rm=TRUE),    
    
    VGB_yearly_mean_COPAY_14d = mean(VGB_COPAY_14d, na.rm=TRUE),
    VGB_yearly_SD_COPAY_14d = sd(VGB_COPAY_14d, na.rm=TRUE),
    VGB_yearly_median_COPAY_14d = median(VGB_COPAY_14d, na.rm=TRUE),
    VGB_yearly_p25_COPAY_14d = quantile(VGB_COPAY_14d, 0.25, na.rm=TRUE),
    VGB_yearly_p75_COPAY_14d = quantile(VGB_COPAY_14d, 0.75, na.rm=TRUE),  
 
    VGB_yearly_mean_DEDUCT_14d = mean(VGB_DEDUCT_14d, na.rm=TRUE),
    VGB_yearly_SD_DEDUCT_14d = sd(VGB_DEDUCT_14d, na.rm=TRUE),
    VGB_yearly_median_DEDUCT_14d = median(VGB_DEDUCT_14d, na.rm=TRUE),
    VGB_yearly_p25_DEDUCT_14d = quantile(VGB_DEDUCT_14d, 0.25, na.rm=TRUE),
    VGB_yearly_p75_DEDUCT_14d = quantile(VGB_DEDUCT_14d, 0.75, na.rm=TRUE),  
       
    VGB_yearly_mean_INGCOST_14d = mean(VGB_INGCOST_14d, na.rm=TRUE),
    VGB_yearly_SD_INGCOST_14d = sd(VGB_INGCOST_14d, na.rm=TRUE),
    VGB_yearly_median_INGCOST_14d = median(VGB_INGCOST_14d, na.rm=TRUE),
    VGB_yearly_p25_INGCOST_14d = quantile(VGB_INGCOST_14d, 0.25, na.rm=TRUE),
    VGB_yearly_p75_INGCOST_14d = quantile(VGB_INGCOST_14d, 0.75, na.rm=TRUE),  

    VGB_yearly_mean_NETPAY_14d = mean(VGB_NETPAY_14d, na.rm=TRUE),
    VGB_yearly_SD_NETPAY_14d = sd(VGB_NETPAY_14d, na.rm=TRUE),
    VGB_yearly_median_NETPAY_14d = median(VGB_NETPAY_14d, na.rm=TRUE),
    VGB_yearly_p25_NETPAY_14d = quantile(VGB_NETPAY_14d, 0.25, na.rm=TRUE),
    VGB_yearly_p75_NETPAY_14d = quantile(VGB_NETPAY_14d, 0.75, na.rm=TRUE), 

    VGB_yearly_mean_PAY_14d = mean(VGB_PAY_14d, na.rm=TRUE),
    VGB_yearly_SD_PAY_14d = sd(VGB_PAY_14d, na.rm=TRUE),
    VGB_yearly_median_PAY_14d = median(VGB_PAY_14d, na.rm=TRUE),
    VGB_yearly_p25_PAY_14d = quantile(VGB_PAY_14d, 0.25, na.rm=TRUE),
    VGB_yearly_p75_PAY_14d = quantile(VGB_PAY_14d, 0.75, na.rm=TRUE)
         ) %>% 
  arrange(year_treatment) %>% 
  distinct(year_treatment, .keep_all=TRUE) %>% 
  select(year_treatment, number_patients, VGB_yearly_mean_time_diagnosis_treatment, VGB_yearly_SD_time_diagnosis_treatment, VGB_yearly_median_time_diagnosis_treatment, VGB_yearly_p25_time_diagnosis_treatment, VGB_yearly_p75_time_diagnosis_treatment, VGB_yearly_mean_AWP_14d, VGB_yearly_SD_AWP_14d, VGB_yearly_median_AWP_14d, VGB_yearly_p25_AWP_14d, VGB_yearly_p75_AWP_14d, VGB_yearly_mean_COINS_14d, VGB_yearly_SD_COINS_14d, VGB_yearly_median_COINS_14d, VGB_yearly_p25_COINS_14d, VGB_yearly_p75_COINS_14d, VGB_yearly_mean_COPAY_14d, VGB_yearly_SD_COPAY_14d, VGB_yearly_median_COPAY_14d, VGB_yearly_p25_COPAY_14d, VGB_yearly_p75_COPAY_14d, VGB_yearly_mean_DEDUCT_14d, VGB_yearly_SD_DEDUCT_14d, VGB_yearly_median_DEDUCT_14d, VGB_yearly_p25_DEDUCT_14d, VGB_yearly_p75_DEDUCT_14d, VGB_yearly_mean_INGCOST_14d, VGB_yearly_SD_INGCOST_14d, VGB_yearly_median_INGCOST_14d, VGB_yearly_p25_INGCOST_14d, VGB_yearly_p75_INGCOST_14d, VGB_yearly_mean_NETPAY_14d, VGB_yearly_SD_NETPAY_14d, VGB_yearly_median_NETPAY_14d, VGB_yearly_p25_NETPAY_14d, VGB_yearly_p75_NETPAY_14d, VGB_yearly_mean_PAY_14d, VGB_yearly_SD_PAY_14d, VGB_yearly_median_PAY_14d, VGB_yearly_p25_PAY_14d, VGB_yearly_p75_PAY_14d) %>% 
  collect()
IS_treatment_by_year_VGB
```




Prednisolone treatment
```{r}
# Characteristics of treatment with PRD
IS_treatment_PRD <- IS_first_diagnosis %>% 
  filter(ENROLID %in% !!PRD_IS_first_treatment$ENROLID) %>% 
  left_join(PRD_IS_first_treatment, by="ENROLID") %>% 
  mutate(PRD_time_diagnosis_treatment = PRD_first_treatment - first_diagnosis) %>% 
  filter(PRD_time_diagnosis_treatment >= 0 & PRD_time_diagnosis_treatment <= 60) %>% 
  collect()
IS_treatment_PRD


# Totals treatment per patient PRD
IS_total_per_patient_PRD <- PRD_IS %>% 
  filter(ENROLID %in% !!IS_treatment_PRD$ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    PRD_total_days = sumNA(DAYSUPP, na.rm=TRUE),
    PRD_total_units = sumNA(METQTY, na.rm=TRUE),
    PRD_total_AWP = sumNA(AWP, na.rm=TRUE),
    PRD_total_COINS = sumNA(COINS, na.rm=TRUE),
    PRD_total_COPAY = sumNA(COPAY, na.rm=TRUE),
    PRD_total_DEDUCT = sumNA(DEDUCT, na.rm=TRUE),
    PRD_total_INGCOST = sumNA(INGCOST, na.rm=TRUE),
    PRD_total_NETPAY = sumNA(NETPAY, na.rm=TRUE),
    PRD_total_PAY = sumNA(PAY, na.rm=TRUE)
        ) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, PRD_total_days, PRD_total_units, PRD_total_AWP, PRD_total_COINS, PRD_total_COPAY, PRD_total_DEDUCT, PRD_total_INGCOST, PRD_total_NETPAY, PRD_total_PAY) %>% 
  filter(PRD_total_days > 0)
IS_total_per_patient_PRD


# Treatment per patient PRD
IS_treatment_PRD <- IS_treatment_PRD %>% 
  left_join(IS_total_per_patient_PRD, by="ENROLID") %>% 
  mutate(year_treatment = year(PRD_first_treatment)) %>% 
  collect()
IS_treatment_PRD




# Cost adjusted for inflation (to Q4 2020 year)
inflation_adjusted_IS_treatment_PRD <- IS_treatment_PRD %>% 
  mutate(year_quarter = quarter(PRD_first_treatment, with_year=TRUE)) %>%
  mutate(
    PRD_total_AWP = case_when(
  year_quarter == 2006.1 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ PRD_total_AWP*(inflation_2020_Q4/inflation_2020_Q4)),
    PRD_total_COINS = case_when(
  year_quarter == 2006.1 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ PRD_total_COINS*(inflation_2020_Q4/inflation_2020_Q4)),
    PRD_total_COPAY = case_when(
  year_quarter == 2006.1 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ PRD_total_COPAY*(inflation_2020_Q4/inflation_2020_Q4)),  
    PRD_total_DEDUCT = case_when(
  year_quarter == 2006.1 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ PRD_total_DEDUCT*(inflation_2020_Q4/inflation_2020_Q4)),  
    PRD_total_INGCOST = case_when(
  year_quarter == 2006.1 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ PRD_total_INGCOST*(inflation_2020_Q4/inflation_2020_Q4)),  
    PRD_total_NETPAY = case_when(
  year_quarter == 2006.1 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ PRD_total_NETPAY*(inflation_2020_Q4/inflation_2020_Q4)),  
    PRD_total_PAY = case_when(
  year_quarter == 2006.1 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ PRD_total_PAY*(inflation_2020_Q4/inflation_2020_Q4))
  ) %>% 
    collect()
inflation_adjusted_IS_treatment_PRD




# Normalize costs per unit and per 14 days (60 mg per day, 840 mg per 14d, and 15 mg/5ml (3mg/ml))
inflation_adjusted_IS_treatment_PRD <- inflation_adjusted_IS_treatment_PRD %>%
  mutate(
    PRD_AWP_per_unit = PRD_total_AWP / PRD_total_units,
    PRD_AWP_14d = PRD_AWP_per_unit * (840/3), 
    PRD_COINS_per_unit = PRD_total_COINS / PRD_total_units,
    PRD_COINS_14d = PRD_COINS_per_unit * (840/3), 
    PRD_COPAY_per_unit = PRD_total_COPAY / PRD_total_units,
    PRD_COPAY_14d = PRD_COPAY_per_unit * (840/3), 
    PRD_DEDUCT_per_unit = PRD_total_DEDUCT / PRD_total_units,
    PRD_DEDUCT_14d = PRD_DEDUCT_per_unit * (840/3), 
    PRD_INGCOST_per_unit = PRD_total_INGCOST / PRD_total_units,
    PRD_INGCOST_14d = PRD_INGCOST_per_unit * (840/3), 
    PRD_NETPAY_per_unit = PRD_total_NETPAY / PRD_total_units,
    PRD_NETPAY_14d = PRD_NETPAY_per_unit * (840/3), 
    PRD_PAY_per_unit = PRD_total_PAY / PRD_total_units,
    PRD_PAY_14d = PRD_PAY_per_unit * (840/3)
  ) %>% 
  mutate_if(is.numeric, list(~na_if(., Inf))) %>% 
  collect()
inflation_adjusted_IS_treatment_PRD




# Calculate values by year
IS_treatment_by_year_PRD <- inflation_adjusted_IS_treatment_PRD %>%
  group_by(year_treatment) %>% 
  mutate(
    number_patients = n(),
    
    PRD_yearly_mean_time_diagnosis_treatment = mean(PRD_time_diagnosis_treatment, na.rm=TRUE),
    PRD_yearly_SD_time_diagnosis_treatment = sd(PRD_time_diagnosis_treatment, na.rm=TRUE),
    PRD_yearly_median_time_diagnosis_treatment = median(PRD_time_diagnosis_treatment, na.rm=TRUE),
    PRD_yearly_p25_time_diagnosis_treatment = quantile(PRD_time_diagnosis_treatment, 0.25, na.rm=TRUE),
    PRD_yearly_p75_time_diagnosis_treatment = quantile(PRD_time_diagnosis_treatment, 0.75, na.rm=TRUE),
        
    PRD_yearly_mean_AWP_14d = mean(PRD_AWP_14d, na.rm=TRUE),
    PRD_yearly_SD_AWP_14d = sd(PRD_AWP_14d, na.rm=TRUE),
    PRD_yearly_median_AWP_14d = median(PRD_AWP_14d, na.rm=TRUE),
    PRD_yearly_p25_AWP_14d = quantile(PRD_AWP_14d, 0.25, na.rm=TRUE),
    PRD_yearly_p75_AWP_14d = quantile(PRD_AWP_14d, 0.75, na.rm=TRUE),
    
    PRD_yearly_mean_COINS_14d = mean(PRD_COINS_14d, na.rm=TRUE),
    PRD_yearly_SD_COINS_14d = sd(PRD_COINS_14d, na.rm=TRUE),
    PRD_yearly_median_COINS_14d = median(PRD_COINS_14d, na.rm=TRUE),
    PRD_yearly_p25_COINS_14d = quantile(PRD_COINS_14d, 0.25, na.rm=TRUE),
    PRD_yearly_p75_COINS_14d = quantile(PRD_COINS_14d, 0.75, na.rm=TRUE),    
    
    PRD_yearly_mean_COPAY_14d = mean(PRD_COPAY_14d, na.rm=TRUE),
    PRD_yearly_SD_COPAY_14d = sd(PRD_COPAY_14d, na.rm=TRUE),
    PRD_yearly_median_COPAY_14d = median(PRD_COPAY_14d, na.rm=TRUE),
    PRD_yearly_p25_COPAY_14d = quantile(PRD_COPAY_14d, 0.25, na.rm=TRUE),
    PRD_yearly_p75_COPAY_14d = quantile(PRD_COPAY_14d, 0.75, na.rm=TRUE),  
 
    PRD_yearly_mean_DEDUCT_14d = mean(PRD_DEDUCT_14d, na.rm=TRUE),
    PRD_yearly_SD_DEDUCT_14d = sd(PRD_DEDUCT_14d, na.rm=TRUE),
    PRD_yearly_median_DEDUCT_14d = median(PRD_DEDUCT_14d, na.rm=TRUE),
    PRD_yearly_p25_DEDUCT_14d = quantile(PRD_DEDUCT_14d, 0.25, na.rm=TRUE),
    PRD_yearly_p75_DEDUCT_14d = quantile(PRD_DEDUCT_14d, 0.75, na.rm=TRUE),  
       
    PRD_yearly_mean_INGCOST_14d = mean(PRD_INGCOST_14d, na.rm=TRUE),
    PRD_yearly_SD_INGCOST_14d = sd(PRD_INGCOST_14d, na.rm=TRUE),
    PRD_yearly_median_INGCOST_14d = median(PRD_INGCOST_14d, na.rm=TRUE),
    PRD_yearly_p25_INGCOST_14d = quantile(PRD_INGCOST_14d, 0.25, na.rm=TRUE),
    PRD_yearly_p75_INGCOST_14d = quantile(PRD_INGCOST_14d, 0.75, na.rm=TRUE),  

    PRD_yearly_mean_NETPAY_14d = mean(PRD_NETPAY_14d, na.rm=TRUE),
    PRD_yearly_SD_NETPAY_14d = sd(PRD_NETPAY_14d, na.rm=TRUE),
    PRD_yearly_median_NETPAY_14d = median(PRD_NETPAY_14d, na.rm=TRUE),
    PRD_yearly_p25_NETPAY_14d = quantile(PRD_NETPAY_14d, 0.25, na.rm=TRUE),
    PRD_yearly_p75_NETPAY_14d = quantile(PRD_NETPAY_14d, 0.75, na.rm=TRUE), 

    PRD_yearly_mean_PAY_14d = mean(PRD_PAY_14d, na.rm=TRUE),
    PRD_yearly_SD_PAY_14d = sd(PRD_PAY_14d, na.rm=TRUE),
    PRD_yearly_median_PAY_14d = median(PRD_PAY_14d, na.rm=TRUE),
    PRD_yearly_p25_PAY_14d = quantile(PRD_PAY_14d, 0.25, na.rm=TRUE),
    PRD_yearly_p75_PAY_14d = quantile(PRD_PAY_14d, 0.75, na.rm=TRUE)
         ) %>% 
  arrange(year_treatment) %>% 
  distinct(year_treatment, .keep_all=TRUE) %>% 
  select(year_treatment, number_patients, PRD_yearly_mean_time_diagnosis_treatment, PRD_yearly_SD_time_diagnosis_treatment, PRD_yearly_median_time_diagnosis_treatment, PRD_yearly_p25_time_diagnosis_treatment, PRD_yearly_p75_time_diagnosis_treatment, PRD_yearly_mean_AWP_14d, PRD_yearly_SD_AWP_14d, PRD_yearly_median_AWP_14d, PRD_yearly_p25_AWP_14d, PRD_yearly_p75_AWP_14d, PRD_yearly_mean_COINS_14d, PRD_yearly_SD_COINS_14d, PRD_yearly_median_COINS_14d, PRD_yearly_p25_COINS_14d, PRD_yearly_p75_COINS_14d, PRD_yearly_mean_COPAY_14d, PRD_yearly_SD_COPAY_14d, PRD_yearly_median_COPAY_14d, PRD_yearly_p25_COPAY_14d, PRD_yearly_p75_COPAY_14d, PRD_yearly_mean_DEDUCT_14d, PRD_yearly_SD_DEDUCT_14d, PRD_yearly_median_DEDUCT_14d, PRD_yearly_p25_DEDUCT_14d, PRD_yearly_p75_DEDUCT_14d, PRD_yearly_mean_INGCOST_14d, PRD_yearly_SD_INGCOST_14d, PRD_yearly_median_INGCOST_14d, PRD_yearly_p25_INGCOST_14d, PRD_yearly_p75_INGCOST_14d, PRD_yearly_mean_NETPAY_14d, PRD_yearly_SD_NETPAY_14d, PRD_yearly_median_NETPAY_14d, PRD_yearly_p25_NETPAY_14d, PRD_yearly_p75_NETPAY_14d, PRD_yearly_mean_PAY_14d, PRD_yearly_SD_PAY_14d, PRD_yearly_median_PAY_14d, PRD_yearly_p25_PAY_14d, PRD_yearly_p75_PAY_14d) %>% 
  collect()
IS_treatment_by_year_PRD
```




Age in months
```{r}
## Age
#################################2006#################################
month_of_birth_2006 <- ms_t_2006 %>% 
  filter(
    ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID
           ) %>% 
  filter(DOBYR==2006) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  select(ENROLID, DTSTART) %>% 
  collect() %>% 
  mutate(across(DTSTART, mdy)) %>% 
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE)


#################################2007#################################
month_of_birth_2007 <- ms_t_2007 %>% 
  filter(
    ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID
           ) %>% 
  filter(DOBYR==2007) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  select(ENROLID, DTSTART) %>% 
  collect() %>% 
  mutate(across(DTSTART, mdy)) %>% 
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE)


#################################2008#################################
month_of_birth_2008 <- ms_t_2008 %>% 
  filter(
    ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID
           ) %>% 
  filter(DOBYR==2008) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  select(ENROLID, DTSTART) %>% 
  collect() %>% 
  mutate(across(DTSTART, mdy)) %>% 
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE)


#################################2009#################################
month_of_birth_2009 <- ms_t_2009 %>% 
  filter(
    ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID
           ) %>% 
  filter(DOBYR==2009) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  select(ENROLID, DTSTART) %>% 
  collect() %>% 
  mutate(across(DTSTART, mdy)) %>% 
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE)


#################################2010#################################
month_of_birth_2010 <- ms_t_2010 %>% 
  filter(
    ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID
           ) %>% 
  filter(DOBYR==2010) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  select(ENROLID, DTSTART) %>% 
  collect() %>% 
  mutate(across(DTSTART, mdy)) %>% 
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE)


#################################2011#################################
month_of_birth_2011 <- ms_t_2011 %>% 
  filter(
    ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID
           ) %>% 
  filter(DOBYR==2011) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  select(ENROLID, DTSTART) %>% 
  collect() %>% 
  mutate(across(DTSTART, mdy)) %>% 
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE)


#################################2012#################################
month_of_birth_2012 <- ms_t_2012 %>% 
  filter(
    ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID
           ) %>% 
  filter(DOBYR==2012) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  select(ENROLID, DTSTART) %>% 
  collect() %>% 
  mutate(across(DTSTART, mdy)) %>% 
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE)


#################################2013#################################
month_of_birth_2013 <- ms_t_2013 %>% 
  filter(
    ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID
           ) %>% 
  filter(DOBYR==2013) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  select(ENROLID, DTSTART) %>% 
  collect() %>% 
  mutate(across(DTSTART, mdy)) %>% 
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE)


#################################2014#################################
month_of_birth_2014 <- ms_t_2014 %>% 
  filter(
    ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID
           ) %>% 
  filter(DOBYR==2014) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  select(ENROLID, DTSTART) %>% 
  collect() %>% 
  mutate(across(DTSTART, mdy)) %>% 
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE)


#################################2015#################################
month_of_birth_2015 <- ms_t_2015 %>% 
  filter(
    ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID
           ) %>% 
  filter(DOBYR==2015) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  select(ENROLID, DTSTART) %>% 
  collect() %>% 
  mutate(across(DTSTART, mdy)) %>% 
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE)


#################################2016#################################
month_of_birth_2016 <- ms_t_2016 %>% 
  filter(
    ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID
           ) %>% 
  filter(DOBYR==2016) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  select(ENROLID, DTSTART) %>% 
  collect() %>% 
  mutate(across(DTSTART, mdy)) %>% 
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE)


#################################2017#################################
month_of_birth_2017 <- ms_t_2017 %>% 
  filter(
    ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID
           ) %>% 
  filter(DOBYR==2017) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  select(ENROLID, DTSTART) %>% 
  collect() %>% 
  mutate(across(DTSTART, mdy)) %>% 
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE)


#################################2018#################################
month_of_birth_2018 <- ms_t_2018 %>% 
  filter(
    ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID
           ) %>% 
  filter(DOBYR==2018) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  select(ENROLID, DTSTART) %>% 
  collect() %>% 
  mutate(across(DTSTART, mdy)) %>% 
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE)


#################################2019#################################
month_of_birth_2019 <- ms_t_2019 %>% 
  filter(
    ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID
           ) %>% 
  filter(DOBYR==2019) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  select(ENROLID, DTSTART) %>% 
  collect() %>% 
  mutate(across(DTSTART, mdy)) %>% 
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE)


#################################2020#################################
month_of_birth_2020 <- ms_t_2020 %>% 
  filter(
    ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID |
    ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID
           ) %>% 
  filter(DOBYR==2020) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  select(ENROLID, DTSTART) %>% 
  collect() %>% 
  mutate(across(DTSTART, mdy)) %>% 
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE)




# Month of birth
month_of_birth <- bind_rows(month_of_birth_2006, month_of_birth_2007, month_of_birth_2008, month_of_birth_2009, month_of_birth_2010, month_of_birth_2011, month_of_birth_2012, month_of_birth_2013, month_of_birth_2014, month_of_birth_2015, month_of_birth_2016, month_of_birth_2017, month_of_birth_2018, month_of_birth_2019, month_of_birth_2020) %>% 
  collect()




# Add age to the ACTH data
inflation_adjusted_IS_treatment_ACTH <- inflation_adjusted_IS_treatment_ACTH %>% 
  left_join(month_of_birth, by = "ENROLID") %>% 
  mutate(age_months_at_diagnosis = first_diagnosis - DTSTART) %>% 
  mutate(across(age_months_at_diagnosis, as.numeric)) %>% 
  mutate(age_months_at_diagnosis = age_months_at_diagnosis / 30.4167) %>% 
  filter(age_months_at_diagnosis <= 18 | is.na(age_months_at_diagnosis)) %>% 
  collect()


# Add age to the vigabatrin data
inflation_adjusted_IS_treatment_VGB <- inflation_adjusted_IS_treatment_VGB %>% 
  left_join(month_of_birth, by = "ENROLID") %>% 
  mutate(age_months_at_diagnosis = first_diagnosis - DTSTART) %>% 
  mutate(across(age_months_at_diagnosis, as.numeric)) %>% 
  mutate(age_months_at_diagnosis = age_months_at_diagnosis / 30.4167) %>% 
  filter(age_months_at_diagnosis <= 18 | is.na(age_months_at_diagnosis)) %>% 
  collect()


# Add age to the oral prednisolone data
inflation_adjusted_IS_treatment_PRD <- inflation_adjusted_IS_treatment_PRD %>% 
  left_join(month_of_birth, by = "ENROLID") %>% 
  mutate(age_months_at_diagnosis = first_diagnosis - DTSTART) %>% 
  mutate(across(age_months_at_diagnosis, as.numeric)) %>% 
  mutate(age_months_at_diagnosis = age_months_at_diagnosis / 30.4167) %>% 
  filter(age_months_at_diagnosis <= 18 | is.na(age_months_at_diagnosis)) %>% 
  collect()
```








## 4. Demographic and clinical features




Basic demographic features
```{r}
## Total number of patients
total_patients <- bind_rows(inflation_adjusted_IS_treatment_ACTH, inflation_adjusted_IS_treatment_VGB, inflation_adjusted_IS_treatment_PRD) %>% distinct(ENROLID, .keep_all=TRUE)
# Number of patients
n_patients <- total_patients %>% nrow()
n_patients
# Age
summary(total_patients$age_months_at_diagnosis)
sd(total_patients$age_months_at_diagnosis, na.rm=TRUE)
# Sex
CrossTable(total_patients$SEX)
# Patients with TSC
n_total_patients_TSC <- total_patients %>% filter(ENROLID %in% !!TSC$ENROLID) %>% distinct(ENROLID) %>% nrow()
n_total_patients_TSC
n_total_patients_TSC/n_patients


## ACTH
# Number of patients
n_patients_ACTH <- inflation_adjusted_IS_treatment_ACTH %>% distinct(ENROLID) %>% nrow()
n_patients_ACTH
# Age
summary(inflation_adjusted_IS_treatment_ACTH$age_months_at_diagnosis)
sd(inflation_adjusted_IS_treatment_ACTH$age_months_at_diagnosis, na.rm=TRUE)
# Sex
CrossTable(inflation_adjusted_IS_treatment_ACTH$SEX)
# ACTH with TSC
n_patients_ACTH_TSC <- inflation_adjusted_IS_treatment_ACTH %>% filter(ENROLID %in% !!TSC$ENROLID) %>% distinct(ENROLID) %>% nrow()
n_patients_ACTH_TSC
n_patients_ACTH_TSC/n_patients_ACTH


## VGB
# Number of patients
n_patients_VGB <- inflation_adjusted_IS_treatment_VGB %>% distinct(ENROLID) %>% nrow()
n_patients_VGB
# Age
summary(inflation_adjusted_IS_treatment_VGB$age_months_at_diagnosis)
sd(inflation_adjusted_IS_treatment_VGB$age_months_at_diagnosis, na.rm=TRUE)
# Sex
CrossTable(inflation_adjusted_IS_treatment_VGB$SEX)
# VGB with TSC
n_patients_VGB_TSC <- inflation_adjusted_IS_treatment_VGB %>% filter(ENROLID %in% !!TSC$ENROLID) %>% distinct(ENROLID) %>% nrow()
n_patients_VGB_TSC
n_patients_VGB_TSC/n_patients_VGB


## PRD
# Number of patients
n_patients_PRD <- inflation_adjusted_IS_treatment_PRD %>% distinct(ENROLID) %>% nrow()
n_patients_PRD
# Age
summary(inflation_adjusted_IS_treatment_PRD$age_months_at_diagnosis)
sd(inflation_adjusted_IS_treatment_PRD$age_months_at_diagnosis, na.rm=TRUE)
# Sex
CrossTable(inflation_adjusted_IS_treatment_PRD$SEX)
# PRD with TSC
n_patients_PRD_TSC <- inflation_adjusted_IS_treatment_PRD %>% filter(ENROLID %in% !!TSC$ENROLID) %>% distinct(ENROLID) %>% nrow()
n_patients_PRD_TSC
n_patients_PRD_TSC/n_patients_PRD


## ACTH with VGB
n_patients_ACTH_VGB <- inflation_adjusted_IS_treatment_ACTH %>% distinct(ENROLID) %>% filter(ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID) %>% filter(!(ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID)) %>% nrow()
n_patients_ACTH_VGB

## ACTH with PRD
n_patients_ACTH_PRD <- inflation_adjusted_IS_treatment_ACTH %>% distinct(ENROLID) %>% filter(ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID) %>% filter(!(ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID)) %>% nrow()
n_patients_ACTH_PRD

## VGB with PRD
n_patients_VGB_PRD <- inflation_adjusted_IS_treatment_VGB %>% distinct(ENROLID) %>% filter(ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID) %>% filter(!(ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID)) %>% nrow()
n_patients_VGB_PRD

## ACTH with VGB with PRD
n_patients_ACTH_VGB_PRD <- inflation_adjusted_IS_treatment_ACTH %>% distinct(ENROLID) %>% filter(ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID) %>% filter(ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID) %>% nrow()
n_patients_ACTH_VGB_PRD
```








## 5. Main outcomes




Secular trends in cost of treatment of infantile spasms
```{r}
# Data on secular trends
IS_cost_evolution <- IS_treatment_by_year_ACTH[ , c("year_treatment", "ACTH_yearly_mean_AWP_14d", "ACTH_yearly_SD_AWP_14d", "ACTH_yearly_median_AWP_14d", "ACTH_yearly_p25_AWP_14d", "ACTH_yearly_p75_AWP_14d", "ACTH_yearly_mean_NETPAY_14d", "ACTH_yearly_SD_NETPAY_14d", "ACTH_yearly_median_NETPAY_14d", "ACTH_yearly_p25_NETPAY_14d", "ACTH_yearly_p75_NETPAY_14d")] %>%
  left_join(IS_treatment_by_year_VGB[ , c("year_treatment", "VGB_yearly_mean_AWP_14d", "VGB_yearly_SD_AWP_14d", "VGB_yearly_median_AWP_14d", "VGB_yearly_p25_AWP_14d", "VGB_yearly_p75_AWP_14d", "VGB_yearly_mean_NETPAY_14d", "VGB_yearly_SD_NETPAY_14d", "VGB_yearly_median_NETPAY_14d", "VGB_yearly_p25_NETPAY_14d", "VGB_yearly_p75_NETPAY_14d")]) %>% 
  left_join(IS_treatment_by_year_PRD[ , c("year_treatment", "PRD_yearly_mean_AWP_14d", "PRD_yearly_SD_AWP_14d", "PRD_yearly_median_AWP_14d", "PRD_yearly_p25_AWP_14d", "PRD_yearly_p75_AWP_14d", "PRD_yearly_mean_NETPAY_14d", "PRD_yearly_SD_NETPAY_14d", "PRD_yearly_median_NETPAY_14d", "PRD_yearly_p25_NETPAY_14d", "PRD_yearly_p75_NETPAY_14d")]) %>% 
  mutate_all(~replace_na(., 0)) %>% 
  collect()
IS_cost_evolution 


# Plot AWP
plot_IS_cost_AWP_evolution <- ggplot(data=IS_cost_evolution) + 
  geom_line(aes(x=year_treatment, y=ACTH_yearly_median_AWP_14d), color="#0076c0", lwd=1.75) +
  annotate("text", x=2018, y=90000, size=8, label= "ACTH", color="#0076c0") +
  geom_line(aes(x=year_treatment, y=VGB_yearly_median_AWP_14d), color="#67771a", lwd=1.75) +
  annotate("text", x=2017, y=10000, size=8, label= "VGB", color="#67771a") +
  geom_line(aes(x=year_treatment, y=PRD_yearly_median_AWP_14d), color="#a30234", lwd=1.75) + 
  annotate("text", x=2008, y=5000, size=8, label= "PRD", color="#a30234") +
  theme(text=element_text(family="Calibri"), legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2020) +
  scale_y_continuous(name="Median cost ($) per 14-day treatment") 
plot_IS_cost_AWP_evolution 


# Plot NETPAY
plot_IS_cost_NETPAY_evolution <- ggplot(data=IS_cost_evolution) + 
  geom_line(aes(x=year_treatment, y=ACTH_yearly_median_NETPAY_14d), color="#0076c0", lwd=1.75) +
  annotate("text", x=2018, y=75000, size=8, label= "ACTH", color="#0076c0") +
  geom_line(aes(x=year_treatment, y=VGB_yearly_median_NETPAY_14d), color="#67771a", lwd=1.75) +
  annotate("text", x=2017, y=8000, size=8, label= "VGB", color="#67771a") +
  geom_line(aes(x=year_treatment, y=PRD_yearly_median_NETPAY_14d), color="#a30234", lwd=1.75) +
  annotate("text", x=2008, y=4000, size=8, label= "PRD", color="#a30234") +
  theme(text=element_text(family="Calibri"), legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2020) +
  scale_y_continuous(name="Median cost ($) per 14-day treatment")
plot_IS_cost_NETPAY_evolution 
```




Cost of inpatient admission
```{r}
# Inpatient ACTH
IS_inpatient_ACTH <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID) %>% 
  filter(type=="inpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(60))) %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  group_by(ENROLID) %>% 
  mutate(total_LOS=sumNA(LOS, na.rm=TRUE), total_cost=sumNA(cost, na.rm=TRUE)) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_LOS = if_else(is.na(total_LOS), 0, total_LOS)) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  collect()
IS_inpatient_ACTH


IS_inpatient_ACTH_epilepsy_encounter <- IS_inpatient_ACTH %>% 
  filter(epilepsy_encounter==1) 
IS_inpatient_ACTH_epilepsy_encounter

# Total days of hospital admission
sum(IS_inpatient_ACTH$total_LOS)
sum(IS_inpatient_ACTH_epilepsy_encounter$total_LOS)
sum(IS_inpatient_ACTH_epilepsy_encounter$total_LOS) / sum(IS_inpatient_ACTH$total_LOS)

# Days of admission
summary(IS_inpatient_ACTH$total_LOS)
sd(IS_inpatient_ACTH$total_LOS, na.rm=TRUE)

# Cost of inpatient admission
summary(IS_inpatient_ACTH$total_cost)
sd(IS_inpatient_ACTH$total_cost, na.rm=TRUE)



# Inpatient VGB
IS_inpatient_VGB <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID) %>% 
  filter(type=="inpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(60))) %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  group_by(ENROLID) %>% 
  mutate(total_LOS=sumNA(LOS, na.rm=TRUE), total_cost=sumNA(cost, na.rm=TRUE)) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_LOS = if_else(is.na(total_LOS), 0, total_LOS)) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  collect()
IS_inpatient_VGB


IS_inpatient_VGB_epilepsy_encounter <- IS_inpatient_VGB %>% 
  filter(epilepsy_encounter==1) 
IS_inpatient_VGB_epilepsy_encounter

# Total days of hospital admission
sum(IS_inpatient_VGB$total_LOS)
sum(IS_inpatient_VGB_epilepsy_encounter$total_LOS)
sum(IS_inpatient_VGB_epilepsy_encounter$total_LOS) / sum(IS_inpatient_VGB$total_LOS)


# Days of admission
summary(IS_inpatient_VGB$total_LOS)
sd(IS_inpatient_VGB$total_LOS, na.rm=TRUE)

# Cost of inpatient admission
summary(IS_inpatient_VGB$total_cost)
sd(IS_inpatient_VGB$total_cost, na.rm=TRUE)




# Inpatient PRD
IS_inpatient_PRD <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID) %>% 
  filter(type=="inpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(60))) %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  group_by(ENROLID) %>% 
  mutate(total_LOS=sumNA(LOS, na.rm=TRUE), total_cost=sumNA(cost, na.rm=TRUE)) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_LOS = if_else(is.na(total_LOS), 0, total_LOS)) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  collect()
IS_inpatient_PRD


IS_inpatient_PRD_epilepsy_encounter <- IS_inpatient_PRD %>% 
  filter(epilepsy_encounter==1) 
IS_inpatient_PRD_epilepsy_encounter

# Total days of hospital admission
sum(IS_inpatient_PRD$total_LOS)
sum(IS_inpatient_PRD_epilepsy_encounter$total_LOS)
sum(IS_inpatient_PRD_epilepsy_encounter$total_LOS) / sum(IS_inpatient_PRD$total_LOS)



# Days of admission
summary(IS_inpatient_PRD$total_LOS)
sd(IS_inpatient_PRD$total_LOS, na.rm=TRUE)

# Cost of inpatient admission
summary(IS_inpatient_PRD$total_cost)
sd(IS_inpatient_PRD$total_cost, na.rm=TRUE)




# Kruskal-Wallis test total LOS
kruskal_total_LOS_p_value <- kruskal.test(list(IS_inpatient_ACTH$total_LOS, IS_inpatient_VGB$total_LOS, IS_inpatient_PRD$total_LOS))$p.value
kruskal_total_LOS_p_value

# Kruskal-Wallis test cost
kruskal_total_inpatient_cost_p_value <- kruskal.test(list(IS_inpatient_ACTH$total_cost, IS_inpatient_VGB$total_cost, IS_inpatient_PRD$total_cost))$p.value
kruskal_total_inpatient_cost_p_value
```




Number and cost of emergency department
```{r}
# Emergency ACTH
IS_emergency_ACTH <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID) %>% 
  filter(type=="emergency") %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(60))) %>%
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits, epilepsy_encounter) %>% 
  collect()
IS_emergency_ACTH


IS_emergency_ACTH_epilepsy_encounter <- IS_emergency_ACTH %>% 
  filter(epilepsy_encounter==1) 
IS_emergency_ACTH_epilepsy_encounter

# Total ED visits
sum(IS_emergency_ACTH$total_visits)
sum(IS_emergency_ACTH_epilepsy_encounter$total_visits)
sum(IS_emergency_ACTH_epilepsy_encounter$total_visits) / sum(IS_emergency_ACTH$total_visits)


# Number of emergency visits
summary(IS_emergency_ACTH$total_visits)
sd(IS_emergency_ACTH$total_visits, na.rm=TRUE)

# Cost of emergency
summary(IS_emergency_ACTH$total_cost)
sd(IS_emergency_ACTH$total_cost, na.rm=TRUE)




# Emergency VGB
IS_emergency_VGB <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID) %>% 
  filter(type=="emergency") %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(60))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits, epilepsy_encounter) %>% 
  collect()
IS_emergency_VGB

IS_emergency_VGB_epilepsy_encounter <- IS_emergency_VGB %>% 
  filter(epilepsy_encounter==1) 
IS_emergency_VGB_epilepsy_encounter

# Total ED visits
sum(IS_emergency_VGB$total_visits)
sum(IS_emergency_VGB_epilepsy_encounter$total_visits)
sum(IS_emergency_VGB_epilepsy_encounter$total_visits) / sum(IS_emergency_VGB$total_visits)


# Number of emergency visits
summary(IS_emergency_VGB$total_visits)
sd(IS_emergency_VGB$total_visits, na.rm=TRUE)

# Cost of emergency
summary(IS_emergency_VGB$total_cost)
sd(IS_emergency_VGB$total_cost, na.rm=TRUE)




# Emergency PRD
IS_emergency_PRD <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID) %>% 
  filter(type=="emergency") %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(60))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits, epilepsy_encounter) %>% 
  collect()
IS_emergency_PRD

IS_emergency_PRD_epilepsy_encounter <- IS_emergency_PRD %>% 
  filter(epilepsy_encounter==1) 
IS_emergency_PRD_epilepsy_encounter

# Total ED visits
sum(IS_emergency_PRD$total_visits)
sum(IS_emergency_PRD_epilepsy_encounter$total_visits)
sum(IS_emergency_PRD_epilepsy_encounter$total_visits) / sum(IS_emergency_PRD$total_visits)

# Number of emergency visits
summary(IS_emergency_PRD$total_visits)
sd(IS_emergency_PRD$total_visits, na.rm=TRUE)

# Cost of emergency
summary(IS_emergency_PRD$total_cost)
sd(IS_emergency_PRD$total_cost, na.rm=TRUE)




# Kruskal-Wallis test visits
kruskal_ED_visits_p_value <- kruskal.test(list(IS_emergency_ACTH$total_visits, IS_emergency_VGB$total_visits, IS_emergency_PRD$total_visits))$p.value
kruskal_ED_visits_p_value

# Kruskal-Wallis test cost
kruskal_total_ED_cost_p_value <- kruskal.test(list(IS_emergency_ACTH$total_cost, IS_emergency_VGB$total_cost, IS_emergency_PRD$total_cost))$p.value
kruskal_total_ED_cost_p_value
```




Outpatient costs
```{r}
# Outpatient ACTH
IS_outpatient_ACTH <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID) %>% 
  filter(type=="outpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(60))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits) %>% 
  collect()
IS_outpatient_ACTH

# Number of outpatient visits
summary(IS_outpatient_ACTH$total_visits)
sd(IS_outpatient_ACTH$total_visits, na.rm=TRUE)

# Cost of outpatient
summary(IS_outpatient_ACTH$total_cost)
sd(IS_outpatient_ACTH$total_cost, na.rm=TRUE)




# Outpatient VGB
IS_outpatient_VGB <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID) %>% 
  filter(type=="outpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(60))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits) %>% 
  collect()
IS_outpatient_VGB

# Number of outpatient visits
summary(IS_outpatient_VGB$total_visits)
sd(IS_outpatient_VGB$total_visits, na.rm=TRUE)

# Cost of outpatient
summary(IS_outpatient_VGB$total_cost)
sd(IS_outpatient_VGB$total_cost, na.rm=TRUE)




# Outpatient PRD
IS_outpatient_PRD <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID) %>% 
  filter(type=="outpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(60))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits) %>% 
  collect()
IS_outpatient_PRD

# Number of outpatient visits
summary(IS_outpatient_PRD$total_visits)
sd(IS_outpatient_PRD$total_visits, na.rm=TRUE)

# Cost of outpatient
summary(IS_outpatient_PRD$total_cost)
sd(IS_outpatient_PRD$total_cost, na.rm=TRUE)




# Kruskal-Wallis test visits
kruskal_total_outpatient_visits_p_value <- kruskal.test(list(IS_outpatient_ACTH$total_visits, IS_outpatient_VGB$total_visits, IS_outpatient_PRD$total_visits))$p.value
kruskal_total_outpatient_visits_p_value

# Kruskal-Wallis test cost
kruskal_total_outpatient_cost_p_value <- kruskal.test(list(IS_outpatient_ACTH$total_cost, IS_outpatient_VGB$total_cost, IS_outpatient_PRD$total_cost))$p.value
kruskal_total_outpatient_cost_p_value
```




Secular trends in treatment of infantile spasms
```{r}
# Data on secular trends
IS_treatment_evolution <- IS_treatment_by_year_ACTH[ , c("year_treatment", "number_patients")] %>%
  rename(number_patients_ACTH = number_patients) %>% 
  left_join(IS_treatment_by_year_VGB[ , c("year_treatment", "number_patients")], by="year_treatment") %>% rename(number_patients_VGB = number_patients) %>% 
  left_join(IS_treatment_by_year_PRD[ , c("year_treatment", "number_patients")], by="year_treatment") %>% rename(number_patients_PRD = number_patients) %>% 
  mutate_all(~replace_na(., 0)) %>% 
  mutate(
    total_treatments = number_patients_ACTH + number_patients_VGB + number_patients_PRD,
    proportion_ACTH = number_patients_ACTH / total_treatments,
    proportion_VGB = number_patients_VGB / total_treatments,
    proportion_PRD = number_patients_PRD / total_treatments
  )
IS_treatment_evolution


# Jonckheere Terpstra test
jonckheere_ACTH_trend_p_value <- JonckheereTerpstraTest(proportion_ACTH ~ year_treatment, data=IS_treatment_evolution, alternative="decreasing")$p.value
jonckheere_ACTH_trend_p_value

jonckheere_ACTH_trend_p_value_no_2020 <- JonckheereTerpstraTest(proportion_ACTH ~ year_treatment, data=IS_treatment_evolution[1:14, ], alternative="decreasing")$p.value
jonckheere_ACTH_trend_p_value_no_2020
  
  
# Plot secular trends use
plot_IS_treatment_evolution <- ggplot(data=IS_treatment_evolution) + 
  geom_line(aes(x=year_treatment, y=proportion_ACTH), color="#0076c0", lwd=1.5) + 
  geom_line(aes(x=year_treatment, y=proportion_VGB), color="#67771a", lwd=1.5) + 
  geom_line(aes(x=year_treatment, y=proportion_PRD), color="#a30234", lwd=1.5) +   
  theme(text=element_text(family="Calibri"), legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2020) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0,1))
plot_IS_treatment_evolution
```








## 6 Sensitivity analysis: Use of only one medication




Basic demographic features
```{r}
## ACTH one medication
ACTH_one_medication <- inflation_adjusted_IS_treatment_ACTH %>% distinct(ENROLID) %>% filter(!(ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID)) %>% filter(!(ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID))
ACTH_one_medication

## VGB one medication
VGB_one_medication <- inflation_adjusted_IS_treatment_VGB %>% distinct(ENROLID) %>% filter(!(ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID)) %>% filter(!(ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID))
VGB_one_medication

## PRD one medication
PRD_one_medication <- inflation_adjusted_IS_treatment_PRD %>% distinct(ENROLID) %>% filter(!(ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID)) %>% filter(!(ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID))
PRD_one_medication

## Only one medication
one_medication <- rbind(ACTH_one_medication, VGB_one_medication, PRD_one_medication)
one_medication


## Total number of patients
total_patients_one_medication <- bind_rows(inflation_adjusted_IS_treatment_ACTH, inflation_adjusted_IS_treatment_VGB, inflation_adjusted_IS_treatment_PRD) %>% distinct(ENROLID, .keep_all=TRUE) %>% filter(ENROLID %in% !!one_medication$ENROLID)
# Number of patients
n_patients_one_medication <- total_patients_one_medication %>% nrow()
n_patients_one_medication
# Age
summary(total_patients_one_medication$age_months_at_diagnosis)
sd(total_patients_one_medication$age_months_at_diagnosis, na.rm=TRUE)
# Sex
CrossTable(total_patients_one_medication$SEX)
# Patients with TSC
n_total_patients_TSC_one_medication <- total_patients_one_medication %>% filter(ENROLID %in% !!TSC$ENROLID) %>% distinct(ENROLID) %>% nrow()
n_total_patients_TSC_one_medication
n_total_patients_TSC_one_medication/n_patients_one_medication


## ACTH
patients_ACTH_one_medication <- inflation_adjusted_IS_treatment_ACTH %>% distinct(ENROLID, .keep_all=TRUE) %>% filter(ENROLID %in% !!one_medication$ENROLID)
# Number of patients
n_patients_ACTH_one_medication <- patients_ACTH_one_medication %>% nrow()
n_patients_ACTH_one_medication
# Age
summary(patients_ACTH_one_medication$age_months_at_diagnosis)
sd(patients_ACTH_one_medication$age_months_at_diagnosis, na.rm=TRUE)
# Sex
CrossTable(patients_ACTH_one_medication$SEX)
# ACTH with TSC
n_patients_ACTH_TSC_one_medication <- patients_ACTH_one_medication %>% filter(ENROLID %in% !!TSC$ENROLID) %>% distinct(ENROLID) %>% nrow()
n_patients_ACTH_TSC_one_medication
n_patients_ACTH_TSC_one_medication/n_patients_ACTH_one_medication


## VGB
patients_VGB_one_medication <- inflation_adjusted_IS_treatment_VGB %>% distinct(ENROLID, .keep_all=TRUE) %>% filter(ENROLID %in% !!one_medication$ENROLID)
# Number of patients
n_patients_VGB_one_medication <- patients_VGB_one_medication %>% nrow()
n_patients_VGB_one_medication
# Age
summary(patients_VGB_one_medication$age_months_at_diagnosis)
sd(patients_VGB_one_medication$age_months_at_diagnosis, na.rm=TRUE)
# Sex
CrossTable(patients_VGB_one_medication$SEX)
# VGB with TSC
n_patients_VGB_TSC_one_medication <- patients_VGB_one_medication %>% filter(ENROLID %in% !!TSC$ENROLID) %>% distinct(ENROLID) %>% nrow()
n_patients_VGB_TSC_one_medication
n_patients_VGB_TSC_one_medication/n_patients_VGB_one_medication


## PRD
patients_PRD_one_medication <- inflation_adjusted_IS_treatment_PRD %>% distinct(ENROLID, .keep_all=TRUE) %>% filter(ENROLID %in% !!one_medication$ENROLID)
# Number of patients
n_patients_PRD_one_medication <- patients_PRD_one_medication %>% nrow()
n_patients_PRD_one_medication
# Age
summary(patients_PRD_one_medication$age_months_at_diagnosis)
sd(patients_PRD_one_medication$age_months_at_diagnosis, na.rm=TRUE)
# Sex
CrossTable(patients_PRD_one_medication$SEX)
# PRD with TSC
n_patients_PRD_TSC_one_medication <- patients_PRD_one_medication %>% filter(ENROLID %in% !!TSC$ENROLID) %>% distinct(ENROLID) %>% nrow()
n_patients_PRD_TSC_one_medication
n_patients_PRD_TSC_one_medication/n_patients_PRD_one_medication
```




Secular trends in cost of treatment of infantile spasms
```{r}
# Calculate values by year
IS_treatment_by_year_ACTH_one_medication <- inflation_adjusted_IS_treatment_ACTH %>%
  filter(ENROLID %in% !!one_medication$ENROLID) %>% 
  group_by(year_treatment) %>% 
  mutate(
    number_patients = n(),
    
    ACTH_yearly_mean_time_diagnosis_treatment = mean(ACTH_time_diagnosis_treatment, na.rm=TRUE),
    ACTH_yearly_SD_time_diagnosis_treatment = sd(ACTH_time_diagnosis_treatment, na.rm=TRUE),
    ACTH_yearly_median_time_diagnosis_treatment = median(ACTH_time_diagnosis_treatment, na.rm=TRUE),
    ACTH_yearly_p25_time_diagnosis_treatment = quantile(ACTH_time_diagnosis_treatment, 0.25, na.rm=TRUE),
    ACTH_yearly_p75_time_diagnosis_treatment = quantile(ACTH_time_diagnosis_treatment, 0.75, na.rm=TRUE),
        
    ACTH_yearly_mean_AWP_14d = mean(ACTH_AWP_14d, na.rm=TRUE),
    ACTH_yearly_SD_AWP_14d = sd(ACTH_AWP_14d, na.rm=TRUE),
    ACTH_yearly_median_AWP_14d = median(ACTH_AWP_14d, na.rm=TRUE),
    ACTH_yearly_p25_AWP_14d = quantile(ACTH_AWP_14d, 0.25, na.rm=TRUE),
    ACTH_yearly_p75_AWP_14d = quantile(ACTH_AWP_14d, 0.75, na.rm=TRUE),
    
    ACTH_yearly_mean_COINS_14d = mean(ACTH_COINS_14d, na.rm=TRUE),
    ACTH_yearly_SD_COINS_14d = sd(ACTH_COINS_14d, na.rm=TRUE),
    ACTH_yearly_median_COINS_14d = median(ACTH_COINS_14d, na.rm=TRUE),
    ACTH_yearly_p25_COINS_14d = quantile(ACTH_COINS_14d, 0.25, na.rm=TRUE),
    ACTH_yearly_p75_COINS_14d = quantile(ACTH_COINS_14d, 0.75, na.rm=TRUE),    
    
    ACTH_yearly_mean_COPAY_14d = mean(ACTH_COPAY_14d, na.rm=TRUE),
    ACTH_yearly_SD_COPAY_14d = sd(ACTH_COPAY_14d, na.rm=TRUE),
    ACTH_yearly_median_COPAY_14d = median(ACTH_COPAY_14d, na.rm=TRUE),
    ACTH_yearly_p25_COPAY_14d = quantile(ACTH_COPAY_14d, 0.25, na.rm=TRUE),
    ACTH_yearly_p75_COPAY_14d = quantile(ACTH_COPAY_14d, 0.75, na.rm=TRUE),  
 
    ACTH_yearly_mean_DEDUCT_14d = mean(ACTH_DEDUCT_14d, na.rm=TRUE),
    ACTH_yearly_SD_DEDUCT_14d = sd(ACTH_DEDUCT_14d, na.rm=TRUE),
    ACTH_yearly_median_DEDUCT_14d = median(ACTH_DEDUCT_14d, na.rm=TRUE),
    ACTH_yearly_p25_DEDUCT_14d = quantile(ACTH_DEDUCT_14d, 0.25, na.rm=TRUE),
    ACTH_yearly_p75_DEDUCT_14d = quantile(ACTH_DEDUCT_14d, 0.75, na.rm=TRUE),  
       
    ACTH_yearly_mean_INGCOST_14d = mean(ACTH_INGCOST_14d, na.rm=TRUE),
    ACTH_yearly_SD_INGCOST_14d = sd(ACTH_INGCOST_14d, na.rm=TRUE),
    ACTH_yearly_median_INGCOST_14d = median(ACTH_INGCOST_14d, na.rm=TRUE),
    ACTH_yearly_p25_INGCOST_14d = quantile(ACTH_INGCOST_14d, 0.25, na.rm=TRUE),
    ACTH_yearly_p75_INGCOST_14d = quantile(ACTH_INGCOST_14d, 0.75, na.rm=TRUE),  

    ACTH_yearly_mean_NETPAY_14d = mean(ACTH_NETPAY_14d, na.rm=TRUE),
    ACTH_yearly_SD_NETPAY_14d = sd(ACTH_NETPAY_14d, na.rm=TRUE),
    ACTH_yearly_median_NETPAY_14d = median(ACTH_NETPAY_14d, na.rm=TRUE),
    ACTH_yearly_p25_NETPAY_14d = quantile(ACTH_NETPAY_14d, 0.25, na.rm=TRUE),
    ACTH_yearly_p75_NETPAY_14d = quantile(ACTH_NETPAY_14d, 0.75, na.rm=TRUE), 

    ACTH_yearly_mean_PAY_14d = mean(ACTH_PAY_14d, na.rm=TRUE),
    ACTH_yearly_SD_PAY_14d = sd(ACTH_PAY_14d, na.rm=TRUE),
    ACTH_yearly_median_PAY_14d = median(ACTH_PAY_14d, na.rm=TRUE),
    ACTH_yearly_p25_PAY_14d = quantile(ACTH_PAY_14d, 0.25, na.rm=TRUE),
    ACTH_yearly_p75_PAY_14d = quantile(ACTH_PAY_14d, 0.75, na.rm=TRUE)
         ) %>% 
  arrange(year_treatment) %>% 
  distinct(year_treatment, .keep_all=TRUE) %>% 
  select(year_treatment, number_patients, ACTH_yearly_mean_time_diagnosis_treatment, ACTH_yearly_SD_time_diagnosis_treatment, ACTH_yearly_median_time_diagnosis_treatment, ACTH_yearly_p25_time_diagnosis_treatment, ACTH_yearly_p75_time_diagnosis_treatment, ACTH_yearly_mean_AWP_14d, ACTH_yearly_SD_AWP_14d, ACTH_yearly_median_AWP_14d, ACTH_yearly_p25_AWP_14d, ACTH_yearly_p75_AWP_14d, ACTH_yearly_mean_COINS_14d, ACTH_yearly_SD_COINS_14d, ACTH_yearly_median_COINS_14d, ACTH_yearly_p25_COINS_14d, ACTH_yearly_p75_COINS_14d, ACTH_yearly_mean_COPAY_14d, ACTH_yearly_SD_COPAY_14d, ACTH_yearly_median_COPAY_14d, ACTH_yearly_p25_COPAY_14d, ACTH_yearly_p75_COPAY_14d, ACTH_yearly_mean_DEDUCT_14d, ACTH_yearly_SD_DEDUCT_14d, ACTH_yearly_median_DEDUCT_14d, ACTH_yearly_p25_DEDUCT_14d, ACTH_yearly_p75_DEDUCT_14d, ACTH_yearly_mean_INGCOST_14d, ACTH_yearly_SD_INGCOST_14d, ACTH_yearly_median_INGCOST_14d, ACTH_yearly_p25_INGCOST_14d, ACTH_yearly_p75_INGCOST_14d, ACTH_yearly_mean_NETPAY_14d, ACTH_yearly_SD_NETPAY_14d, ACTH_yearly_median_NETPAY_14d, ACTH_yearly_p25_NETPAY_14d, ACTH_yearly_p75_NETPAY_14d, ACTH_yearly_mean_PAY_14d, ACTH_yearly_SD_PAY_14d, ACTH_yearly_median_PAY_14d, ACTH_yearly_p25_PAY_14d, ACTH_yearly_p75_PAY_14d) %>% 
  collect()
IS_treatment_by_year_ACTH_one_medication




IS_treatment_by_year_VGB_one_medication <- inflation_adjusted_IS_treatment_VGB %>%
  filter(ENROLID %in% !!one_medication$ENROLID) %>% 
  group_by(year_treatment) %>% 
  mutate(
    number_patients = n(),
    
    VGB_yearly_mean_time_diagnosis_treatment = mean(VGB_time_diagnosis_treatment, na.rm=TRUE),
    VGB_yearly_SD_time_diagnosis_treatment = sd(VGB_time_diagnosis_treatment, na.rm=TRUE),
    VGB_yearly_median_time_diagnosis_treatment = median(VGB_time_diagnosis_treatment, na.rm=TRUE),
    VGB_yearly_p25_time_diagnosis_treatment = quantile(VGB_time_diagnosis_treatment, 0.25, na.rm=TRUE),
    VGB_yearly_p75_time_diagnosis_treatment = quantile(VGB_time_diagnosis_treatment, 0.75, na.rm=TRUE),
        
    VGB_yearly_mean_AWP_14d = mean(VGB_AWP_14d, na.rm=TRUE),
    VGB_yearly_SD_AWP_14d = sd(VGB_AWP_14d, na.rm=TRUE),
    VGB_yearly_median_AWP_14d = median(VGB_AWP_14d, na.rm=TRUE),
    VGB_yearly_p25_AWP_14d = quantile(VGB_AWP_14d, 0.25, na.rm=TRUE),
    VGB_yearly_p75_AWP_14d = quantile(VGB_AWP_14d, 0.75, na.rm=TRUE),
    
    VGB_yearly_mean_COINS_14d = mean(VGB_COINS_14d, na.rm=TRUE),
    VGB_yearly_SD_COINS_14d = sd(VGB_COINS_14d, na.rm=TRUE),
    VGB_yearly_median_COINS_14d = median(VGB_COINS_14d, na.rm=TRUE),
    VGB_yearly_p25_COINS_14d = quantile(VGB_COINS_14d, 0.25, na.rm=TRUE),
    VGB_yearly_p75_COINS_14d = quantile(VGB_COINS_14d, 0.75, na.rm=TRUE),    
    
    VGB_yearly_mean_COPAY_14d = mean(VGB_COPAY_14d, na.rm=TRUE),
    VGB_yearly_SD_COPAY_14d = sd(VGB_COPAY_14d, na.rm=TRUE),
    VGB_yearly_median_COPAY_14d = median(VGB_COPAY_14d, na.rm=TRUE),
    VGB_yearly_p25_COPAY_14d = quantile(VGB_COPAY_14d, 0.25, na.rm=TRUE),
    VGB_yearly_p75_COPAY_14d = quantile(VGB_COPAY_14d, 0.75, na.rm=TRUE),  
 
    VGB_yearly_mean_DEDUCT_14d = mean(VGB_DEDUCT_14d, na.rm=TRUE),
    VGB_yearly_SD_DEDUCT_14d = sd(VGB_DEDUCT_14d, na.rm=TRUE),
    VGB_yearly_median_DEDUCT_14d = median(VGB_DEDUCT_14d, na.rm=TRUE),
    VGB_yearly_p25_DEDUCT_14d = quantile(VGB_DEDUCT_14d, 0.25, na.rm=TRUE),
    VGB_yearly_p75_DEDUCT_14d = quantile(VGB_DEDUCT_14d, 0.75, na.rm=TRUE),  
       
    VGB_yearly_mean_INGCOST_14d = mean(VGB_INGCOST_14d, na.rm=TRUE),
    VGB_yearly_SD_INGCOST_14d = sd(VGB_INGCOST_14d, na.rm=TRUE),
    VGB_yearly_median_INGCOST_14d = median(VGB_INGCOST_14d, na.rm=TRUE),
    VGB_yearly_p25_INGCOST_14d = quantile(VGB_INGCOST_14d, 0.25, na.rm=TRUE),
    VGB_yearly_p75_INGCOST_14d = quantile(VGB_INGCOST_14d, 0.75, na.rm=TRUE),  

    VGB_yearly_mean_NETPAY_14d = mean(VGB_NETPAY_14d, na.rm=TRUE),
    VGB_yearly_SD_NETPAY_14d = sd(VGB_NETPAY_14d, na.rm=TRUE),
    VGB_yearly_median_NETPAY_14d = median(VGB_NETPAY_14d, na.rm=TRUE),
    VGB_yearly_p25_NETPAY_14d = quantile(VGB_NETPAY_14d, 0.25, na.rm=TRUE),
    VGB_yearly_p75_NETPAY_14d = quantile(VGB_NETPAY_14d, 0.75, na.rm=TRUE), 

    VGB_yearly_mean_PAY_14d = mean(VGB_PAY_14d, na.rm=TRUE),
    VGB_yearly_SD_PAY_14d = sd(VGB_PAY_14d, na.rm=TRUE),
    VGB_yearly_median_PAY_14d = median(VGB_PAY_14d, na.rm=TRUE),
    VGB_yearly_p25_PAY_14d = quantile(VGB_PAY_14d, 0.25, na.rm=TRUE),
    VGB_yearly_p75_PAY_14d = quantile(VGB_PAY_14d, 0.75, na.rm=TRUE)
         ) %>% 
  arrange(year_treatment) %>% 
  distinct(year_treatment, .keep_all=TRUE) %>% 
  select(year_treatment, number_patients, VGB_yearly_mean_time_diagnosis_treatment, VGB_yearly_SD_time_diagnosis_treatment, VGB_yearly_median_time_diagnosis_treatment, VGB_yearly_p25_time_diagnosis_treatment, VGB_yearly_p75_time_diagnosis_treatment, VGB_yearly_mean_AWP_14d, VGB_yearly_SD_AWP_14d, VGB_yearly_median_AWP_14d, VGB_yearly_p25_AWP_14d, VGB_yearly_p75_AWP_14d, VGB_yearly_mean_COINS_14d, VGB_yearly_SD_COINS_14d, VGB_yearly_median_COINS_14d, VGB_yearly_p25_COINS_14d, VGB_yearly_p75_COINS_14d, VGB_yearly_mean_COPAY_14d, VGB_yearly_SD_COPAY_14d, VGB_yearly_median_COPAY_14d, VGB_yearly_p25_COPAY_14d, VGB_yearly_p75_COPAY_14d, VGB_yearly_mean_DEDUCT_14d, VGB_yearly_SD_DEDUCT_14d, VGB_yearly_median_DEDUCT_14d, VGB_yearly_p25_DEDUCT_14d, VGB_yearly_p75_DEDUCT_14d, VGB_yearly_mean_INGCOST_14d, VGB_yearly_SD_INGCOST_14d, VGB_yearly_median_INGCOST_14d, VGB_yearly_p25_INGCOST_14d, VGB_yearly_p75_INGCOST_14d, VGB_yearly_mean_NETPAY_14d, VGB_yearly_SD_NETPAY_14d, VGB_yearly_median_NETPAY_14d, VGB_yearly_p25_NETPAY_14d, VGB_yearly_p75_NETPAY_14d, VGB_yearly_mean_PAY_14d, VGB_yearly_SD_PAY_14d, VGB_yearly_median_PAY_14d, VGB_yearly_p25_PAY_14d, VGB_yearly_p75_PAY_14d) %>% 
  collect()
IS_treatment_by_year_VGB_one_medication




IS_treatment_by_year_PRD_one_medication <- inflation_adjusted_IS_treatment_PRD %>%
  filter(ENROLID %in% !!one_medication$ENROLID) %>% 
  group_by(year_treatment) %>% 
  mutate(
    number_patients = n(),
    
    PRD_yearly_mean_time_diagnosis_treatment = mean(PRD_time_diagnosis_treatment, na.rm=TRUE),
    PRD_yearly_SD_time_diagnosis_treatment = sd(PRD_time_diagnosis_treatment, na.rm=TRUE),
    PRD_yearly_median_time_diagnosis_treatment = median(PRD_time_diagnosis_treatment, na.rm=TRUE),
    PRD_yearly_p25_time_diagnosis_treatment = quantile(PRD_time_diagnosis_treatment, 0.25, na.rm=TRUE),
    PRD_yearly_p75_time_diagnosis_treatment = quantile(PRD_time_diagnosis_treatment, 0.75, na.rm=TRUE),
        
    PRD_yearly_mean_AWP_14d = mean(PRD_AWP_14d, na.rm=TRUE),
    PRD_yearly_SD_AWP_14d = sd(PRD_AWP_14d, na.rm=TRUE),
    PRD_yearly_median_AWP_14d = median(PRD_AWP_14d, na.rm=TRUE),
    PRD_yearly_p25_AWP_14d = quantile(PRD_AWP_14d, 0.25, na.rm=TRUE),
    PRD_yearly_p75_AWP_14d = quantile(PRD_AWP_14d, 0.75, na.rm=TRUE),
    
    PRD_yearly_mean_COINS_14d = mean(PRD_COINS_14d, na.rm=TRUE),
    PRD_yearly_SD_COINS_14d = sd(PRD_COINS_14d, na.rm=TRUE),
    PRD_yearly_median_COINS_14d = median(PRD_COINS_14d, na.rm=TRUE),
    PRD_yearly_p25_COINS_14d = quantile(PRD_COINS_14d, 0.25, na.rm=TRUE),
    PRD_yearly_p75_COINS_14d = quantile(PRD_COINS_14d, 0.75, na.rm=TRUE),    
    
    PRD_yearly_mean_COPAY_14d = mean(PRD_COPAY_14d, na.rm=TRUE),
    PRD_yearly_SD_COPAY_14d = sd(PRD_COPAY_14d, na.rm=TRUE),
    PRD_yearly_median_COPAY_14d = median(PRD_COPAY_14d, na.rm=TRUE),
    PRD_yearly_p25_COPAY_14d = quantile(PRD_COPAY_14d, 0.25, na.rm=TRUE),
    PRD_yearly_p75_COPAY_14d = quantile(PRD_COPAY_14d, 0.75, na.rm=TRUE),  
 
    PRD_yearly_mean_DEDUCT_14d = mean(PRD_DEDUCT_14d, na.rm=TRUE),
    PRD_yearly_SD_DEDUCT_14d = sd(PRD_DEDUCT_14d, na.rm=TRUE),
    PRD_yearly_median_DEDUCT_14d = median(PRD_DEDUCT_14d, na.rm=TRUE),
    PRD_yearly_p25_DEDUCT_14d = quantile(PRD_DEDUCT_14d, 0.25, na.rm=TRUE),
    PRD_yearly_p75_DEDUCT_14d = quantile(PRD_DEDUCT_14d, 0.75, na.rm=TRUE),  
       
    PRD_yearly_mean_INGCOST_14d = mean(PRD_INGCOST_14d, na.rm=TRUE),
    PRD_yearly_SD_INGCOST_14d = sd(PRD_INGCOST_14d, na.rm=TRUE),
    PRD_yearly_median_INGCOST_14d = median(PRD_INGCOST_14d, na.rm=TRUE),
    PRD_yearly_p25_INGCOST_14d = quantile(PRD_INGCOST_14d, 0.25, na.rm=TRUE),
    PRD_yearly_p75_INGCOST_14d = quantile(PRD_INGCOST_14d, 0.75, na.rm=TRUE),  

    PRD_yearly_mean_NETPAY_14d = mean(PRD_NETPAY_14d, na.rm=TRUE),
    PRD_yearly_SD_NETPAY_14d = sd(PRD_NETPAY_14d, na.rm=TRUE),
    PRD_yearly_median_NETPAY_14d = median(PRD_NETPAY_14d, na.rm=TRUE),
    PRD_yearly_p25_NETPAY_14d = quantile(PRD_NETPAY_14d, 0.25, na.rm=TRUE),
    PRD_yearly_p75_NETPAY_14d = quantile(PRD_NETPAY_14d, 0.75, na.rm=TRUE), 

    PRD_yearly_mean_PAY_14d = mean(PRD_PAY_14d, na.rm=TRUE),
    PRD_yearly_SD_PAY_14d = sd(PRD_PAY_14d, na.rm=TRUE),
    PRD_yearly_median_PAY_14d = median(PRD_PAY_14d, na.rm=TRUE),
    PRD_yearly_p25_PAY_14d = quantile(PRD_PAY_14d, 0.25, na.rm=TRUE),
    PRD_yearly_p75_PAY_14d = quantile(PRD_PAY_14d, 0.75, na.rm=TRUE)
         ) %>% 
  arrange(year_treatment) %>% 
  distinct(year_treatment, .keep_all=TRUE) %>% 
  select(year_treatment, number_patients, PRD_yearly_mean_time_diagnosis_treatment, PRD_yearly_SD_time_diagnosis_treatment, PRD_yearly_median_time_diagnosis_treatment, PRD_yearly_p25_time_diagnosis_treatment, PRD_yearly_p75_time_diagnosis_treatment, PRD_yearly_mean_AWP_14d, PRD_yearly_SD_AWP_14d, PRD_yearly_median_AWP_14d, PRD_yearly_p25_AWP_14d, PRD_yearly_p75_AWP_14d, PRD_yearly_mean_COINS_14d, PRD_yearly_SD_COINS_14d, PRD_yearly_median_COINS_14d, PRD_yearly_p25_COINS_14d, PRD_yearly_p75_COINS_14d, PRD_yearly_mean_COPAY_14d, PRD_yearly_SD_COPAY_14d, PRD_yearly_median_COPAY_14d, PRD_yearly_p25_COPAY_14d, PRD_yearly_p75_COPAY_14d, PRD_yearly_mean_DEDUCT_14d, PRD_yearly_SD_DEDUCT_14d, PRD_yearly_median_DEDUCT_14d, PRD_yearly_p25_DEDUCT_14d, PRD_yearly_p75_DEDUCT_14d, PRD_yearly_mean_INGCOST_14d, PRD_yearly_SD_INGCOST_14d, PRD_yearly_median_INGCOST_14d, PRD_yearly_p25_INGCOST_14d, PRD_yearly_p75_INGCOST_14d, PRD_yearly_mean_NETPAY_14d, PRD_yearly_SD_NETPAY_14d, PRD_yearly_median_NETPAY_14d, PRD_yearly_p25_NETPAY_14d, PRD_yearly_p75_NETPAY_14d, PRD_yearly_mean_PAY_14d, PRD_yearly_SD_PAY_14d, PRD_yearly_median_PAY_14d, PRD_yearly_p25_PAY_14d, PRD_yearly_p75_PAY_14d) %>% 
  collect()
IS_treatment_by_year_PRD_one_medication




# Data on secular trends
IS_cost_evolution_one_medication <- IS_treatment_by_year_ACTH_one_medication[ , c("year_treatment", "ACTH_yearly_mean_AWP_14d", "ACTH_yearly_SD_AWP_14d", "ACTH_yearly_median_AWP_14d", "ACTH_yearly_p25_AWP_14d", "ACTH_yearly_p75_AWP_14d", "ACTH_yearly_mean_NETPAY_14d", "ACTH_yearly_SD_NETPAY_14d", "ACTH_yearly_median_NETPAY_14d", "ACTH_yearly_p25_NETPAY_14d", "ACTH_yearly_p75_NETPAY_14d")] %>%
  left_join(IS_treatment_by_year_VGB_one_medication[ , c("year_treatment", "VGB_yearly_mean_AWP_14d", "VGB_yearly_SD_AWP_14d", "VGB_yearly_median_AWP_14d", "VGB_yearly_p25_AWP_14d", "VGB_yearly_p75_AWP_14d", "VGB_yearly_mean_NETPAY_14d", "VGB_yearly_SD_NETPAY_14d", "VGB_yearly_median_NETPAY_14d", "VGB_yearly_p25_NETPAY_14d", "VGB_yearly_p75_NETPAY_14d")]) %>% 
  left_join(IS_treatment_by_year_PRD_one_medication[ , c("year_treatment", "PRD_yearly_mean_AWP_14d", "PRD_yearly_SD_AWP_14d", "PRD_yearly_median_AWP_14d", "PRD_yearly_p25_AWP_14d", "PRD_yearly_p75_AWP_14d", "PRD_yearly_mean_NETPAY_14d", "PRD_yearly_SD_NETPAY_14d", "PRD_yearly_median_NETPAY_14d", "PRD_yearly_p25_NETPAY_14d", "PRD_yearly_p75_NETPAY_14d")]) %>% 
  mutate_all(~replace_na(., 0)) %>% 
  collect()
IS_cost_evolution_one_medication


# Plot AWP
plot_IS_cost_AWP_evolution_one_medication <- ggplot(data=IS_cost_evolution_one_medication) + 
  geom_line(aes(x=year_treatment, y=ACTH_yearly_median_AWP_14d), color="#0076c0", lwd=1.75) +
  annotate("text", x=2018, y=90000, size=8, label= "ACTH", color="#0076c0") +
  geom_line(aes(x=year_treatment, y=VGB_yearly_median_AWP_14d), color="#67771a", lwd=1.75) +
  annotate("text", x=2017, y=10000, size=8, label= "VGB", color="#67771a") +
  geom_line(aes(x=year_treatment, y=PRD_yearly_median_AWP_14d), color="#a30234", lwd=1.75) + 
  annotate("text", x=2008, y=5000, size=8, label= "PRD", color="#a30234") +
  theme(text=element_text(family="Calibri"), legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2020) +
  scale_y_continuous(name="Median cost ($) per 14-day treatment") 
plot_IS_cost_AWP_evolution_one_medication


# Plot NETPAY
plot_IS_cost_NETPAY_evolution_one_medication <- ggplot(data=IS_cost_evolution_one_medication) + 
  geom_line(aes(x=year_treatment, y=ACTH_yearly_median_NETPAY_14d), color="#0076c0", lwd=1.75) +
  annotate("text", x=2018, y=75000, size=8, label= "ACTH", color="#0076c0") +
  geom_line(aes(x=year_treatment, y=VGB_yearly_median_NETPAY_14d), color="#67771a", lwd=1.75) +
  annotate("text", x=2017, y=8000, size=8, label= "VGB", color="#67771a") +
  geom_line(aes(x=year_treatment, y=PRD_yearly_median_NETPAY_14d), color="#a30234", lwd=1.75) +
  annotate("text", x=2008, y=4000, size=8, label= "PRD", color="#a30234") +
  theme(text=element_text(family="Calibri"), legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2020) +
  scale_y_continuous(name="Median cost ($) per 14-day treatment")
plot_IS_cost_NETPAY_evolution_one_medication
```




Cost of inpatient admission
```{r}
# Inpatient ACTH
IS_inpatient_ACTH_one_medication <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID) %>% 
  filter(type=="inpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(60))) %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  group_by(ENROLID) %>% 
  mutate(total_LOS=sumNA(LOS, na.rm=TRUE), total_cost=sumNA(cost, na.rm=TRUE)) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_LOS = if_else(is.na(total_LOS), 0, total_LOS)) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  filter(ENROLID %in% !!one_medication$ENROLID) %>% 
  collect()
IS_inpatient_ACTH_one_medication

# Days of admission
summary(IS_inpatient_ACTH_one_medication$total_LOS)
sd(IS_inpatient_ACTH_one_medication$total_LOS, na.rm=TRUE)

# Cost of inpatient admission
summary(IS_inpatient_ACTH_one_medication$total_cost)
sd(IS_inpatient_ACTH_one_medication$total_cost, na.rm=TRUE)




# Inpatient VGB
IS_inpatient_VGB_one_medication <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID) %>% 
  filter(type=="inpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(60))) %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  group_by(ENROLID) %>% 
  mutate(total_LOS=sumNA(LOS, na.rm=TRUE), total_cost=sumNA(cost, na.rm=TRUE)) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_LOS = if_else(is.na(total_LOS), 0, total_LOS)) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  filter(ENROLID %in% !!one_medication$ENROLID) %>% 
  collect()
IS_inpatient_VGB_one_medication

# Days of admission
summary(IS_inpatient_VGB_one_medication$total_LOS)
sd(IS_inpatient_VGB_one_medication$total_LOS, na.rm=TRUE)

# Cost of inpatient admission
summary(IS_inpatient_VGB_one_medication$total_cost)
sd(IS_inpatient_VGB_one_medication$total_cost, na.rm=TRUE)




# Inpatient PRD
IS_inpatient_PRD_one_medication <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID) %>% 
  filter(type=="inpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(60))) %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  group_by(ENROLID) %>% 
  mutate(total_LOS=sumNA(LOS, na.rm=TRUE), total_cost=sumNA(cost, na.rm=TRUE)) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_LOS = if_else(is.na(total_LOS), 0, total_LOS)) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  filter(ENROLID %in% !!one_medication$ENROLID) %>% 
  collect()
IS_inpatient_PRD_one_medication

# Days of admission
summary(IS_inpatient_PRD_one_medication$total_LOS)
sd(IS_inpatient_PRD_one_medication$total_LOS, na.rm=TRUE)

# Cost of inpatient admission
summary(IS_inpatient_PRD_one_medication$total_cost)
sd(IS_inpatient_PRD_one_medication$total_cost, na.rm=TRUE)




# Kruskal-Wallis test total LOS
kruskal_total_LOS_one_medication_p_value <- kruskal.test(list(IS_inpatient_ACTH_one_medication$total_LOS, IS_inpatient_VGB_one_medication$total_LOS, IS_inpatient_PRD_one_medication$total_LOS))$p.value
kruskal_total_LOS_one_medication_p_value


# Kruskal-Wallis test cost
kruskal_total_inpatient_cost_one_medication_p_value <- kruskal.test(list(IS_inpatient_ACTH_one_medication$total_cost, IS_inpatient_VGB_one_medication$total_cost, IS_inpatient_PRD_one_medication$total_cost))$p.value
kruskal_total_inpatient_cost_one_medication_p_value
```




Number and cost of emergency department
```{r}
# Emergency ACTH
IS_emergency_ACTH_one_medication <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID) %>% 
  filter(type=="emergency") %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(60))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits) %>% 
  filter(ENROLID %in% !!one_medication$ENROLID) %>% 
  collect()
IS_emergency_ACTH_one_medication

# Number of emergency visits
summary(IS_emergency_ACTH_one_medication$total_visits)
sd(IS_emergency_ACTH_one_medication$total_visits, na.rm=TRUE)

# Cost of emergency
summary(IS_emergency_ACTH_one_medication$total_cost)
sd(IS_emergency_ACTH_one_medication$total_cost, na.rm=TRUE)




# Emergency VGB
IS_emergency_VGB_one_medication <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID) %>% 
  filter(type=="emergency") %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(60))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits) %>% 
  filter(ENROLID %in% !!one_medication$ENROLID) %>% 
  collect()
IS_emergency_VGB_one_medication

# Number of emergency visits
summary(IS_emergency_VGB_one_medication$total_visits)
sd(IS_emergency_VGB_one_medication$total_visits, na.rm=TRUE)

# Cost of emergency
summary(IS_emergency_VGB_one_medication$total_cost)
sd(IS_emergency_VGB_one_medication$total_cost, na.rm=TRUE)




# Emergency PRD
IS_emergency_PRD_one_medication <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID) %>% 
  filter(type=="emergency") %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(60))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits) %>% 
  filter(ENROLID %in% !!one_medication$ENROLID) %>% 
  collect()
IS_emergency_PRD_one_medication

# Number of emergency visits
summary(IS_emergency_PRD_one_medication$total_visits)
sd(IS_emergency_PRD_one_medication$total_visits, na.rm=TRUE)

# Cost of emergency
summary(IS_emergency_PRD_one_medication$total_cost)
sd(IS_emergency_PRD_one_medication$total_cost, na.rm=TRUE)




# Kruskal-Wallis test visits
kruskal_ED_visits_one_medication_p_value <- kruskal.test(list(IS_emergency_ACTH_one_medication$total_visits, IS_emergency_VGB_one_medication$total_visits, IS_emergency_PRD_one_medication$total_visits))$p.value
kruskal_ED_visits_one_medication_p_value

# Kruskal-Wallis test cost
kruskal_total_ED_cost_one_medication_p_value <- kruskal.test(list(IS_emergency_ACTH_one_medication$total_cost, IS_emergency_VGB_one_medication$total_cost, IS_emergency_PRD_one_medication$total_cost))$p.value
kruskal_total_ED_cost_one_medication_p_value
```




Outpatient costs
```{r}
# Outpatient ACTH
IS_outpatient_ACTH_one_medication <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID) %>% 
  filter(type=="outpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(60))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits) %>% 
  filter(ENROLID %in% !!one_medication$ENROLID) %>% 
  collect()
IS_outpatient_ACTH_one_medication

# Number of outpatient visits
summary(IS_outpatient_ACTH_one_medication$total_visits)
sd(IS_outpatient_ACTH_one_medication$total_visits, na.rm=TRUE)

# Cost of outpatient
summary(IS_outpatient_ACTH_one_medication$total_cost)
sd(IS_outpatient_ACTH_one_medication$total_cost, na.rm=TRUE)




# Outpatient VGB
IS_outpatient_VGB_one_medication <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID) %>% 
  filter(type=="outpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(60))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits) %>% 
  filter(ENROLID %in% !!one_medication$ENROLID) %>% 
  collect()
IS_outpatient_VGB_one_medication

# Number of outpatient visits
summary(IS_outpatient_VGB_one_medication$total_visits)
sd(IS_outpatient_VGB_one_medication$total_visits, na.rm=TRUE)

# Cost of outpatient
summary(IS_outpatient_VGB_one_medication$total_cost)
sd(IS_outpatient_VGB_one_medication$total_cost, na.rm=TRUE)




# Outpatient PRD
IS_outpatient_PRD_one_medication <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID) %>% 
  filter(type=="outpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(60))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits) %>% 
  filter(ENROLID %in% !!one_medication$ENROLID) %>% 
  collect()
IS_outpatient_PRD_one_medication

# Number of outpatient visits
summary(IS_outpatient_PRD_one_medication$total_visits)
sd(IS_outpatient_PRD_one_medication$total_visits, na.rm=TRUE)

# Cost of outpatient
summary(IS_outpatient_PRD_one_medication$total_cost)
sd(IS_outpatient_PRD_one_medication$total_cost, na.rm=TRUE)




# Kruskal-Wallis test visits
kruskal_total_outpatient_visits_one_medication_p_value <- kruskal.test(list(IS_outpatient_ACTH_one_medication$total_visits, IS_outpatient_VGB_one_medication$total_visits, IS_outpatient_PRD_one_medication$total_visits))$p.value
kruskal_total_outpatient_visits_one_medication_p_value

# Kruskal-Wallis test cost
kruskal_total_outpatient_cost_one_medication_p_value <- kruskal.test(list(IS_outpatient_ACTH_one_medication$total_cost, IS_outpatient_VGB_one_medication$total_cost, IS_outpatient_PRD_one_medication$total_cost))$p.value
kruskal_total_outpatient_cost_one_medication_p_value
```




Secular trends in treatment of infantile spasms
```{r}
# Data on secular trends
IS_treatment_evolution_one_medication <- IS_treatment_by_year_ACTH_one_medication[ , c("year_treatment", "number_patients")] %>%
  rename(number_patients_ACTH = number_patients) %>% 
  left_join(IS_treatment_by_year_VGB_one_medication[ , c("year_treatment", "number_patients")], by="year_treatment") %>% rename(number_patients_VGB = number_patients) %>% 
  left_join(IS_treatment_by_year_PRD_one_medication[ , c("year_treatment", "number_patients")], by="year_treatment") %>% rename(number_patients_PRD = number_patients) %>% 
  mutate_all(~replace_na(., 0)) %>% 
  mutate(
    total_treatments = number_patients_ACTH + number_patients_VGB + number_patients_PRD,
    proportion_ACTH = number_patients_ACTH / total_treatments,
    proportion_VGB = number_patients_VGB / total_treatments,
    proportion_PRD = number_patients_PRD / total_treatments
  )
IS_treatment_evolution_one_medication
  

# Jonckheere Terpstra test
jonckheere_ACTH_trend_one_medication_p_value <- JonckheereTerpstraTest(proportion_ACTH ~ year_treatment, data=IS_treatment_evolution_one_medication, alternative="decreasing")$p.value
jonckheere_ACTH_trend_one_medication_p_value

jonckheere_ACTH_trend_one_medication_p_value_no_2020 <- JonckheereTerpstraTest(proportion_ACTH ~ year_treatment, data=IS_treatment_evolution_one_medication[1:14, ], alternative="decreasing")$p.value
jonckheere_ACTH_trend_one_medication_p_value_no_2020

  
# Plot secular trends use
plot_IS_treatment_evolution_one_medication <- ggplot(data=IS_treatment_evolution_one_medication) + 
  geom_line(aes(x=year_treatment, y=proportion_ACTH), color="#0076c0", lwd=1.5) + 
  geom_line(aes(x=year_treatment, y=proportion_VGB), color="#67771a", lwd=1.5) + 
  geom_line(aes(x=year_treatment, y=proportion_PRD), color="#a30234", lwd=1.5) +   
  theme(text=element_text(family="Calibri"), legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2020) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0,1))
plot_IS_treatment_evolution_one_medication
```








## 7. Sensitivity analysis: Long-term costs: 6mo




Cost of inpatient admission 6mo
```{r}
# Inpatient ACTH
IS_inpatient_ACTH_6mo <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID) %>% 
  filter(type=="inpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(183))) %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  group_by(ENROLID) %>% 
  mutate(total_LOS=sumNA(LOS, na.rm=TRUE), total_cost=sumNA(cost, na.rm=TRUE)) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_LOS = if_else(is.na(total_LOS), 0, total_LOS)) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  collect()
IS_inpatient_ACTH_6mo

# Days of admission
summary(IS_inpatient_ACTH_6mo$total_LOS)
sd(IS_inpatient_ACTH_6mo$total_LOS, na.rm=TRUE)

# Cost of inpatient admission
summary(IS_inpatient_ACTH_6mo$total_cost)
sd(IS_inpatient_ACTH_6mo$total_cost, na.rm=TRUE)



# Inpatient VGB
IS_inpatient_VGB_6mo <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID) %>% 
  filter(type=="inpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(183))) %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  group_by(ENROLID) %>% 
  mutate(total_LOS=sumNA(LOS, na.rm=TRUE), total_cost=sumNA(cost, na.rm=TRUE)) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_LOS = if_else(is.na(total_LOS), 0, total_LOS)) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  collect()
IS_inpatient_VGB_6mo


# Days of admission
summary(IS_inpatient_VGB_6mo$total_LOS)
sd(IS_inpatient_VGB_6mo$total_LOS, na.rm=TRUE)

# Cost of inpatient admission
summary(IS_inpatient_VGB_6mo$total_cost)
sd(IS_inpatient_VGB_6mo$total_cost, na.rm=TRUE)




# Inpatient PRD
IS_inpatient_PRD_6mo <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID) %>% 
  filter(type=="inpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(183))) %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  group_by(ENROLID) %>% 
  mutate(total_LOS=sumNA(LOS, na.rm=TRUE), total_cost=sumNA(cost, na.rm=TRUE)) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_LOS = if_else(is.na(total_LOS), 0, total_LOS)) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  collect()
IS_inpatient_PRD_6mo


# Days of admission
summary(IS_inpatient_PRD_6mo$total_LOS)
sd(IS_inpatient_PRD_6mo$total_LOS, na.rm=TRUE)

# Cost of inpatient admission
summary(IS_inpatient_PRD_6mo$total_cost)
sd(IS_inpatient_PRD_6mo$total_cost, na.rm=TRUE)




# Kruskal-Wallis test total LOS
kruskal_total_LOS_p_value_6mo <- kruskal.test(list(IS_inpatient_ACTH_6mo$total_LOS, IS_inpatient_VGB_6mo$total_LOS, IS_inpatient_PRD_6mo$total_LOS))$p.value
kruskal_total_LOS_p_value_6mo

# Kruskal-Wallis test cost
kruskal_total_inpatient_cost_p_value_6mo <- kruskal.test(list(IS_inpatient_ACTH_6mo$total_cost, IS_inpatient_VGB_6mo$total_cost, IS_inpatient_PRD_6mo$total_cost))$p.value
kruskal_total_inpatient_cost_p_value_6mo
```




Number and cost of emergency department 6mo
```{r}
# Emergency ACTH
IS_emergency_ACTH_6mo <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID) %>% 
  filter(type=="emergency") %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(183))) %>%
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits, epilepsy_encounter) %>% 
  collect()
IS_emergency_ACTH_6mo

# Number of emergency visits
summary(IS_emergency_ACTH_6mo$total_visits)
sd(IS_emergency_ACTH_6mo$total_visits, na.rm=TRUE)

# Cost of emergency
summary(IS_emergency_ACTH_6mo$total_cost)
sd(IS_emergency_ACTH_6mo$total_cost, na.rm=TRUE)




# Emergency VGB
IS_emergency_VGB_6mo <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID) %>% 
  filter(type=="emergency") %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(183))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits, epilepsy_encounter) %>% 
  collect()
IS_emergency_VGB_6mo


# Number of emergency visits
summary(IS_emergency_VGB_6mo$total_visits)
sd(IS_emergency_VGB_6mo$total_visits, na.rm=TRUE)

# Cost of emergency
summary(IS_emergency_VGB_6mo$total_cost)
sd(IS_emergency_VGB_6mo$total_cost, na.rm=TRUE)




# Emergency PRD
IS_emergency_PRD_6mo <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID) %>% 
  filter(type=="emergency") %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(183))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits, epilepsy_encounter) %>% 
  collect()
IS_emergency_PRD_6mo


# Number of emergency visits
summary(IS_emergency_PRD_6mo$total_visits)
sd(IS_emergency_PRD_6mo$total_visits, na.rm=TRUE)

# Cost of emergency
summary(IS_emergency_PRD_6mo$total_cost)
sd(IS_emergency_PRD_6mo$total_cost, na.rm=TRUE)




# Kruskal-Wallis test visits
kruskal_ED_visits_p_value_6mo <- kruskal.test(list(IS_emergency_ACTH_6mo$total_visits, IS_emergency_VGB_6mo$total_visits, IS_emergency_PRD_6mo$total_visits))$p.value
kruskal_ED_visits_p_value_6mo

# Kruskal-Wallis test cost
kruskal_total_ED_cost_p_value_6mo <- kruskal.test(list(IS_emergency_ACTH_6mo$total_cost, IS_emergency_VGB_6mo$total_cost, IS_emergency_PRD_6mo$total_cost))$p.value
kruskal_total_ED_cost_p_value_6mo
```




Outpatient costs 6mo
```{r}
# Outpatient ACTH
IS_outpatient_ACTH_6mo <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID) %>% 
  filter(type=="outpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(183))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits) %>% 
  collect()
IS_outpatient_ACTH_6mo

# Number of outpatient visits
summary(IS_outpatient_ACTH_6mo$total_visits)
sd(IS_outpatient_ACTH_6mo$total_visits, na.rm=TRUE)

# Cost of outpatient
summary(IS_outpatient_ACTH_6mo$total_cost)
sd(IS_outpatient_ACTH_6mo$total_cost, na.rm=TRUE)




# Outpatient VGB
IS_outpatient_VGB_6mo <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID) %>% 
  filter(type=="outpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(183))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits) %>% 
  collect()
IS_outpatient_VGB_6mo

# Number of outpatient visits
summary(IS_outpatient_VGB_6mo$total_visits)
sd(IS_outpatient_VGB_6mo$total_visits, na.rm=TRUE)

# Cost of outpatient
summary(IS_outpatient_VGB_6mo$total_cost)
sd(IS_outpatient_VGB_6mo$total_cost, na.rm=TRUE)




# Outpatient PRD
IS_outpatient_PRD_6mo <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID) %>% 
  filter(type=="outpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(183))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits) %>% 
  collect()
IS_outpatient_PRD_6mo

# Number of outpatient visits
summary(IS_outpatient_PRD_6mo$total_visits)
sd(IS_outpatient_PRD_6mo$total_visits, na.rm=TRUE)

# Cost of outpatient
summary(IS_outpatient_PRD_6mo$total_cost)
sd(IS_outpatient_PRD_6mo$total_cost, na.rm=TRUE)




# Kruskal-Wallis test visits
kruskal_total_outpatient_visits_p_value_6mo <- kruskal.test(list(IS_outpatient_ACTH_6mo$total_visits, IS_outpatient_VGB_6mo$total_visits, IS_outpatient_PRD_6mo$total_visits))$p.value
kruskal_total_outpatient_visits_p_value_6mo

# Kruskal-Wallis test cost
kruskal_total_outpatient_cost_p_value_6mo <- kruskal.test(list(IS_outpatient_ACTH_6mo$total_cost, IS_outpatient_VGB_6mo$total_cost, IS_outpatient_PRD_6mo$total_cost))$p.value
kruskal_total_outpatient_cost_p_value_6mo
```








## 8. Sensitivity analysis: Long-term costs: 1y




Cost of inpatient admission 1y
```{r}
# Inpatient ACTH
IS_inpatient_ACTH_1y <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID) %>% 
  filter(type=="inpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(365))) %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  group_by(ENROLID) %>% 
  mutate(total_LOS=sumNA(LOS, na.rm=TRUE), total_cost=sumNA(cost, na.rm=TRUE)) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_LOS = if_else(is.na(total_LOS), 0, total_LOS)) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  collect()
IS_inpatient_ACTH_1y

# Days of admission
summary(IS_inpatient_ACTH_1y$total_LOS)
sd(IS_inpatient_ACTH_1y$total_LOS, na.rm=TRUE)

# Cost of inpatient admission
summary(IS_inpatient_ACTH_1y$total_cost)
sd(IS_inpatient_ACTH_1y$total_cost, na.rm=TRUE)



# Inpatient VGB
IS_inpatient_VGB_1y <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID) %>% 
  filter(type=="inpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(365))) %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  group_by(ENROLID) %>% 
  mutate(total_LOS=sumNA(LOS, na.rm=TRUE), total_cost=sumNA(cost, na.rm=TRUE)) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_LOS = if_else(is.na(total_LOS), 0, total_LOS)) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  collect()
IS_inpatient_VGB_1y


# Days of admission
summary(IS_inpatient_VGB_1y$total_LOS)
sd(IS_inpatient_VGB_1y$total_LOS, na.rm=TRUE)

# Cost of inpatient admission
summary(IS_inpatient_VGB_1y$total_cost)
sd(IS_inpatient_VGB_1y$total_cost, na.rm=TRUE)




# Inpatient PRD
IS_inpatient_PRD_1y <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID) %>% 
  filter(type=="inpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(365))) %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  group_by(ENROLID) %>% 
  mutate(total_LOS=sumNA(LOS, na.rm=TRUE), total_cost=sumNA(cost, na.rm=TRUE)) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_LOS = if_else(is.na(total_LOS), 0, total_LOS)) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  collect()
IS_inpatient_PRD_1y


# Days of admission
summary(IS_inpatient_PRD_1y$total_LOS)
sd(IS_inpatient_PRD_1y$total_LOS, na.rm=TRUE)

# Cost of inpatient admission
summary(IS_inpatient_PRD_1y$total_cost)
sd(IS_inpatient_PRD_1y$total_cost, na.rm=TRUE)




# Kruskal-Wallis test total LOS
kruskal_total_LOS_p_value_1y <- kruskal.test(list(IS_inpatient_ACTH_1y$total_LOS, IS_inpatient_VGB_1y$total_LOS, IS_inpatient_PRD_1y$total_LOS))$p.value
kruskal_total_LOS_p_value_1y

# Kruskal-Wallis test cost
kruskal_total_inpatient_cost_p_value_1y <- kruskal.test(list(IS_inpatient_ACTH_1y$total_cost, IS_inpatient_VGB_1y$total_cost, IS_inpatient_PRD_1y$total_cost))$p.value
kruskal_total_inpatient_cost_p_value_1y
```




Number and cost of emergency department 1y
```{r}
# Emergency ACTH
IS_emergency_ACTH_1y <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID) %>% 
  filter(type=="emergency") %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(365))) %>%
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits, epilepsy_encounter) %>% 
  collect()
IS_emergency_ACTH_1y

# Number of emergency visits
summary(IS_emergency_ACTH_1y$total_visits)
sd(IS_emergency_ACTH_1y$total_visits, na.rm=TRUE)

# Cost of emergency
summary(IS_emergency_ACTH_1y$total_cost)
sd(IS_emergency_ACTH_1y$total_cost, na.rm=TRUE)




# Emergency VGB
IS_emergency_VGB_1y <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID) %>% 
  filter(type=="emergency") %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(365))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits, epilepsy_encounter) %>% 
  collect()
IS_emergency_VGB_1y


# Number of emergency visits
summary(IS_emergency_VGB_1y$total_visits)
sd(IS_emergency_VGB_1y$total_visits, na.rm=TRUE)

# Cost of emergency
summary(IS_emergency_VGB_1y$total_cost)
sd(IS_emergency_VGB_1y$total_cost, na.rm=TRUE)




# Emergency PRD
IS_emergency_PRD_1y <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID) %>% 
  filter(type=="emergency") %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(365))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits, epilepsy_encounter) %>% 
  collect()
IS_emergency_PRD_1y


# Number of emergency visits
summary(IS_emergency_PRD_1y$total_visits)
sd(IS_emergency_PRD_1y$total_visits, na.rm=TRUE)

# Cost of emergency
summary(IS_emergency_PRD_1y$total_cost)
sd(IS_emergency_PRD_1y$total_cost, na.rm=TRUE)




# Kruskal-Wallis test visits
kruskal_ED_visits_p_value_1y <- kruskal.test(list(IS_emergency_ACTH_1y$total_visits, IS_emergency_VGB_1y$total_visits, IS_emergency_PRD_1y$total_visits))$p.value
kruskal_ED_visits_p_value_1y

# Kruskal-Wallis test cost
kruskal_total_ED_cost_p_value_1y <- kruskal.test(list(IS_emergency_ACTH_1y$total_cost, IS_emergency_VGB_1y$total_cost, IS_emergency_PRD_1y$total_cost))$p.value
kruskal_total_ED_cost_p_value_1y
```




Outpatient costs 1y
```{r}
# Outpatient ACTH
IS_outpatient_ACTH_1y <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID) %>% 
  filter(type=="outpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(365))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits) %>% 
  collect()
IS_outpatient_ACTH_1y

# Number of outpatient visits
summary(IS_outpatient_ACTH_1y$total_visits)
sd(IS_outpatient_ACTH_1y$total_visits, na.rm=TRUE)

# Cost of outpatient
summary(IS_outpatient_ACTH_1y$total_cost)
sd(IS_outpatient_ACTH_1y$total_cost, na.rm=TRUE)




# Outpatient VGB
IS_outpatient_VGB_1y <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID) %>% 
  filter(type=="outpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(365))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits) %>% 
  collect()
IS_outpatient_VGB_1y

# Number of outpatient visits
summary(IS_outpatient_VGB_1y$total_visits)
sd(IS_outpatient_VGB_1y$total_visits, na.rm=TRUE)

# Cost of outpatient
summary(IS_outpatient_VGB_1y$total_cost)
sd(IS_outpatient_VGB_1y$total_cost, na.rm=TRUE)




# Outpatient PRD
IS_outpatient_PRD_1y <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID) %>% 
  filter(type=="outpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(365))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits) %>% 
  collect()
IS_outpatient_PRD_1y

# Number of outpatient visits
summary(IS_outpatient_PRD_1y$total_visits)
sd(IS_outpatient_PRD_1y$total_visits, na.rm=TRUE)

# Cost of outpatient
summary(IS_outpatient_PRD_1y$total_cost)
sd(IS_outpatient_PRD_1y$total_cost, na.rm=TRUE)




# Kruskal-Wallis test visits
kruskal_total_outpatient_visits_p_value_1y <- kruskal.test(list(IS_outpatient_ACTH_1y$total_visits, IS_outpatient_VGB_1y$total_visits, IS_outpatient_PRD_1y$total_visits))$p.value
kruskal_total_outpatient_visits_p_value_1y

# Kruskal-Wallis test cost
kruskal_total_outpatient_cost_p_value_1y <- kruskal.test(list(IS_outpatient_ACTH_1y$total_cost, IS_outpatient_VGB_1y$total_cost, IS_outpatient_PRD_1y$total_cost))$p.value
kruskal_total_outpatient_cost_p_value_1y
```








## 9. Sensitivity analysis: Long-term costs: 2y




Cost of inpatient admission 2y
```{r}
# Inpatient ACTH
IS_inpatient_ACTH_2y <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID) %>% 
  filter(type=="inpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(730))) %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  group_by(ENROLID) %>% 
  mutate(total_LOS=sumNA(LOS, na.rm=TRUE), total_cost=sumNA(cost, na.rm=TRUE)) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_LOS = if_else(is.na(total_LOS), 0, total_LOS)) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  collect()
IS_inpatient_ACTH_2y

# Days of admission
summary(IS_inpatient_ACTH_2y$total_LOS)
sd(IS_inpatient_ACTH_2y$total_LOS, na.rm=TRUE)

# Cost of inpatient admission
summary(IS_inpatient_ACTH_2y$total_cost)
sd(IS_inpatient_ACTH_2y$total_cost, na.rm=TRUE)



# Inpatient VGB
IS_inpatient_VGB_2y <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID) %>% 
  filter(type=="inpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(730))) %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  group_by(ENROLID) %>% 
  mutate(total_LOS=sumNA(LOS, na.rm=TRUE), total_cost=sumNA(cost, na.rm=TRUE)) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_LOS = if_else(is.na(total_LOS), 0, total_LOS)) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  collect()
IS_inpatient_VGB_2y


# Days of admission
summary(IS_inpatient_VGB_2y$total_LOS)
sd(IS_inpatient_VGB_2y$total_LOS, na.rm=TRUE)

# Cost of inpatient admission
summary(IS_inpatient_VGB_2y$total_cost)
sd(IS_inpatient_VGB_2y$total_cost, na.rm=TRUE)




# Inpatient PRD
IS_inpatient_PRD_2y <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID) %>% 
  filter(type=="inpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(730))) %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  group_by(ENROLID) %>% 
  mutate(total_LOS=sumNA(LOS, na.rm=TRUE), total_cost=sumNA(cost, na.rm=TRUE)) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_LOS = if_else(is.na(total_LOS), 0, total_LOS)) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  collect()
IS_inpatient_PRD_2y


# Days of admission
summary(IS_inpatient_PRD_2y$total_LOS)
sd(IS_inpatient_PRD_2y$total_LOS, na.rm=TRUE)

# Cost of inpatient admission
summary(IS_inpatient_PRD_2y$total_cost)
sd(IS_inpatient_PRD_2y$total_cost, na.rm=TRUE)




# Kruskal-Wallis test total LOS
kruskal_total_LOS_p_value_2y <- kruskal.test(list(IS_inpatient_ACTH_2y$total_LOS, IS_inpatient_VGB_2y$total_LOS, IS_inpatient_PRD_2y$total_LOS))$p.value
kruskal_total_LOS_p_value_2y

# Kruskal-Wallis test cost
kruskal_total_inpatient_cost_p_value_2y <- kruskal.test(list(IS_inpatient_ACTH_2y$total_cost, IS_inpatient_VGB_2y$total_cost, IS_inpatient_PRD_2y$total_cost))$p.value
kruskal_total_inpatient_cost_p_value_2y
```




Number and cost of emergency department 2y
```{r}
# Emergency ACTH
IS_emergency_ACTH_2y <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID) %>% 
  filter(type=="emergency") %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(730))) %>%
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits, epilepsy_encounter) %>% 
  collect()
IS_emergency_ACTH_2y

# Number of emergency visits
summary(IS_emergency_ACTH_2y$total_visits)
sd(IS_emergency_ACTH_2y$total_visits, na.rm=TRUE)

# Cost of emergency
summary(IS_emergency_ACTH_2y$total_cost)
sd(IS_emergency_ACTH_2y$total_cost, na.rm=TRUE)




# Emergency VGB
IS_emergency_VGB_2y <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID) %>% 
  filter(type=="emergency") %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(730))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits, epilepsy_encounter) %>% 
  collect()
IS_emergency_VGB_2y


# Number of emergency visits
summary(IS_emergency_VGB_2y$total_visits)
sd(IS_emergency_VGB_2y$total_visits, na.rm=TRUE)

# Cost of emergency
summary(IS_emergency_VGB_2y$total_cost)
sd(IS_emergency_VGB_2y$total_cost, na.rm=TRUE)




# Emergency PRD
IS_emergency_PRD_2y <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID) %>% 
  filter(type=="emergency") %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(730))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits, epilepsy_encounter) %>% 
  collect()
IS_emergency_PRD_2y


# Number of emergency visits
summary(IS_emergency_PRD_2y$total_visits)
sd(IS_emergency_PRD_2y$total_visits, na.rm=TRUE)

# Cost of emergency
summary(IS_emergency_PRD_2y$total_cost)
sd(IS_emergency_PRD_2y$total_cost, na.rm=TRUE)




# Kruskal-Wallis test visits
kruskal_ED_visits_p_value_2y <- kruskal.test(list(IS_emergency_ACTH_2y$total_visits, IS_emergency_VGB_2y$total_visits, IS_emergency_PRD_2y$total_visits))$p.value
kruskal_ED_visits_p_value_2y

# Kruskal-Wallis test cost
kruskal_total_ED_cost_p_value_2y <- kruskal.test(list(IS_emergency_ACTH_2y$total_cost, IS_emergency_VGB_2y$total_cost, IS_emergency_PRD_2y$total_cost))$p.value
kruskal_total_ED_cost_p_value_2y
```




Outpatient costs 2y
```{r}
# Outpatient ACTH
IS_outpatient_ACTH_2y <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_ACTH$ENROLID) %>% 
  filter(type=="outpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(730))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_ACTH[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits) %>% 
  collect()
IS_outpatient_ACTH_2y

# Number of outpatient visits
summary(IS_outpatient_ACTH_2y$total_visits)
sd(IS_outpatient_ACTH_2y$total_visits, na.rm=TRUE)

# Cost of outpatient
summary(IS_outpatient_ACTH_2y$total_cost)
sd(IS_outpatient_ACTH_2y$total_cost, na.rm=TRUE)




# Outpatient VGB
IS_outpatient_VGB_2y <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_VGB$ENROLID) %>% 
  filter(type=="outpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(730))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_VGB[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits) %>% 
  collect()
IS_outpatient_VGB_2y

# Number of outpatient visits
summary(IS_outpatient_VGB_2y$total_visits)
sd(IS_outpatient_VGB_2y$total_visits, na.rm=TRUE)

# Cost of outpatient
summary(IS_outpatient_VGB_2y$total_cost)
sd(IS_outpatient_VGB_2y$total_cost, na.rm=TRUE)




# Outpatient PRD
IS_outpatient_PRD_2y <- IS %>% 
  filter(ENROLID %in% !!inflation_adjusted_IS_treatment_PRD$ENROLID) %>% 
  filter(type=="outpatient") %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by="ENROLID") %>% 
  filter(SVCDATE <= (first_diagnosis + days(730))) %>% 
  group_by(ENROLID) %>% 
  mutate(total_cost=sumNA(cost, na.rm=TRUE)) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(total_visits = as.double(n())) %>% 
  right_join(inflation_adjusted_IS_treatment_PRD[ , c("ENROLID", "first_diagnosis")], by=c("ENROLID", "first_diagnosis")) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(total_cost = if_else(is.na(total_cost), 0, total_cost)) %>% 
  mutate(total_visits = if_else(is.na(total_visits), 0, total_visits)) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, first_diagnosis, total_cost, total_visits) %>% 
  collect()
IS_outpatient_PRD_2y

# Number of outpatient visits
summary(IS_outpatient_PRD_2y$total_visits)
sd(IS_outpatient_PRD_2y$total_visits, na.rm=TRUE)

# Cost of outpatient
summary(IS_outpatient_PRD_2y$total_cost)
sd(IS_outpatient_PRD_2y$total_cost, na.rm=TRUE)




# Kruskal-Wallis test visits
kruskal_total_outpatient_visits_p_value_2y <- kruskal.test(list(IS_outpatient_ACTH_2y$total_visits, IS_outpatient_VGB_2y$total_visits, IS_outpatient_PRD_2y$total_visits))$p.value
kruskal_total_outpatient_visits_p_value_2y

# Kruskal-Wallis test cost
kruskal_total_outpatient_cost_p_value_2y <- kruskal.test(list(IS_outpatient_ACTH_2y$total_cost, IS_outpatient_VGB_2y$total_cost, IS_outpatient_PRD_2y$total_cost))$p.value
kruskal_total_outpatient_cost_p_value_2y
```








## 10. Adjustment for multiple comparisons




Adjustment for multiple comparisons
```{r}
# Unadjusted p-values
unadjusted_p_values <- c(kruskal_total_LOS_p_value, kruskal_total_inpatient_cost_p_value, kruskal_ED_visits_p_value, kruskal_total_ED_cost_p_value, kruskal_total_outpatient_visits_p_value, kruskal_total_outpatient_cost_p_value, jonckheere_ACTH_trend_p_value, jonckheere_ACTH_trend_p_value_no_2020, kruskal_total_LOS_one_medication_p_value, kruskal_total_inpatient_cost_one_medication_p_value, kruskal_ED_visits_one_medication_p_value, kruskal_total_ED_cost_one_medication_p_value, kruskal_total_outpatient_visits_one_medication_p_value, kruskal_total_outpatient_cost_one_medication_p_value, jonckheere_ACTH_trend_one_medication_p_value, jonckheere_ACTH_trend_one_medication_p_value_no_2020, kruskal_total_LOS_p_value_6mo, kruskal_total_inpatient_cost_p_value_6mo, kruskal_ED_visits_p_value_6mo, kruskal_total_ED_cost_p_value_6mo, kruskal_total_outpatient_visits_p_value_6mo, kruskal_total_outpatient_cost_p_value_6mo, kruskal_total_LOS_p_value_1y, kruskal_total_inpatient_cost_p_value_1y, kruskal_ED_visits_p_value_1y, kruskal_total_ED_cost_p_value_1y, kruskal_total_outpatient_visits_p_value_1y, kruskal_total_outpatient_cost_p_value_1y, kruskal_total_LOS_p_value_2y, kruskal_total_inpatient_cost_p_value_2y, kruskal_ED_visits_p_value_2y, kruskal_total_ED_cost_p_value_2y, kruskal_total_outpatient_visits_p_value_2y, kruskal_total_outpatient_cost_p_value_2y)
unadjusted_p_values


# Adjusted p-values
adjusted_p_values <- p.adjust(unadjusted_p_values, "BH") 
adjusted_p_values
```








## 11. Disconnect from the database




Disconnect from the database
```{r}
# Disconnect
dbDisconnect(MarketScan)
```

